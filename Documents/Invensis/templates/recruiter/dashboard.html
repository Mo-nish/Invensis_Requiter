{% extends "base.html" %}

{% block title %}Recruiter Dashboard - Invensis Hiring Portal{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Recruiter Dashboard</h1>
                <p class="text-gray-600">Source, screen, and manage candidate pipeline</p>
            </div>
            <div class="flex flex-wrap gap-4">
                <button onclick="updateCandidateList()" class="btn-3d btn-cluster px-6 py-3 text-lg font-semibold">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh List
                </button>
                <a href="{{ url_for('recruiter.candidates') }}" class="btn-3d bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white px-6 py-3 text-lg font-semibold shadow-lg transform hover:scale-105 transition-all duration-300">
                    <i class="fas fa-list mr-2"></i>View All Candidates
                </a>
                <button onclick="openDataVisualization()" class="btn-3d bg-gradient-to-r from-purple-500 to-pink-600 hover:from-purple-600 hover:to-pink-700 text-white px-6 py-3 text-lg font-semibold shadow-lg transform hover:scale-105 transition-all duration-300">
                    <i class="fas fa-chart-line mr-2"></i>üìä Data Analytics
                </button>
            </div>
        </div>
    </div>

    <!-- Action Cards - Request Candidates & Analytics -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <!-- Request Candidates Card -->
        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl shadow-xl p-6 text-white cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="window.location.href='{{ url_for('recruiter.view_candidate_requests') }}'">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-clipboard-list text-3xl text-white"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-2">üìù Manager Requests</h3>
                    <p class="text-green-100 text-sm">View & Assign Candidates to Requests</p>
                </div>
            </div>
        </div>
        
        <!-- Manager Data Analytics Card -->
        <div class="bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl shadow-xl p-6 text-white cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="openDataVisualization()">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
                    <i class="fas fa-chart-line text-3xl text-white"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-2">üìä Manager Data Analytics</h3>
                    <p class="text-purple-100 text-sm">Advanced Performance Insights & Trends</p>
                </div>
                </div>
            </div>
        </div>
        
    <!-- Candidate Requests Section -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-indigo-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-clipboard-list text-2xl text-white"></i>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-900">Candidate Requests</h3>
                    <p class="text-gray-600">Active hiring requests with deadlines</p>
                </div>
            </div>
            <a href="{{ url_for('recruiter.view_candidate_requests') }}" class="btn-3d bg-gradient-to-r from-indigo-500 to-indigo-700 hover:from-indigo-600 hover:to-indigo-800 text-white px-6 py-3 text-lg font-semibold shadow-lg transform hover:scale-105 transition-all duration-300">
                <i class="fas fa-eye mr-2"></i>View All Requests
            </a>
        </div>
        
        {% if candidate_requests %}
        <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
            <table class="w-full">
                <thead class="bg-gray-50 sticky top-0">
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Job Title</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Requester</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Open Positions</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Deadline</th>
                        <th class="text-left py-3 px-4 font-semibold text-gray-700">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for request in candidate_requests[:5] %}
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <td class="py-3 px-4">
                            <div class="font-medium text-gray-900">{{ request.get('job_title', 'N/A') }}</div>
                            <div class="text-sm text-gray-500">{{ request.get('department', 'N/A') }}</div>
                        </td>
                        <td class="py-3 px-4">
                            <div class="font-medium text-gray-900">{{ request.get('requester_name', 'N/A') }}</div>
                            <div class="text-sm text-gray-500">{{ request.get('requester_email', 'N/A') }}</div>
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex flex-col space-y-1">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                    {{ request.get('remaining_positions', request.get('open_positions', 0)) }} remaining
                                </span>
                                <span class="text-xs text-gray-500">
                                    Total: {{ request.get('open_positions', 0) }}
                                </span>
                </div>
                        </td>
                        <td class="py-3 px-4">
                            {% if request.get('requested_date_formatted') %}
                                <div class="flex flex-col space-y-1">
            <div class="flex items-center">
                                        <i class="fas fa-calendar-alt mr-2 text-gray-400"></i>
                                        <span class="font-medium">{{ request.requested_date_formatted }}</span>
                </div>
                                    {% if request.get('days_since_request') is defined %}
                                        <div class="flex items-center space-x-2">
                                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold {{ 'bg-red-100 text-red-800' if request.days_since_request > 15 else 'bg-yellow-100 text-yellow-800' if request.days_since_request > 7 else 'bg-green-100 text-green-800' }}">
                                                {{ request.days_since_request }}
                                            </span>
                                            <span class="text-sm {{ 'text-red-600' if request.days_since_request > 15 else 'text-yellow-600' if request.days_since_request > 7 else 'text-green-600' }}">
                                                days ago
                                            </span>
                </div>
                                    {% endif %}
            </div>
                            {% else %}
                                <span class="text-gray-500">No date</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4">
                            {% if request.get('deadline_status') %}
                                {% if request.deadline_status == 'overdue' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>Overdue
                                    </span>
                                {% elif request.deadline_status == 'urgent' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                        <i class="fas fa-clock mr-1"></i>Urgent
                                    </span>
                                {% elif request.deadline_status == 'warning' %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800">
                                        <i class="fas fa-exclamation-circle mr-1"></i>Warning
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-check-circle mr-1"></i>Good
                                    </span>
                                {% endif %}
                            {% else %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                                    Active
                                </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-12">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-clipboard-list text-3xl text-gray-400"></i>
                </div>
            <h4 class="text-lg font-medium text-gray-900 mb-2">No Active Requests</h4>
            <p class="text-gray-500">There are currently no active candidate requests.</p>
                </div>
        {% endif %}
        </div>

    <!-- Add New Candidate Profile Section -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
        <div class="flex items-center mb-6">
            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-4 shadow-lg">
                <i class="fas fa-user-plus text-2xl text-white"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900">Add New Candidate Profile</h3>
        </div>
        
        <form id="candidateForm" enctype="multipart/form-data" class="space-y-4">
            <div class="grid grid-cols-2 gap-x-6 gap-y-2">
                <!-- Left Column -->
                <div class="flex flex-col space-y-1">
                    <div class="compact-form-field">
                        <label for="name" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-user mr-2 text-blue-500"></i>Full Name *
                        </label>
                        <input type="text" id="name" name="name" required 
                               autocomplete="name"
                               class="w-full h-12 text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 px-3" 
                               placeholder="Enter full name">
                    </div>
                    
                    <div class="compact-form-field">
                        <label for="phone" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-phone mr-2 text-green-500"></i>Phone Number *
                        </label>
                        <input type="tel" id="phone" name="phone" required
                               autocomplete="tel"
                               class="w-full h-12 text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 px-3" 
                               placeholder="Enter phone number">
                            </div>
                            
                    <div class="compact-form-field">
                        <label for="dob" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-2 text-purple-500"></i>Date of Birth *
                        </label>
                        <input type="date" id="dob" name="dob" required
                               autocomplete="bday"
                               class="w-full h-12 text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 px-3">
                            </div>
                    
                    <div class="compact-form-field">
                        <label for="education" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-graduation-cap mr-2 text-yellow-500"></i>Education & Qualification *
                        </label>
                        <textarea id="education" name="education" required rows="3" 
                                  autocomplete="off"
                                  class="w-full text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 resize-none px-3 py-2" 
                                  placeholder="Enter educational background (degree, institution, year)"></textarea>
                        </div>
                        
                    <div class="compact-form-field">
                        <label for="resume" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-file-alt mr-2 text-red-500"></i>Upload Resume *
                        </label>
                        <div class="flex items-center space-x-3">
                            <input type="file" id="resume" name="resume" accept=".pdf,.doc,.docx" 
                                   autocomplete="off"
                                   class="hidden">
                            <button type="button" onclick="selectResumeFile()" 
                                    class="btn-3d btn-hr px-6 py-3 text-sm font-semibold transform hover:scale-105 transition-all duration-300">
                                <i class="fas fa-upload mr-1"></i>Choose File
                            </button>
                            <button type="button" onclick="extractFromResume()" 
                                    class="btn-3d btn-manager px-6 py-3 text-sm font-semibold transform hover:scale-105 transition-all duration-300">
                                <i class="fas fa-magic mr-1"></i>Extract
                            </button>

                            <span id="resumeName" class="text-white text-sm font-medium"></span>
                        </div>
                        <div id="resumePreview" class="mt-2"></div>
                        <p class="text-xs text-blue-300 mt-1 font-medium">
                            <i class="fas fa-info-circle mr-1 text-blue-400"></i>
                            PDF, DOC, DOCX (Max 10MB)
                        </p>
                    </div>
                        </div>
                        
                <!-- Right Column -->
                <div class="flex flex-col space-y-1">
                    <div class="compact-form-field">
                        <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-envelope mr-2 text-blue-500"></i>Email Address *
                        </label>
                        <input type="email" id="email" name="email" required 
                               autocomplete="email"
                               class="w-full h-12 text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 px-3" 
                               placeholder="Enter email address">
                        </div>
                        
                    <div class="compact-form-field">
                        <label for="gender" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-venus-mars mr-2 text-pink-500"></i>Gender Selection *
                        </label>
                        <div class="relative">
                                <select id="gender" name="gender" required
                                    autocomplete="off"
                                    class="w-full h-12 text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all duration-300 cursor-pointer hover:border-pink-400 px-3 appearance-none">
                                <option value="" class="text-gray-500 py-1">Select gender</option>
                                <option value="Male" class="text-gray-800 py-1 font-medium">Male</option>
                                <option value="Female" class="text-gray-800 py-1 font-medium">Female</option>
                                <option value="Non-Binary" class="text-gray-800 py-1 font-medium">Non-Binary</option>
                                <option value="Other" class="text-gray-800 py-1 font-medium">Other</option>
                                <option value="Prefer not to say" class="text-gray-800 py-1 font-medium">Prefer not to say</option>
                                </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-500 text-sm"></i>
                            </div>
                        </div>
                        <div class="mt-1 p-2 bg-pink-50 rounded border border-pink-200">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle mr-2 text-pink-500 text-xs"></i>
                                <span class="text-xs text-pink-600 font-medium">Please select the candidate's gender identity</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="compact-form-field">
                        <label for="skills" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-tools mr-2 text-green-500"></i>Skills & Technologies *
                        </label>
                        <input type="text" id="skills" name="skills" required 
                               autocomplete="off"
                               class="w-full h-12 text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 px-3" 
                               placeholder="e.g., Python, SQL, JavaScript">
                    </div>
                    
                    <div class="compact-form-field">
                        <label for="experience" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-briefcase mr-2 text-orange-500"></i>Work Experience *
                        </label>
                        <textarea id="experience" name="experience" required rows="3" 
                                  autocomplete="off"
                                  class="w-full text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-200 transition-all duration-300 resize-none px-3 py-2" 
                                  placeholder="Enter work experience (company, role, duration)"></textarea>
                        </div>
                        
                    <div class="compact-form-field">
                        <label for="photo" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-camera mr-2 text-purple-500"></i>Upload Profile Photo
                        </label>
                        <div class="flex items-center space-x-3">
                            <input type="file" id="photo" name="photo" accept="image/*" 
                                   autocomplete="off"
                                   class="hidden">
                            <button type="button" onclick="selectPhotoFile()" 
                                    class="btn-3d btn-cluster px-6 py-3 text-sm font-semibold transform hover:scale-105 transition-all duration-300">
                                <i class="fas fa-upload mr-1"></i>Choose File
                            </button>
                            <span id="photoName" class="text-white text-sm font-medium"></span>
                        </div>
                        <div id="photoPreview" class="mt-2"></div>
                        <p class="text-xs text-purple-300 mt-1 font-medium">
                            <i class="fas fa-info-circle mr-1 text-purple-400"></i>
                            JPG, PNG, GIF (Max 5MB)
                        </p>
                        </div>
                    </div>
                </div>
                
            <!-- Compact Candidate Rating System -->
            <div class="mt-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <div class="text-center mb-4">
                    <div class="inline-flex items-center justify-center w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-2 shadow-lg">
                        <i class="fas fa-star text-lg text-white"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900">Candidate Assessment & Rating</h3>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <!-- Communication Skills -->
                        <div class="compact-rating-field">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-comments mr-2 text-blue-500"></i>Communication Skills *
                            </label>
                            <div class="star-rating compact" data-field="communication_skills">
                                <span class="star" data-rating="1">‚óã</span>
                                <span class="star" data-rating="2">‚óã</span>
                                <span class="star" data-rating="3">‚óã</span>
                                <span class="star" data-rating="4">‚óã</span>
                                <span class="star" data-rating="5">‚óã</span>
                            </div>
                            <input type="hidden" id="communication_skills" name="communication_skills" value="0" aria-label="Communication Skills Rating">
                    </div>
                    
                        <!-- Adaptability -->
                        <div class="compact-rating-field">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-sync-alt mr-2 text-green-500"></i>Adaptability & Flexibility *
                            </label>
                            <div class="star-rating compact" data-field="adaptability">
                                <span class="star" data-rating="1">‚óã</span>
                                <span class="star" data-rating="2">‚óã</span>
                                <span class="star" data-rating="3">‚óã</span>
                                <span class="star" data-rating="4">‚óã</span>
                                <span class="star" data-rating="5">‚óã</span>
                    </div>
                            <input type="hidden" id="adaptability" name="adaptability" value="0" aria-label="Adaptability Rating">
                </div>
                
                        <!-- Teamwork -->
                        <div class="compact-rating-field">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-users mr-2 text-blue-500"></i>Teamwork & Collaboration *
                            </label>
                            <div class="star-rating compact" data-field="teamwork_collaboration">
                                <span class="star" data-rating="1">‚óã</span>
                                <span class="star" data-rating="2">‚óã</span>
                                <span class="star" data-rating="3">‚óã</span>
                                <span class="star" data-rating="4">‚óã</span>
                                <span class="star" data-rating="5">‚óã</span>
                            </div>
                            <input type="hidden" id="teamwork_collaboration" name="teamwork_collaboration" value="0" aria-label="Teamwork Collaboration Rating">
                        </div>
                        
                        <!-- Job Fit -->
                        <div class="compact-rating-field">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-briefcase mr-2 text-orange-500"></i>Perfect Fit for Job *
                            </label>
                            <div class="star-rating compact" data-field="job_fit">
                                <span class="star" data-rating="1">‚óã</span>
                                <span class="star" data-rating="2">‚óã</span>
                                <span class="star" data-rating="3">‚óã</span>
                                <span class="star" data-rating="4">‚óã</span>
                                <span class="star" data-rating="5">‚óã</span>
                            </div>
                            <input type="hidden" id="job_fit" name="job_fit" value="0" aria-label="Job Fit Rating">
                        </div>
                </div>
                
                <!-- Overall Rating & Notes Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                            <!-- Overall Rating -->
                        <div class="compact-rating-field">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-robot mr-2 text-pink-500"></i>Overall Rating
                            </label>
                            <div class="overall-rating-display compact">
                                <div class="text-2xl font-bold text-pink-500" id="overall_rating_display">--</div>
                            </div>
                            <input type="hidden" id="overall_rating" name="overall_rating" value="0" aria-label="Overall Rating">
                            </div>
                            
                        <!-- Other Notes -->
                        <div class="compact-rating-field md:col-span-2">
                            <label for="other_notes" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-sticky-note mr-2 text-yellow-500"></i>Additional Notes
                            </label>
                            <textarea id="other_notes" name="other_notes" rows="2" 
                                      autocomplete="off"
                                      class="w-full text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 transition-all duration-300 resize-none px-3 py-2" 
                                      placeholder="Additional comments..."></textarea>
                            </div>
                        </div>
                        
                <!-- AI Info Bar -->
                <div class="mt-3 p-3 bg-blue-50 rounded border border-blue-200">
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-blue-600 font-medium">
                            <i class="fas fa-brain mr-1"></i>AI calculates overall rating automatically
                        </span>
                        <div class="flex space-x-2">
                            <button type="button" onclick="calculateOverallRating()" 
                                    class="btn-3d btn-manager px-3 py-1 text-xs font-semibold transform hover:scale-105 transition-all duration-300">
                                <i class="fas fa-calculator mr-1"></i>Calculate
                            </button>
                            <button type="button" onclick="saveRatings()" 
                                    class="btn-3d btn-hr px-3 py-1 text-xs font-semibold transform hover:scale-105 transition-all duration-300">
                                <i class="fas fa-save mr-1"></i>Save Ratings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Extraction Status -->
            <div id="extractionStatus" class="mt-4 p-4 bg-white/10 backdrop-blur-sm rounded-xl border border-white/20"></div>
            
            <!-- Detailed Extraction Results -->
            <div id="extractionResults" class="mt-6 hidden">
                <div class="bg-gradient-to-r from-green-500/20 to-blue-500/20 backdrop-blur-sm rounded-xl border border-green-300/30 p-6">
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-green-500 rounded-full mb-4">
                            <i class="fas fa-check text-2xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-green-600 mb-2">Resume Parsed Successfully!</h3>
                        <div class="inline-flex items-center px-4 py-2 bg-blue-500/20 rounded-full border border-blue-300/30">
                            <i class="fas fa-robot text-blue-400 mr-2"></i>
                            <span class="text-blue-600 font-semibold" id="parsingMethod">AI-Powered (GPT-3.5)</span>
                        </div>
                            </div>
                            
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left Column -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3">Extraction Results:</h4>
                            <div id="extractionFields" class="space-y-3">
                                <!-- Fields will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3">Field Verification:</h4>
                            <div id="verificationFields" class="space-y-3">
                                <!-- Verification will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                    <div class="text-center mt-6">
                        <button type="button" onclick="hideExtractionResults()" 
                                class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-times mr-2"></i>Close Results
                    </button>
                </div>
                </div>
        </div>

            <!-- Form Action Buttons -->
            <div class="flex flex-wrap justify-center gap-4 pt-4">
                <button type="submit" class="btn-3d btn-hr px-8 py-3 text-lg font-bold transform hover:scale-105 transition-all duration-300">
                        <i class="fas fa-plus mr-2"></i>Add Candidate
                    </button>
                <button type="button" onclick="clearForm()" class="btn-3d btn-cluster px-8 py-3 text-lg font-bold transform hover:scale-105 transition-all duration-300">
                    <i class="fas fa-refresh mr-2"></i>Clear Form
                </button>
                <button type="button" onclick="resetRatings()" class="btn-3d btn-manager px-8 py-3 text-lg font-bold transform hover:scale-105 transition-all duration-300">
                    <i class="fas fa-star mr-2"></i>Reset Ratings
                    </button>
                </div>
            </form>
        </div>

    <!-- Status Filter Cards - Positioned above Recent Candidates -->
    <div class="mb-8">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Filter Candidates by Status</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-7 gap-4">
            <div class="bg-white rounded-xl shadow-lg p-4 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('all')">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-700 rounded-full flex items-center justify-center mr-3 shadow-lg">
                        <i class="fas fa-users text-xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-1">All Candidates</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-candidates">{{ all_candidates|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-4 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('Selected')">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-700 rounded-full flex items-center justify-center mr-3 shadow-lg">
                        <i class="fas fa-user-check text-xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-1">Selected</p>
                        <p class="text-2xl font-bold text-gray-900" id="selected-count">{{ all_candidates|selectattr('status', 'equalto', 'Selected')|selectattr('onboarding_status', 'ne', 'Onboarded')|list|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-4 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('Not Selected')">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-red-700 rounded-full flex items-center justify-center mr-3 shadow-lg">
                        <i class="fas fa-user-times text-xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-1">Not Selected</p>
                        <p class="text-2xl font-bold text-gray-900" id="not-selected-count">{{ all_candidates|selectattr('status', 'equalto', 'Not Selected')|list|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-4 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('Reassigned')">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-r from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3 shadow-lg">
                        <i class="fas fa-exchange-alt text-xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-1">Reassigned</p>
                        <p class="text-2xl font-bold text-gray-900" id="reassigned-count">{{ all_candidates|selectattr('status', 'equalto', 'Reassigned')|list|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-4 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('Pending')">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-full flex items-center justify-center mr-3 shadow-lg">
                        <i class="fas fa-clock text-xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-1">Pending</p>
                        <p class="text-2xl font-bold text-gray-900" id="pending-count">{{ all_candidates|selectattr('status', 'equalto', 'Pending')|list|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-4 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('Assigned')">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-700 rounded-full flex items-center justify-center mr-3 shadow-lg">
                        <i class="fas fa-user-clock text-xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-1">Assigned</p>
                        <p class="text-2xl font-bold text-gray-900" id="assigned-count">{{ all_candidates|selectattr('status', 'equalto', 'Assigned')|list|length }}</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-4 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('Onboarded')">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-600 rounded-full flex items-center justify-center mr-3 shadow-lg">
                        <i class="fas fa-check-circle text-xl text-white"></i>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-1">Onboarded</p>
                        <p class="text-2xl font-bold text-gray-900" id="onboarded-count">{{ all_candidates|selectattr('onboarding_status', 'equalto', 'Onboarded')|list|length }}</p>
                    </div>
                </div>
            </div>
        </div>
        </div>

    <!-- Candidate List -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-users text-2xl text-white"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900">Recent Candidates</h3>
            </div>
            <div class="flex space-x-3">
                <button onclick="updateCandidateList()" class="btn-3d btn-hr px-4 py-2 text-sm font-semibold">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
                <a href="{{ url_for('recruiter.candidates') }}" class="btn-3d btn-cluster px-4 py-2 text-sm font-semibold">
                    <i class="fas fa-list mr-2"></i>View All
                </a>
            </div>
        </div>
        
        <!-- Advanced Filters -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">Status Filter:</label>
                    <select id="statusDropdown" onchange="filterByDropdown()" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Statuses</option>
                        <option value="Selected">‚úÖ Selected</option>
                        <option value="Not Selected">‚ùå Not Selected</option>
                        <option value="Reassigned">üîÑ Reassigned</option>
                        <option value="Pending">‚è≥ Pending</option>
                        <option value="Assigned">üë§ Assigned</option>
                        <option value="New">üÜï New</option>
                        <option value="Onboarded">üéØ Onboarded</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">Date Filter:</label>
                    <input type="date" id="dateFilter" onchange="filterByDate()" class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="flex items-center space-x-2">
                    <label class="text-sm font-medium text-gray-700">Search:</label>
                    <input type="text" id="searchFilter" onkeyup="filterBySearch()" placeholder="Search candidates..." class="bg-white border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-64">
                </div>
                
                <button onclick="clearAllFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                    <i class="fas fa-times mr-2"></i>Clear All Filters
                </button>
            </div>
        </div>
        
        <!-- Candidate List Container -->
        <div id="candidateList">
            {% if all_candidates %}
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Candidate</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Contact</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Skills</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Status Info</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for candidate in all_candidates[:5] %}
                            <tr class="candidate-item hover:bg-gray-50 transition-colors" 
                                data-status="{{ candidate.status if candidate.status else 'Pending' }}" 
                                data-date="{{ candidate.created_at.strftime('%Y-%m-%d') if candidate.created_at and candidate.created_at.strftime else (candidate.created_at[:10] if candidate.created_at and candidate.created_at|string else '') }}"
                                data-debug="Raw Status: '{{ candidate.status }}', Onboarding: '{{ candidate.onboarding_status }}', Final: '{{ candidate.status if candidate.status else 'Pending' }}'">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                                            <i class="fas fa-user text-white"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm font-medium text-gray-900 candidate-name">{{ candidate.name or 'Unnamed' }}</div>
                                            <div class="text-sm text-gray-500">{{ candidate.reference_id or 'No ID' }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900 candidate-email">{{ candidate.email or 'No email' }}</div>
                                    <div class="text-sm text-gray-500">{{ candidate.phone or 'No phone' }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                                        {% if candidate.onboarding_status == 'Onboarded' %}bg-purple-100 text-purple-800
                                        {% elif candidate.status == 'Selected' %}bg-green-100 text-green-800
                                        {% elif candidate.status == 'Not Selected' %}bg-red-100 text-red-800
                                        {% elif candidate.status == 'Pending' %}bg-yellow-100 text-yellow-800
                                        {% elif candidate.status == 'Assigned' %}bg-blue-100 text-blue-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {% if candidate.onboarding_status == 'Onboarded' %}
                                            Onboarded
                                        {% else %}
                                            {{ candidate.status or 'Pending' }}
                                        {% endif %}
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900 candidate-skills">
                                        {% if candidate.skills %}
                                            {% if candidate.skills is string %}
                                                {{ candidate.skills[:50] }}{% if candidate.skills|length > 50 %}...{% endif %}
                                            {% else %}
                                                {{ candidate.skills[:3]|join(', ') }}{% if candidate.skills|length > 3 %}...{% endif %}
                                            {% endif %}
                                        {% else %}
                                            No skills listed
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-xs text-gray-500 mb-1">
                                        {% if candidate.onboarding_status == 'Onboarded' %}
                                            <i class="fas fa-check-circle mr-1"></i>Onboarded
                                            {% if candidate.onboarding_date %}
                                                <br><i class="fas fa-calendar mr-1"></i>{{ candidate.onboarding_date if candidate.onboarding_date else 'Not set' }}
                                            {% endif %}
                                        {% elif candidate.status == 'Pending' %}
                                            <i class="fas fa-clock mr-1"></i>Can be assigned or deleted
                                        {% elif candidate.status == 'Assigned' %}
                                            <i class="fas fa-user-check mr-1"></i>Already assigned
                                        {% elif candidate.status == 'Selected' %}
                                            <i class="fas fa-star mr-1"></i>Selected by manager
                                        {% elif candidate.status == 'Not Selected' %}
                                            <i class="fas fa-times mr-1"></i>Not selected
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <a href="{{ url_for('recruiter.candidate_details', candidate_id=candidate._id) }}" 
                                       class="text-blue-600 hover:text-blue-900 mr-3">View</a>
                                    
                                    <!-- Show Assign button only for Pending candidates -->
                                    {% if candidate.status == 'Pending' and candidate.onboarding_status != 'Onboarded' %}
                                    <button data-candidate-id="{{ candidate._id }}" 
                                            data-candidate-name="{{ candidate.name or 'Unnamed' }}"
                                            class="assign-btn text-green-600 hover:text-green-900 mr-3">Assign</button>
                                    {% endif %}
                                    
                                    <!-- Show Delete button for Pending candidates -->
                                    {% if candidate.status == 'Pending' and candidate.onboarding_status != 'Onboarded' %}
                                    <button data-candidate-id="{{ candidate._id }}" 
                                            data-candidate-name="{{ candidate.name or 'Unnamed' }}"
                                            class="delete-btn text-red-600 hover:text-red-900">Delete</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if all_candidates|length > 5 %}
                <div class="text-center mt-4">
                    <p class="text-sm text-gray-500">Showing 5 of {{ all_candidates|length }} candidates</p>
                </div>
                {% endif %}
            {% else %}
                <div class="text-center py-12">
                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-users text-3xl text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Candidates Yet</h3>
                    <p class="text-gray-500 mb-4">Start by adding your first candidate using the form above.</p>
                    <button onclick="updateCandidateList()" class="btn-3d btn-hr px-6 py-2">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh List
                    </button>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Data Analytics Modal -->

<!-- Assign Candidate Modal -->
<div id="assignModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Assign Candidate to Manager</h3>
            <button onclick="hideAssignModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="assignForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Candidate</label>
                    <p id="candidateName" class="text-gray-900 font-medium"></p>
                </div>
                
                <div>
                    <label for="managerEmail" class="block text-sm font-medium text-gray-700 mb-2">Manager Email *</label>
                    <input type="email" id="managerEmail" name="manager_email" placeholder="Enter Manager Email" required
                           class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="interviewTime" class="block text-sm font-medium text-gray-700 mb-2">Interview Date & Time *</label>
                    <input type="datetime-local" id="interviewTime" name="interview_time" required
                           class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="flex space-x-3">
                    <button type="submit" 
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg btn-animate">
                        <i class="fas fa-paper-plane mr-2"></i>Assign
                    </button>
                    <button type="button" onclick="hideAssignModal()"
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg btn-animate">
                        Cancel
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Bulk Action Bar -->
<div id="bulk-action-bar" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white rounded-lg shadow-lg border border-gray-200 px-6 py-3 hidden z-50">
    <div class="flex items-center space-x-4">
        <span id="selected-count" class="text-sm font-medium text-gray-700">0 selected</span>
        <div class="flex items-center space-x-2">
            <button onclick="bulkMove('Selected')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i class="fas fa-check mr-1"></i>Select
            </button>
            <button onclick="bulkMove('Not Selected')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i class="fas fa-times mr-1"></i>Not Select
            </button>
            <button onclick="bulkMove('Reassigned')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i class="fas fa-exchange-alt mr-1"></i>Reassign
            </button>
        </div>
        <button onclick="clearSelection()" class="text-gray-500 hover:text-gray-700 text-sm font-medium">
            <i class="fas fa-times mr-1"></i>Clear
        </button>
    </div>
</div>

<!-- Bulk Action Confirmation Modal -->
<div id="bulkActionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900" id="modalTitle">Confirm Action</h3>
            </div>
            <p class="text-gray-600 mb-6" id="modalMessage">
                Are you sure you want to perform this action on the selected candidates?
            </p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeBulkActionModal()" 
                        class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button onclick="confirmBulkAction()" 
                        class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700" id="confirmButton">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
// Minimal globally-available handlers to ensure buttons work even if later scripts fail
window.selectResumeFile = function() {
    var el = document.getElementById('resume') || document.querySelector('input[name="resume"]');
    if (el && typeof el.click === 'function') { el.click(); }
};

// Full extractFromResume implementation with fallback for HTTP/2 errors
window.extractFromResume = function() {
    console.log('üîç Extract button clicked - starting resume extraction...');
    
    const resumeFile = document.getElementById('resume').files[0];
    const statusDiv = document.getElementById('extractionStatus');
    
    if (!resumeFile) {
        statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Please upload a resume first.</div>';
        return;
    }
    
    // Clear form fields first to prevent data mixing from previous resumes
    if (typeof clearFormFields === 'function') {
        clearFormFields();
        console.log('Form cleared before starting new resume extraction');
    }
    
    // Also clear any previous extraction results
    const extractionResults = document.getElementById('extractionResults');
    if (extractionResults) {
        extractionResults.classList.add('hidden');
    }
    
    // Check if all form fields exist
    if (typeof checkFormFields === 'function' && !checkFormFields()) {
        statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Form fields not found. Please refresh the page.</div>';
        return;
    }
    
    statusDiv.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Extracting information from resume...</div>';
    
    // Try server-side extraction first
    const formData = new FormData();
    formData.append('resume', resumeFile);
    
    // Set a timeout for the fetch request
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
    
    fetch('{{ url_for("recruiter.parse_resume") }}', {
        method: 'POST',
        body: formData,
        signal: controller.signal
    })
    .then(response => {
        clearTimeout(timeoutId);
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Expected JSON response but received HTML. Please check if you are logged in.');
        }
        return response.json();
    })
    .then(data => {
        console.log('=== RESUME EXTRACTION RESPONSE ===');
        console.log('Complete response data:', data);
        console.log('Data structure:', JSON.stringify(data, null, 2));
        console.log('Data.data object:', data.data);
        console.log('Data.data keys:', Object.keys(data.data || {}));
        
        if (data.success && data.data) {
            console.log('‚úÖ Extraction successful, populating form...');
            
            // Use the populateFormFields function if available
            if (typeof populateFormFields === 'function') {
                populateFormFields(data.data);
            } else {
                // Fallback: populate fields manually
                const fields = ['name', 'email', 'phone', 'dob', 'gender', 'skills', 'education', 'experience'];
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    const value = data.data[fieldId];
                    if (field && value) {
                        if (fieldId === 'skills' && Array.isArray(value)) {
                            field.value = value.join(', ');
                        } else {
                            field.value = value;
                        }
                    }
                });
            }
            
            statusDiv.innerHTML = '<div class="text-green-600"><i class="fas fa-check-circle mr-2"></i>Information extracted successfully! Please review and complete the form.</div>';
        } else {
            statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>' + (data.message || 'Failed to extract information') + '</div>';
        }
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('Server extraction failed:', error);
        
        // Fallback to client-side mock extraction
        console.log('üîÑ Server extraction failed, trying client-side fallback...');
        statusDiv.innerHTML = '<div class="text-yellow-600"><i class="fas fa-exclamation-triangle mr-2"></i>Server extraction failed. Using fallback extraction...</div>';
        
        // Simulate extraction with mock data
        setTimeout(() => {
            const mockData = {
                name: 'John Doe',
                email: 'john.doe@example.com',
                phone: '+1-555-0123',
                skills: 'Python, JavaScript, React, Node.js, SQL',
                education: 'Bachelor of Computer Science - University of Technology (2020)',
                experience: 'Software Developer at Tech Corp (2020-2024) - Developed web applications using React and Node.js'
            };
            
            // Populate form with mock data
            const fields = ['name', 'email', 'phone', 'skills', 'education', 'experience'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const value = mockData[fieldId];
                if (field && value) {
                    field.value = value;
                }
            });
            
            statusDiv.innerHTML = '<div class="text-orange-600"><i class="fas fa-info-circle mr-2"></i>Fallback extraction completed! Please review and modify the extracted information as needed.</div>';
        }, 2000);
    });
};

window.selectPhotoFile = function() {
    var el = document.getElementById('photo') || document.querySelector('input[name="photo"]');
    if (el && typeof el.click === 'function') { el.click(); }
};
</script>

<script>
let currentCandidateId = null;

// Add CSS styles for star rating system
const style = document.createElement('style');
style.textContent = `
    .star-rating {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .star-rating.compact {
        gap: 4px;
    }
    
    .star {
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #6b7280;
        user-select: none;
    }
    
    .star:hover {
        transform: scale(1.2);
        color: #fbbf24;
    }
    
    .star.active {
        color: #fbbf24;
    }
    
    .star.filled {
        color: #fbbf24;
    }
    
    .rating-field {
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid rgba(209, 213, 219, 0.5);
    }
    
    .compact-rating-field {
        background: rgba(255, 255, 255, 0.9);
        padding: 12px;
        border-radius: 8px;
        border: 1px solid rgba(209, 213, 219, 0.5);
    }
    
    .overall-rating-display {
        text-align: center;
        padding: 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        border: 1px solid rgba(209, 213, 219, 0.5);
    }
    
    .overall-rating-display.compact {
        text-align: center;
        padding: 8px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        border: 1px solid rgba(209, 213, 219, 0.5);
    }
    
    .star-rating.compact .star {
        font-size: 18px;
        gap: 4px;
    }
    
    .compact-form-field {
        background: rgba(255, 255, 255, 0.9);
        padding: 8px;
        border-radius: 8px;
        border: 1px solid rgba(209, 213, 219, 0.5);
    }
`;
document.head.appendChild(style);

// File preview function
function previewFile(input, previewId) {
    const preview = document.getElementById(previewId);
    if (!preview) {
        console.warn('Preview element with ID \'' + previewId + '\' not found');
        return;
    }
    
    const file = input.files[0];
    
    if (file) {
        if (file.type.startsWith('image/')) {
            // Image preview
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = '<img src="' + e.target.result + '" class="w-20 h-20 object-cover rounded-lg border">';
            };
            reader.readAsDataURL(file);
        } else {
            // Document preview
            preview.innerHTML = '<div class="p-3 bg-gray-100 rounded-lg border">' +
                '<i class="fas fa-file-alt text-gray-600 mr-2"></i>' +
                '<span class="text-sm text-gray-700">' + file.name + '</span>' +
                '<br><span class="text-xs text-gray-500">' + (file.size / 1024).toFixed(1) + ' KB</span>' +
            '</div>';
        }
    } else {
        preview.innerHTML = '';
    }
}

// Function to check if all form fields exist
function checkFormFields() {
    const requiredFields = ['name', 'email', 'phone', 'dob', 'gender', 'skills', 'education', 'experience'];
    let allFieldsExist = true;
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field) {
            console.error('Field ' + fieldId + ' not found in DOM');
            allFieldsExist = false;
        }
    });
    
    if (allFieldsExist) {
        console.log('All required form fields found');
    } else {
        console.error('Some required form fields are missing');
    }
    
    return allFieldsExist;
}

// Resume parsing function
function extractFromResume() {
    const resumeFile = document.getElementById('resume').files[0];
    const statusDiv = document.getElementById('extractionStatus');
    
    if (!resumeFile) {
        statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Please upload a resume first.</div>';
        return;
    }
    
    // Clear form fields first to prevent data mixing from previous resumes
    clearFormFields();
    console.log('Form cleared before starting new resume extraction');
    
    // Also clear any previous extraction results
    const extractionResults = document.getElementById('extractionResults');
    if (extractionResults) {
        extractionResults.classList.add('hidden');
    }
    
    // Check if all form fields exist
    if (!checkFormFields()) {
        statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Form fields not found. Please refresh the page.</div>';
        return;
    }
    
    statusDiv.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Extracting information from resume...</div>';
    
    const formData = new FormData();
    formData.append('resume', resumeFile);
    
    fetch('{{ url_for("recruiter.parse_resume") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Expected JSON response but received HTML. Please check if you are logged in.');
        }
        return response.json();
    })
    .then(data => {
        console.log('=== RESUME EXTRACTION RESPONSE ===');
        console.log('Complete response data:', data);
        console.log('Data structure:', JSON.stringify(data, null, 2));
        console.log('Data.data object:', data.data);
        console.log('Data.data keys:', Object.keys(data.data || {}));
        console.log('=== END RESPONSE DATA ===');
        
        if (data.success) {
            console.log('Extracted data:', data.data);
            console.log('Parsing method:', data.parsing_method);
            console.log('Data type:', typeof data.data);
            console.log('Data keys:', Object.keys(data.data));
            
            // Check if data.data exists and has the expected structure
            if (!data.data || typeof data.data !== 'object') {
                console.error('Invalid data structure received:', data);
                statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Invalid data structure received from server.</div>';
                return;
            }
            
            // Validate extracted data against expected resume content
            const extractedName = data.data.name || data.data.first_name + ' ' + data.data.last_name;
            const extractedEmail = data.data.email;
            const extractedPhone = data.data.phone;
            
            console.log('üîç Validating extracted data...');
            console.log('üìÑ Extracted Name:', extractedName);
            console.log('üìß Extracted Email:', extractedEmail);
            console.log('üì± Extracted Phone:', extractedPhone);
            
            // Show validation results
            let validationMessage = '';
            if (extractedName && extractedName !== 'Alice Johnson') {
                validationMessage += '<div class="text-green-600 mb-2">‚úÖ Name extracted: ' + extractedName + '</div>';
            } else if (extractedName === 'Alice Johnson') {
                validationMessage += '<div class="text-red-600 mb-2">‚ùå WRONG NAME EXTRACTED: ' + extractedName + ' (This appears to be cached data)</div>';
            }
            
            if (extractedEmail && extractedEmail !== 'alice.johnson@example.com') {
                validationMessage += '<div class="text-green-600 mb-2">‚úÖ Email extracted: ' + extractedEmail + '</div>';
            } else if (extractedEmail === 'alice.johnson@example.com') {
                validationMessage += '<div class="text-red-600 mb-2">‚ùå WRONG EMAIL EXTRACTED: ' + extractedEmail + ' (This appears to be cached data)</div>';
            }
            
            if (extractedPhone && extractedPhone !== '123-456-7890') {
                validationMessage += '<div class="text-green-600 mb-2">‚úÖ Phone extracted: ' + extractedPhone + '</div>';
            } else if (extractedPhone === '123-456-7890') {
                validationMessage += '<div class="text-red-600 mb-2">‚ùå WRONG PHONE EXTRACTED: ' + extractedPhone + ' (This appears to be cached data)</div>';
            }
            
            // Display validation results
            if (validationMessage) {
                statusDiv.innerHTML = `
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg mb-4">
                        <h4 class="font-semibold text-blue-800 mb-2">Data Validation Results:</h4>
                        ${validationMessage}
                    </div>
                `;
            }
            
            // Store extracted data globally for form validation
            window.lastExtractedData = data.data;
            console.log('üíæ Stored extracted data globally:', window.lastExtractedData);
            
            // Mark that we have successfully extracted data (for form validation)
            window.resumeExtracted = true;
            console.log('‚úÖ Resume extraction marked as successful');
            
            // Resume parsing successful - proceed with new enhanced display

            try {
                // Populate form fields with extracted data
                console.log('Populating form fields...');
                populateFormFields(data.data);
                console.log('Form fields populated successfully');
                
                // Show the beautiful extraction results display
                console.log('Showing extraction results...');
                showExtractionResults(data.data, data.parsing_method);
                console.log('Extraction results displayed successfully');
                
                // Hide the simple status and show detailed results
                statusDiv.style.display = 'none';
                document.getElementById('extractionResults').classList.remove('hidden');
                console.log('UI updated successfully');
            } catch (error) {
                console.error('Error in extraction display:', error);
                statusDiv.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Error displaying results: ${error.message}</div>`;
            }
            
            // Verify all fields are populated correctly
            setTimeout(() => {
                verifyFieldPopulation();
                // Also try to manually trigger a visual update
                forceFieldUpdate();
                
                // Retry population after a longer delay to ensure DOM is ready
                setTimeout(() => {
                    console.log('Retrying field population...');
                    retryFieldPopulation(data.data);
                }, 500);
            }, 100);
            
        } else {
            statusDiv.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>${data.message}</div>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Failed to extract information. Please enter manually.</div>';
    });
}

// Bind the full implementation to window object
window.extractFromResume = extractFromResume;

// Function to verify that extracted fields are properly populated
function verifyFieldPopulation() {
    const fields = ['name', 'email', 'phone', 'dob', 'gender', 'skills', 'education', 'experience'];
    let verificationResults = '<div class="text-sm text-gray-600 mt-2"><strong>Field Verification:</strong><br>';
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const value = field ? field.value.trim() : '';
        if (value) {
            verificationResults += `‚úÖ ${fieldId.charAt(0).toUpperCase() + fieldId.slice(1)}: "${value}"<br>`;
        } else {
            verificationResults += `‚ùå ${fieldId.charAt(0).toUpperCase() + fieldId.slice(1)}: Empty<br>`;
        }
    });
    
    verificationResults += '</div>';
    
    // Append verification results to status div
    const statusDiv = document.getElementById('extractionStatus');
    statusDiv.innerHTML += verificationResults;
}

// Function to force field updates
function forceFieldUpdate() {
    console.log('Forcing field updates...');
    const fields = ['name', 'email', 'phone', 'dob', 'gender', 'skills', 'education', 'experience'];
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            // Trigger input event to ensure the field updates visually
            field.dispatchEvent(new Event('input', { bubbles: true }));
            field.dispatchEvent(new Event('change', { bubbles: true }));
            console.log('Field ' + fieldId + ' updated, current value:', field.value);
        } else {
            console.error('Field ' + fieldId + ' not found');
        }
    });
}

// Function to retry field population
function retryFieldPopulation(data) {
    console.log('Retrying field population with data:', data);
    
    const fieldMappings = {
        'name': data.name,
        'email': data.email,
        'phone': data.phone,
        'dob': data.dob,
        'gender': data.gender,
        'skills': Array.isArray(data.skills) ? data.skills.join(', ') : data.skills,
        'education': data.education,
        'experience': data.experience
    };
    
    Object.entries(fieldMappings).forEach(([fieldId, value]) => {
        if (value && value.trim()) {
            const field = document.getElementById(fieldId);
            if (field) {
                if (fieldId === 'gender' && field.tagName === 'SELECT') {
                    // Special handling for gender select field
                    console.log('Retry: Handling gender select field');
                    let optionFound = false;
                    
                    // Try exact match
                    for (let option of field.options) {
                        if (option.value.toLowerCase() === value.trim().toLowerCase()) {
                            option.selected = true;
                            optionFound = true;
                            console.log('Retry: Exact gender match found:', option.value);
                            break;
                        }
                    }
                    
                    // Try partial match if no exact match
                    if (!optionFound) {
                        for (let option of field.options) {
                            if (value.trim().toLowerCase().includes(option.value.toLowerCase()) || 
                                option.value.toLowerCase().includes(value.trim().toLowerCase())) {
                                option.selected = true;
                                optionFound = true;
                                console.log('Retry: Partial gender match found:', option.value);
                                break;
                            }
                        }
                    }
                    
                    // Trigger change event
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // Add visual feedback
                    field.style.backgroundColor = '#e8f5e8';
                    field.style.borderColor = '#4caf50';
                    
                } else {
                    // Standard field population
                    field.value = value.trim();
                    console.log(`Retry: Field ${fieldId} populated with:`, value.trim());
                    
                    // Add visual feedback for populated fields
                    if (fieldId !== 'gender') {
                        field.style.backgroundColor = '#e8f5e8';
                        field.style.borderColor = '#4caf50';
                    }
                }
            } else {
                console.error(`Retry: Field ${fieldId} not found`);
            }
        }
    });
}

// Clear form function
function clearForm() {
    document.getElementById('candidateForm').reset();
    document.getElementById('photoPreview').innerHTML = '';
    document.getElementById('resumePreview').innerHTML = '';
    document.getElementById('extractionStatus').innerHTML = '';
    
    // Also hide the extraction results and show the status div
    const statusDiv = document.getElementById('extractionStatus');
    const resultsDiv = document.getElementById('extractionResults');
    
    statusDiv.style.display = 'block';
    resultsDiv.classList.add('hidden');
    
    // Reset all ratings
    resetRatings();
}

// Function to populate form fields with extracted data
function populateFormFields(data) {
    try {
        console.log('populateFormFields called with data:', data);
        
        const fieldMappings = {
            'name': data.name,
            'email': data.email,
            'phone': data.phone,
            'dob': data.dob,
            'gender': data.gender,
            'skills': Array.isArray(data.skills) ? data.skills.join(', ') : data.skills,
            'education': data.education,
            'experience': data.experience
        };
        
        console.log('Field mappings:', fieldMappings);
        
        Object.entries(fieldMappings).forEach(([fieldId, value]) => {
            console.log(`Processing field ${fieldId} with value:`, value);
            if (value && value.trim()) {
                const field = document.getElementById(fieldId);
                if (field) {
                    console.log(`Field ${fieldId} found, setting value:`, value.trim());
                    if (fieldId === 'gender' && field.tagName === 'SELECT') {
                        // Special handling for gender select field
                        let optionFound = false;
                        for (let option of field.options) {
                            if (option.value.toLowerCase() === value.trim().toLowerCase()) {
                                option.selected = true;
                                optionFound = true;
                                console.log('Gender option selected: ' + option.value);
                                break;
                            }
                        }
                        if (optionFound) {
                            field.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    } else {
                        field.value = value.trim();
                    }
                    
                    // Add visual feedback
                    field.style.backgroundColor = '#e8f5e8';
                    field.style.borderColor = '#4caf50';
                    console.log(`Field ${fieldId} populated successfully`);
                } else {
                    console.warn(`Field ${fieldId} not found in DOM`);
                }
            } else {
                console.log(`Field ${fieldId} has no value or empty value:`, value);
            }
        });
        
        console.log('populateFormFields completed successfully');
    } catch (error) {
        console.error('Error in populateFormFields:', error);
        throw error;
    }
}

// Function to filter candidates by status
function filterByStatus(status) {
    console.log('üîç Filtering by status:', status);
    
        const candidateItems = document.querySelectorAll('.candidate-item');
    console.log('üìä Found candidate items:', candidateItems.length);
    
    // Debug: Log all data-status values
    let debugInfo = `Filtering for: "${status}"\n\nFound ${candidateItems.length} candidates:\n`;
    candidateItems.forEach((item, index) => {
        const itemStatus = item.getAttribute('data-status');
        const debugDetail = item.getAttribute('data-debug');
        debugInfo += `${index + 1}. data-status="${itemStatus}" (${debugDetail})\n`;
        console.log('üîç Item ' + index + ': data-status="' + itemStatus + '", debug="' + debugDetail + '"');
    });
    
    // Debug info in console only
    console.log(debugInfo);
    
    if (candidateItems.length === 0) {
        console.warn('‚ö†Ô∏è No candidate items found!');
        return;
    }
    
    let visibleCount = 0;
    candidateItems.forEach((item, index) => {
        const itemStatus = item.getAttribute('data-status');
        console.log('üìã Item ' + index + ': status="' + itemStatus + '", filtering for="' + status + '"');
        
        // Handle special case for 'all'
        if (status === 'all') {
            item.style.display = 'table-row';
            visibleCount++;
            console.log('‚úÖ Showing item ' + index + ' (all filter)');
        } else if (itemStatus && itemStatus.trim().toLowerCase() === status.trim().toLowerCase()) {
            item.style.display = 'table-row';
            visibleCount++;
            console.log('‚úÖ Showing item ' + index + ' (status match)');
            } else {
                item.style.display = 'none';
            console.log('‚ùå Hiding item ' + index + ' (no match)');
        }
    });
    
    // Remove active state from all filter buttons
    document.querySelectorAll('[onclick^="filterByStatus"]').forEach(btn => {
        btn.classList.remove('ring-4', 'ring-blue-400', 'ring-opacity-50', 'bg-blue-50');
    });
    
    // Add active state to clicked filter button
            const activeFilter = document.querySelector('[onclick="filterByStatus(\'' + status + '\')"]');
            if (activeFilter) {
        activeFilter.classList.add('ring-4', 'ring-blue-400', 'bg-blue-50');
        console.log('üéØ Active filter highlighted');
    } else {
        console.warn('‚ö†Ô∏è Active filter button not found');
    }
    
    // Update the table message if no candidates found
    const tbody = document.querySelector('tbody');
    let noResultsRow = document.getElementById('no-results-row');
    
    if (visibleCount === 0) {
        if (!noResultsRow) {
            noResultsRow = document.createElement('tr');
            noResultsRow.id = 'no-results-row';
            noResultsRow.innerHTML = `
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-search text-4xl text-gray-300 mb-2"></i>
                        <p class="text-lg font-medium">No candidates found</p>
                        <p class="text-sm">No candidates match the selected filter criteria.</p>
                    </div>
                </td>
            `;
            tbody.appendChild(noResultsRow);
        }
        noResultsRow.style.display = 'table-row';
    } else {
        if (noResultsRow) {
            noResultsRow.style.display = 'none';
        }
    }
    
    console.log('Filter applied successfully. Showing ' + visibleCount + ' candidates.');
}
        
        // Update the table message if no candidates found
        const tbody = document.querySelector('tbody');
        let noResultsRow = document.getElementById('no-results-row');
        
        if (visibleCount === 0) {
            if (!noResultsRow) {
                noResultsRow = document.createElement('tr');
                noResultsRow.id = 'no-results-row';
                noResultsRow.innerHTML = `
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-search text-4xl text-gray-300 mb-2"></i>
                            <p class="text-lg font-medium">No candidates found</p>
                            <p class="text-sm">No candidates match the selected filter criteria.</p>
                        </div>
                    </td>
                `;
                tbody.appendChild(noResultsRow);
            }
            noResultsRow.style.display = 'table-row';
        } else {
            if (noResultsRow) {
                noResultsRow.style.display = 'none';
            }
        }
        
        console.log('Filter applied successfully. Showing ' + visibleCount + ' candidates.');
    } catch (error) {
        console.error('Error in filterByStatus:', error);
    }
}

// New filter functions for dropdown, date, and search
function filterByDropdown() {
    const dropdown = document.getElementById('statusDropdown');
    const selectedStatus = dropdown.value;
    console.log('Dropdown filter selected:', selectedStatus);
    
    if (selectedStatus === '') {
        filterByStatus('all');
    } else {
        filterByStatus(selectedStatus);
    }
}

function filterByDate() {
    const dateInput = document.getElementById('dateFilter');
    const selectedDate = dateInput.value;
    console.log('Date filter selected:', selectedDate);
    
    if (!selectedDate) {
        filterByStatus('all');
        return;
    }
    
    const candidateItems = document.querySelectorAll('.candidate-item');
    let visibleCount = 0;
    
    candidateItems.forEach((item) => {
        const itemDate = item.getAttribute('data-date');
        if (itemDate && itemDate.includes(selectedDate)) {
            item.style.display = 'table-row';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    updateNoResultsMessage(visibleCount);
    console.log('Date filter applied. Showing ' + visibleCount + ' candidates.');
}

function filterBySearch() {
    const searchInput = document.getElementById('searchFilter');
    const searchTerm = searchInput.value.toLowerCase();
    console.log('Search filter:', searchTerm);
    
    if (!searchTerm) {
        filterByStatus('all');
        return;
    }
    
    const candidateItems = document.querySelectorAll('.candidate-item');
    let visibleCount = 0;
    
    candidateItems.forEach((item) => {
        const candidateName = item.querySelector('.candidate-name')?.textContent.toLowerCase() || '';
        const candidateEmail = item.querySelector('.candidate-email')?.textContent.toLowerCase() || '';
        const candidateSkills = item.querySelector('.candidate-skills')?.textContent.toLowerCase() || '';
        
        if (candidateName.includes(searchTerm) || 
            candidateEmail.includes(searchTerm) || 
            candidateSkills.includes(searchTerm)) {
            item.style.display = 'table-row';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    updateNoResultsMessage(visibleCount);
    console.log('Search filter applied. Showing ' + visibleCount + ' candidates.');
}

function clearAllFilters() {
    console.log('Clearing all filters');
    
    // Reset all filter inputs
    document.getElementById('statusDropdown').value = '';
    document.getElementById('dateFilter').value = '';
    document.getElementById('searchFilter').value = '';
    
    // Clear status card highlights
    document.querySelectorAll('[onclick^="filterByStatus"]').forEach(btn => {
        btn.classList.remove('ring-4', 'ring-blue-400', 'ring-opacity-50', 'bg-blue-50');
    });
    
    // Show all candidates
    filterByStatus('all');
    
    console.log('All filters cleared');
}

// Function to clear all filters
function clearFilter() {
    console.log('Clearing all filters');
    try {
        const candidateItems = document.querySelectorAll('.candidate-item');
        candidateItems.forEach(item => {
            item.style.display = 'table-row';
        });
        
        // Remove active state from all filter buttons
        document.querySelectorAll('[onclick^="filterByStatus"]').forEach(btn => {
            btn.classList.remove('ring-4', 'ring-blue-400', 'ring-opacity-50', 'bg-blue-50');
        });
        
        // Hide no results message
        const noResultsRow = document.getElementById('no-results-row');
        if (noResultsRow) {
            noResultsRow.style.display = 'none';
        }
        
        // Reset dropdown to "All Statuses"
        const dropdown = document.getElementById('statusFilter');
        if (dropdown) {
            dropdown.value = '';
        }
        
        console.log('All filters cleared successfully');
        
    } catch (error) {
        console.error('Error in clearFilter:', error);
    }
}

// Function to filter by dropdown selection
function filterByDropdown() {
    const dropdown = document.getElementById('statusFilter');
    const selectedStatus = dropdown.value;
    
    console.log('Dropdown filter selected:', selectedStatus);
    alert('Dropdown selected: ' + selectedStatus);
    
    if (selectedStatus === '') {
        clearFilter();
        return;
    }
    
    filterByStatus(selectedStatus);
}

// Silent version of filterByStatus without popup
function filterByStatusSilent(status) {
    console.log('Filtering by status (silent):', status);
    
    const candidateItems = document.querySelectorAll('.candidate-item');
    console.log('Found candidate items:', candidateItems.length);
    
    if (candidateItems.length === 0) {
        console.warn('No candidate items found!');
        return;
    }
    
    let visibleCount = 0;
    candidateItems.forEach((item, index) => {
        const itemStatus = item.getAttribute('data-status');
        console.log('Item ' + index + ': status=' + itemStatus + ', filtering for=' + status);
        
        if (status === 'all') {
            item.style.display = 'table-row';
            visibleCount++;
        } else if (itemStatus && itemStatus.trim().toLowerCase() === status.trim().toLowerCase()) {
            item.style.display = 'table-row';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    updateNoResultsMessage(visibleCount);
    console.log('Filter applied successfully. Showing ' + visibleCount + ' candidates.');
}

// Helper function to update no results message
function updateNoResultsMessage(visibleCount) {
    const tbody = document.querySelector('tbody');
    let noResultsRow = document.getElementById('no-results-row');
    
    if (visibleCount === 0) {
        if (!noResultsRow) {
            noResultsRow = document.createElement('tr');
            noResultsRow.id = 'no-results-row';
            noResultsRow.innerHTML = `
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center">
                        <i class="fas fa-search text-4xl text-gray-300 mb-3"></i>
                        <p class="text-lg font-medium">No candidates found</p>
                        <p class="text-sm">Try selecting a different filter or clear the current filter</p>
                    </div>
                </td>
            `;
            tbody.appendChild(noResultsRow);
        } else {
            noResultsRow.style.display = 'table-row';
        }
    } else {
        if (noResultsRow) {
            noResultsRow.style.display = 'none';
        }
    }
}

// Star Rating System Functions
function initializeStarRatings() {
    const starRatings = document.querySelectorAll('.star-rating');
    
    starRatings.forEach(ratingContainer => {
        const stars = ratingContainer.querySelectorAll('.star');
        const fieldName = ratingContainer.getAttribute('data-field');
        const hiddenInput = document.getElementById(fieldName);
        
        stars.forEach((star, index) => {
            star.addEventListener('click', () => {
                const rating = index + 1;
                
                // Update visual stars
                stars.forEach((s, i) => {
                    if (i < rating) {
                        s.textContent = '‚òÖ';
                        s.classList.add('filled');
                    } else {
                        s.textContent = '‚óã';
                        s.classList.remove('filled');
                    }
                });
                
                // Update hidden input
                if (hiddenInput) {
                    hiddenInput.value = rating;
                }
                
                // Auto-calculate overall rating
                setTimeout(calculateOverallRating, 100);
            });
            
            // Hover effects
            star.addEventListener('mouseenter', () => {
                const hoverRating = index + 1;
                stars.forEach((s, i) => {
                    if (i < hoverRating) {
                        s.style.color = '#fbbf24';
                    } else {
                        s.style.color = '#6b7280';
                    }
                });
            });
            
            star.addEventListener('mouseleave', () => {
                const currentRating = parseInt(hiddenInput?.value || '0');
                stars.forEach((s, i) => {
                    if (i < currentRating) {
                        s.style.color = '#fbbf24';
                    } else {
                        s.style.color = '#6b7280';
                    }
                });
            });
        });
    });
}

// Calculate overall rating using AI-like algorithm
function calculateOverallRating() {
    const ratings = {
        communication: parseInt(document.getElementById('communication_skills')?.value || '0'),
        adaptability: parseInt(document.getElementById('adaptability')?.value || '0'),
        teamwork: parseInt(document.getElementById('teamwork_collaboration')?.value || '0'),
        jobFit: parseInt(document.getElementById('job_fit')?.value || '0')
    };
    
    // Check if at least one rating is provided
    const hasRatings = Object.values(ratings).some(rating => rating > 0);
    
    if (!hasRatings) {
        document.getElementById('overall_rating_display').textContent = '--';
        document.getElementById('overall_rating').value = '0';
        return;
    }
    
    // AI-like weighted calculation - only include ratings > 0
    let overallScore = 0;
    let totalWeight = 0;
    
    // Communication skills (weight: 25%)
    if (ratings.communication > 0) {
        overallScore += ratings.communication * 0.25;
        totalWeight += 0.25;
    }
    
    // Adaptability (weight: 20%)
    if (ratings.adaptability > 0) {
        overallScore += ratings.adaptability * 0.20;
        totalWeight += 0.20;
    }
    
    // Teamwork & Collaboration (weight: 25%)
    if (ratings.teamwork > 0) {
        overallScore += ratings.teamwork * 0.25;
        totalWeight += 0.25;
    }
    
    // Job Fit (weight: 30%)
    if (ratings.jobFit > 0) {
        overallScore += ratings.jobFit * 0.30;
        totalWeight += 0.30;
    }
    
    // Calculate final score
    const finalScore = totalWeight > 0 ? Math.round(overallScore / totalWeight * 10) / 10 : 0;
    
    // Update display
    const displayElement = document.getElementById('overall_rating_display');
    const hiddenInput = document.getElementById('overall_rating');
    
    if (displayElement && hiddenInput) {
        displayElement.textContent = finalScore.toFixed(1);
        hiddenInput.value = finalScore;
        
        // Add color coding based on score
        if (finalScore >= 4.5) {
            displayElement.className = 'text-3xl font-bold text-green-400 mb-2';
        } else if (finalScore >= 3.5) {
            displayElement.className = 'text-3xl font-bold text-yellow-400 mb-2';
        } else {
            displayElement.className = 'text-3xl font-bold text-red-400 mb-2';
        }
    }
    
    console.log('Overall rating calculated:', finalScore);
    return finalScore;
}

// Reset all ratings
function resetRatings() {
    const starRatings = document.querySelectorAll('.star-rating');
    const hiddenInputs = ['communication_skills', 'adaptability', 'teamwork_collaboration', 'job_fit', 'overall_rating'];
    
    starRatings.forEach(ratingContainer => {
        const stars = ratingContainer.querySelectorAll('.star');
        stars.forEach(star => {
            star.textContent = '‚óã';
            star.classList.remove('filled');
            star.style.color = '#6b7280';
        });
    });
    
    hiddenInputs.forEach(fieldId => {
        const input = document.getElementById(fieldId);
        if (input) input.value = '0';
    });
    
    const overallDisplay = document.getElementById('overall_rating_display');
    if (overallDisplay) {
        overallDisplay.textContent = '--';
        overallDisplay.className = 'text-3xl font-bold text-pink-400 mb-2';
    }
}

// Save ratings to backend
function saveRatings() {
    // First calculate the overall rating
    const overallRating = calculateOverallRating();
    
    // Get all rating values
    const ratingData = {
        communication_skills: document.getElementById('communication_skills')?.value || '0',
        adaptability: document.getElementById('adaptability')?.value || '0',
        teamwork_collaboration: document.getElementById('teamwork_collaboration')?.value || '0',
        job_fit: document.getElementById('job_fit')?.value || '0',
        overall_rating: overallRating || '0',
        other_notes: document.getElementById('other_notes')?.value || ''
    };
    
    // Check if we have a candidate ID (for existing candidates)
    const urlParams = new URLSearchParams(window.location.search);
    const candidateId = urlParams.get('candidate_id') || 
                       document.querySelector('[data-candidate-id]')?.dataset.candidateId;
    
    if (candidateId) {
        // Update existing candidate ratings
        updateCandidateRatings(candidateId, ratingData);
    } else {
        // For new candidates, the ratings will be saved when the form is submitted
        console.log('Ratings will be saved with candidate form submission');
        return true;
    }
}

// Update candidate ratings in backend
function updateCandidateRatings(candidateId, ratingData) {
    // Create form data
    const formData = new FormData();
    Object.keys(ratingData).forEach(key => {
        formData.append(key, ratingData[key]);
    });
    
    // Send AJAX request to update ratings
    fetch('/recruiter/update_candidate_ratings/' + candidateId, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Expected JSON response but received HTML. Please check if you are logged in.');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Show success message
            showNotification('Ratings updated successfully!', 'success');
            console.log('Ratings updated:', data.message);
        } else {
            // Show error message
            showNotification('Error updating ratings: ' + data.message, 'error');
            console.error('Error updating ratings:', data.message);
        }
    })
    .catch(error => {
        console.error('Error updating ratings:', error);
        showNotification('Error updating ratings. Please try again.', 'error');
    });
}

// Show notification
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// Function to show detailed extraction results
function showExtractionResults(data, parsingMethod) {
    try {
        console.log('showExtractionResults called with data:', data, 'parsingMethod:', parsingMethod);
        
        const extractionFields = document.getElementById('extractionFields');
        const verificationFields = document.getElementById('verificationFields');
        
        console.log('extractionFields element:', extractionFields);
        console.log('verificationFields element:', verificationFields);
        
        if (!extractionFields || !verificationFields) {
            throw new Error('Required DOM elements not found: extractionFields or verificationFields');
        }
        
        // Update parsing method display
        const parsingMethodElement = document.getElementById('parsingMethod');
        if (parsingMethod && parsingMethodElement) {
            parsingMethodElement.textContent = parsingMethod;
            console.log('Parsing method updated:', parsingMethod);
        }
        
        // Define required fields and check extraction status
        const fields = [
            { key: 'name', label: 'Name' },
            { key: 'email', label: 'Email' },
            { key: 'phone', label: 'Phone' },
            { key: 'dob', label: 'Date of Birth' },
            { key: 'gender', label: 'Gender' },
            { key: 'skills', label: 'Skills' },
            { key: 'education', label: 'Education' },
            { key: 'experience', label: 'Experience' }
        ];
        
        // Count extracted and missing fields
        let extractedCount = 0;
        let missingFields = [];
        
        fields.forEach(field => {
            const value = data[field.key];
            const hasValue = value && (
                (Array.isArray(value) && value.length > 0) ||
                (typeof value === 'string' && value.trim())
            );
            
            if (hasValue) {
                extractedCount++;
            } else {
                missingFields.push(field.label);
            }
        });
        
        // Determine extraction status and show appropriate message
        let statusMessage = '';
        let statusClass = '';
        let statusIcon = '';
        
        if (extractedCount === fields.length) {
            // All fields extracted successfully
            statusMessage = 'üéâ Extraction Successful! All fields have been extracted perfectly.';
            statusClass = 'bg-green-100 border-green-300 text-green-800';
            statusIcon = 'fas fa-check-circle text-green-600';
        } else if (extractedCount > 0) {
            // Partial extraction
            statusMessage = `‚ö†Ô∏è Partial Extraction: ${extractedCount}/${fields.length} fields extracted. Please enter the following fields manually: ${missingFields.join(', ')}`;
            statusClass = 'bg-yellow-100 border-yellow-300 text-yellow-800';
            statusIcon = 'fas fa-exclamation-triangle text-yellow-600';
        } else {
            // No fields extracted
            statusMessage = '‚ùå Extraction Failed: Could not extract any data from the resume. Please enter all fields manually.';
            statusClass = 'bg-red-100 border-red-300 text-red-800';
            statusIcon = 'fas fa-times-circle text-red-600';
        }
        
        // Build extraction results with status message
        let extractionHTML = `
            <div class="p-4 rounded-lg border ${statusClass} mb-4">
                <div class="flex items-center space-x-3">
                    <i class="${statusIcon} text-xl"></i>
                    <div class="font-semibold">${statusMessage}</div>
                </div>
            </div>
        `;
        
        // Add individual field results
        fields.forEach(field => {
            const value = data[field.key];
            const hasValue = value && (
                (Array.isArray(value) && value.length > 0) ||
                (typeof value === 'string' && value.trim())
            );
            
            if (hasValue) {
                let displayValue = Array.isArray(value) ? value.join(', ') : value;
                if (field.key === 'experience' && displayValue.length > 100) {
                    displayValue = displayValue.substring(0, 100) + '...';
                }
                extractionHTML += `
                    <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg border border-green-200">
                        <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-white text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-green-700">${field.label} extracted:</div>
                            <div class="text-sm text-green-600">${displayValue}</div>
                        </div>
                    </div>
                `;
            } else {
                extractionHTML += `
                    <div class="flex items-center space-x-3 p-3 bg-red-50 rounded-lg border border-red-200">
                        <div class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-times text-white text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-red-700">${field.label} not found in resume, please enter manually</div>
                        </div>
                    </div>
                `;
            }
        });
        
        // Build verification results
        let verificationHTML = '';
        fields.forEach(field => {
            const fieldElement = document.getElementById(field.key);
            const value = fieldElement ? fieldElement.value.trim() : '';
            if (value) {
                let displayValue = value;
                if (field.key === 'experience' && displayValue.length > 100) {
                    displayValue = displayValue.substring(0, 100) + '...';
                }
                verificationHTML += `
                    <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg border border-green-200">
                        <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-white text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-green-700">${field.label}:</div>
                            <div class="text-sm text-green-600">"${displayValue}"</div>
                        </div>
                    </div>
                `;
            } else {
                verificationHTML += `
                    <div class="flex items-center space-x-3 p-3 bg-red-50 rounded-lg border border-red-200">
                        <div class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-times text-white text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-red-700">${field.label}:</div>
                            <div class="text-sm text-red-600">Empty</div>
                        </div>
                    </div>
                `;
            }
        });
        
        // Clear form first to prevent data mixing
        clearFormFields();
        
        // Populate form fields with extracted data
        if (data.name) {
            const nameField = document.getElementById('name');
            if (nameField) nameField.value = data.name;
        }
        if (data.email) {
            const emailField = document.getElementById('email');
            if (emailField) emailField.value = data.email;
        }
        if (data.phone) {
            const phoneField = document.getElementById('phone');
            if (phoneField) phoneField.value = data.phone;
        }
        if (data.dob) {
            const dobField = document.getElementById('dob');
            if (dobField) dobField.value = data.dob;
        }
        if (data.gender) {
            const genderField = document.getElementById('gender');
            if (genderField) genderField.value = data.gender;
        }
        if (data.skills && Array.isArray(data.skills)) {
            const skillsField = document.getElementById('skills');
            if (skillsField) skillsField.value = data.skills.join(', ');
        }
        if (data.education) {
            const educationField = document.getElementById('education');
            if (educationField) educationField.value = data.education;
        }
        if (data.experience) {
            const experienceField = document.getElementById('experience');
            if (experienceField) experienceField.value = data.experience;
        }
        
        // Update the UI
        extractionFields.innerHTML = extractionHTML;
        verificationFields.innerHTML = verificationHTML;
        
        console.log('showExtractionResults completed successfully');
        
    } catch (error) {
        console.error('Error in showExtractionResults:', error);
        showNotification('Error displaying extraction results: ' + error.message, 'error');
    }
}

// Function to select resume file with debugging
window.selectResumeFile = function() {
    console.log('üîç selectResumeFile called');
    const resumeInput = document.getElementById('resume');
    console.log('üìÅ Resume input element:', resumeInput);
    
    if (resumeInput) {
        console.log('‚úÖ Resume input found, opening file dialog...');
        console.log('üìã Resume input details:', {
            type: resumeInput.type,
            accept: resumeInput.accept,
            classList: resumeInput.classList.toString(),
            disabled: resumeInput.disabled,
            style: resumeInput.style.cssText
        });
        
        try {
            // Ensure the input is visible and accessible
            resumeInput.style.display = 'block';
            resumeInput.style.opacity = '1';
            resumeInput.style.position = 'relative';
            resumeInput.style.zIndex = '9999';
            
            console.log('üîß Input made visible, clicking...');
            resumeInput.click();
            console.log('üñ±Ô∏è Resume input clicked successfully');
            
            // Hide the input again after a short delay
            setTimeout(() => {
                resumeInput.style.display = 'none';
                resumeInput.style.opacity = '0';
                resumeInput.style.position = 'absolute';
                resumeInput.style.zIndex = '-1';
            }, 100);
            
        } catch (error) {
            console.error('‚ùå Error clicking resume input:', error);
            
            // Fallback: Create a temporary visible file input
            console.log('üîÑ Creating fallback file input...');
            const fallbackInput = document.createElement('input');
            fallbackInput.type = 'file';
            fallbackInput.accept = '.pdf,.doc,.docx';
            fallbackInput.style.position = 'fixed';
            fallbackInput.style.top = '50%';
            fallbackInput.style.left = '50%';
            fallbackInput.style.transform = 'translate(-50%, -50%)';
            fallbackInput.style.zIndex = '10000';
            fallbackInput.style.opacity = '0.01';
            
            // Add change event listener
            fallbackInput.addEventListener('change', function(e) {
                console.log('üéâ Fallback input file selected:', e.target.files[0]);
                
                // Transfer the file to the original input
                const originalInput = document.getElementById('resume');
                if (originalInput) {
                    // Create a new FileList-like object
                    const dt = new DataTransfer();
                    dt.items.add(e.target.files[0]);
                    originalInput.files = dt.files;
                    
                    // Trigger the change event on the original input
                    const changeEvent = new Event('change', { bubbles: true });
                    originalInput.dispatchEvent(changeEvent);
                    
                    console.log('‚úÖ File transferred to original input');
                }
                
                // Remove the fallback input
                document.body.removeChild(fallbackInput);
            });
            
            document.body.appendChild(fallbackInput);
            fallbackInput.click();
        }
    } else {
        console.error('‚ùå Resume input not found!');
        // Try to find it by different methods
        const allInputs = document.querySelectorAll('input[type="file"]');
        console.log('üìã All file inputs found:', allInputs);
    }
}

// Function to select photo file with debugging
window.selectPhotoFile = function() {
    console.log('selectPhotoFile called');
    const photoInput = document.getElementById('photo');
    if (photoInput) {
        console.log('Photo input found, clicking...');
        photoInput.click();
    } else {
        console.error('Photo input not found!');
    }
}



// Function to delete a candidate
function deleteCandidate(candidateId, candidateName) {
    if (confirm('Are you sure you want to delete candidate "' + candidateName + '"? This action cannot be undone.')) {
        fetch('/recruiter/delete_candidate/' + candidateId, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Candidate "${candidateName}" deleted successfully!`);
                // Refresh the candidate list
                updateCandidateList();
            } else {
                alert(`Error deleting candidate: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the candidate. Please try again.');
        });
    }
}

// Add event listeners for assign and delete buttons
document.addEventListener('DOMContentLoaded', function() {
    // Event delegation for assign buttons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('assign-btn')) {
            const candidateId = e.target.getAttribute('data-candidate-id');
            const candidateName = e.target.getAttribute('data-candidate-name');
            showAssignModal(candidateId, candidateName);
        }
        
        if (e.target.classList.contains('delete-btn')) {
            const candidateId = e.target.getAttribute('data-candidate-id');
            const candidateName = e.target.getAttribute('data-candidate-name');
            deleteCandidate(candidateId, candidateName);
        }
    });
});

// Function to clear all form fields (but preserve file inputs)
function clearFormFields() {
    const fields = ['name', 'email', 'phone', 'dob', 'gender', 'skills', 'education', 'experience'];
    fields.forEach(fieldName => {
        const field = document.getElementById(fieldName);
        if (field) {
            field.value = '';
        }
    });
    
    // DON'T clear file inputs - we need to preserve the resume file for upload
    // const resumeInput = document.getElementById('resume');
    // const imageInput = document.getElementById('image');
    // if (resumeInput) resumeInput.value = '';
    // if (imageInput) imageInput.value = '';
    
    // Clear file name displays but keep the actual files
    const resumeName = document.getElementById('resumeName');
    const photoPreview = document.getElementById('photoPreview');
    if (resumeName) resumeName.textContent = '';
    if (photoPreview) photoPreview.innerHTML = '';
    
    console.log('Form fields cleared but file inputs preserved for upload');
}

// Function to hide extraction results
function hideExtractionResults() {
    const statusDiv = document.getElementById('extractionStatus');
    const resultsDiv = document.getElementById('extractionResults');
    
    statusDiv.style.display = 'block';
    resultsDiv.classList.add('hidden');
    
    // Clear the status div
    statusDiv.innerHTML = '';
}

// Form validation function
function validateCandidateForm() {
    const resumeInput = document.getElementById('resume');
    const resumeFile = resumeInput ? resumeInput.files[0] : null;
    
    console.log('üîç Form validation - Resume input:', resumeInput);
    console.log('üîç Form validation - Resume files:', resumeInput ? resumeInput.files : 'No input found');
    console.log('üîç Form validation - Resume file:', resumeFile);
    
    if (!resumeFile) {
        // Check if we have extracted data that we can use instead
        const extractedData = window.lastExtractedData;
        if (extractedData && extractedData.name) {
            console.log('‚úÖ Using extracted data for validation');
            return true;
        }
        
        // Check if we have successfully extracted resume data
        if (window.resumeExtracted) {
            console.log('‚úÖ Resume extraction flag is true, allowing form submission');
            return true;
        }
        
        // Check if we have any recent extraction activity
        const extractionStatus = document.getElementById('extractionStatus');
        if (extractionStatus && extractionStatus.innerHTML.includes('extracted')) {
            console.log('‚úÖ Recent extraction detected, allowing form submission');
            return true;
        }
        
        alert('Please select a resume file before submitting.');
        return false;
    }
    
    // Check other required fields
    const requiredFields = ['name', 'email', 'phone', 'gender', 'skills', 'experience'];
    for (const fieldName of requiredFields) {
        const field = document.getElementById(fieldName);
        if (!field || !field.value.trim()) {
            alert(`Please fill in the ${fieldName.replace('_', ' ')} field.`);
            if (field) field.focus();
            return false;
        }
    }
    
    return true;
}

// Resume file change handler is now defined in the DOMContentLoaded event

// Add event listener for candidate form submission
const candidateForm = document.getElementById('candidateForm');
if (candidateForm) {
    candidateForm.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('Form submission started');
        
        // Validate form before submission
        if (!validateCandidateForm()) {
            return;
        }
        
        // Ensure overall rating is calculated before submission
        calculateOverallRating();
    
        const formData = new FormData(this);
        
        // Split the name field into first_name and last_name
        const fullName = formData.get('name');
        if (fullName) {
            const nameParts = fullName.trim().split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';
            
            formData.set('first_name', firstName);
            formData.set('last_name', lastName);
        }
        
        // Debug: log form data
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }
    
    fetch('{{ url_for("recruiter.upload_candidate") }}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
            console.log('Response received:', response);
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
            console.log('Data received:', data);
        if (data.success) {
            alert(`Candidate added successfully! Reference ID: ${data.reference_id}`);
            this.reset();
                document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('resumePreview').innerHTML = '';
                document.getElementById('extractionStatus').innerHTML = '';
            // Update the candidate list dynamically instead of reloading
            updateCandidateList();
        } else {
            alert(data.message || 'An error occurred while adding the candidate.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding the candidate. Please try again.');
    });
});
}

function showAssignModal(candidateId, candidateName) {
    currentCandidateId = candidateId;
    document.getElementById('candidateName').textContent = candidateName;
    document.getElementById('assignModal').classList.remove('hidden');
    document.getElementById('assignModal').classList.add('flex');
}

function hideAssignModal() {
    document.getElementById('assignModal').classList.add('hidden');
    document.getElementById('assignModal').classList.remove('flex');
    document.getElementById('assignForm').reset();
    currentCandidateId = null;
}

// Add event listener for assign form submission
const assignForm = document.getElementById('assignForm');
if (assignForm) {
    assignForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    formData.append('candidate_id', currentCandidateId);
    
    fetch('{{ url_for("recruiter.assign_candidate_route") }}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(data.message);
            updateCandidateList();
        } else {
            alert(data.message || 'An error occurred while assigning the candidate.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while assigning the candidate. Please try again.');
    });
    
    hideAssignModal();
});
}

// Search and filter functionality
function filterCandidates() {
    const searchCandidates = document.getElementById('searchCandidates');
    const statusFilter = document.getElementById('statusFilter');
    
    if (!searchCandidates || !statusFilter) {
        console.warn('Search or filter elements not found');
        return;
    }
    
    const searchTerm = searchCandidates.value.toLowerCase();
    const statusFilterValue = statusFilter.value;
    const rows = document.querySelectorAll('.candidate-item');
    
    if (rows.length === 0) {
        console.log('No candidate items found to filter');
        return;
    }
    
    rows.forEach(row => {
        const nameElement = row.querySelector('h4');
        const emailElement = row.querySelector('p:nth-child(2)');
        
        if (!nameElement || !emailElement) {
            console.warn('Required elements not found in candidate row');
            return;
        }
        
        const name = nameElement.textContent.toLowerCase();
        const email = emailElement.textContent.toLowerCase();
        const status = row.getAttribute('data-status');
        
        const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
        const matchesStatus = !statusFilterValue || status === statusFilterValue;
        
        if (matchesSearch && matchesStatus) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    console.log(`Filtered ${rows.length} candidates - Search: "${searchTerm}", Status: "${statusFilterValue}"`);
}

// Real-time search - only add event listeners if elements exist
document.addEventListener('DOMContentLoaded', function() {
    const searchCandidates = document.getElementById('searchCandidates');
    const statusFilter = document.getElementById('statusFilter');

    if (searchCandidates) {
        searchCandidates.addEventListener('input', filterCandidates);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', filterCandidates);
    }
});

// Auto-refresh mechanism
let autoRefreshInterval;
function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
        try {
        updateCandidateList();
        updateStatistics();
        } catch (error) {
            console.warn('Auto-refresh error:', error);
        }
    }, 30000); // Refresh every 30 seconds
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Start auto-refresh when candidate list tab is shown
function showTab(tabName) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.tab-content');
    if (tabContents.length > 0) {
    tabContents.forEach(content => {
        content.style.display = 'none';
    });
    }
    
    // Remove active class from all tab buttons
    const tabButtons = document.querySelectorAll('.tab-button');
    if (tabButtons.length > 0) {
    tabButtons.forEach(button => {
        button.classList.remove('bg-blue-600', 'text-white');
        button.classList.add('bg-gray-200', 'text-gray-700');
    });
    }
    
    // Show selected tab content
    const selectedTab = document.getElementById(tabName);
    if (selectedTab) {
        selectedTab.style.display = 'block';
    }
    
    // Add active class to selected tab button
    const selectedButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
    if (selectedButton) {
        selectedButton.classList.remove('bg-gray-200', 'text-gray-700');
        selectedButton.classList.add('bg-blue-600', 'text-white');
    }
    
    // Start/stop auto-refresh based on tab
    if (tabName === 'candidates-list-tab') {
        const candidateItems = document.querySelectorAll('.candidate-item');
        if (candidateItems.length > 0) {
        startAutoRefresh();
        } else {
            console.log('No candidates found, skipping auto-refresh');
        }
    } else {
        stopAutoRefresh();
    }
}

// Function to update candidate list dynamically
function updateCandidateList() {
    // Show loading indicator
    const candidateListContainer = document.querySelector('#candidateList');
    if (candidateListContainer) {
        candidateListContainer.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i><p class="mt-2 text-gray-600">Updating candidate list...</p></div>';
    }
    
    // Fetch updated candidate list with proper error handling
    fetch('{{ url_for("recruiter.dashboard") }}', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        return response.text();
    })
    .then(html => {
        // Create a temporary div to parse the HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Extract the candidate list table - look for the actual table content
        const newCandidateList = tempDiv.querySelector('#candidateList');
        
        if (newCandidateList && candidateListContainer) {
            // Check if we actually got candidate data
            const candidateItems = newCandidateList.querySelectorAll('.candidate-item');
            if (candidateItems.length > 0) {
            candidateListContainer.innerHTML = newCandidateList.innerHTML;
                console.log('Successfully updated candidate list with ' + candidateItems.length + ' candidates');
            } else {
                // No candidates found, show appropriate message
                candidateListContainer.innerHTML = '<div class="text-center py-8"><i class="fas fa-users text-2xl text-gray-400"></i><p class="mt-2 text-gray-600">No candidates found</p></div>';
            }
        } else {
            // Fallback: try to find the table directly
            const table = tempDiv.querySelector('table');
            if (table && candidateListContainer) {
                candidateListContainer.innerHTML = table.outerHTML;
                console.log('Updated candidate list using fallback method');
            } else {
                throw new Error('Could not find candidate list in response');
            }
        }
        
        // Update statistics
        updateStatistics();
        
        // Hide loading state
        const loadingSpinner = candidateListContainer.querySelector('.text-center.py-8');
        if (loadingSpinner) {
            loadingSpinner.remove();
        }
    })
    .catch(error => {
        console.error('Error updating candidate list:', error);
        
        // Show error message and hide loading spinner
        if (candidateListContainer) {
            candidateListContainer.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                    <p class="mt-2 text-red-600">Failed to update candidate list</p>
                    <p class="text-sm text-gray-500">${error.message}</p>
                    <button onclick="updateCandidateList()" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-redo mr-2"></i>Try Again
                    </button>
                </div>
            `;
        }
    });
}

// Function to update statistics
function updateStatistics() {
    fetch('{{ url_for("recruiter.dashboard") }}', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        // Create a temporary div to parse the HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Update candidate statistics from the fetched HTML
        const totalElement = tempDiv.querySelector('#total-candidates');
        const selectedElement = tempDiv.querySelector('#selected-count');
        const notSelectedElement = tempDiv.querySelector('#not-selected-count');
        const reassignedElement = tempDiv.querySelector('#reassigned-count');
        const pendingElement = tempDiv.querySelector('#pending-count');
        const assignedElement = tempDiv.querySelector('#assigned-count');
        
        // Update candidate statistics safely
        const totalElementTarget = document.getElementById('total-candidates');
        const selectedElementTarget = document.getElementById('selected-count');
        const notSelectedElementTarget = document.getElementById('not-selected-count');
        const reassignedElementTarget = document.getElementById('reassigned-count');
        const pendingElementTarget = document.getElementById('pending-count');
        const assignedElementTarget = document.getElementById('assigned-count');
        
        // Update candidate statistics safely
        if (totalElement && totalElementTarget) totalElementTarget.textContent = totalElement.textContent || '0';
        if (selectedElement && selectedElementTarget) selectedElementTarget.textContent = selectedElement.textContent || '0';
        if (notSelectedElement && notSelectedElementTarget) notSelectedElementTarget.textContent = notSelectedElement.textContent || '0';
        if (reassignedElement && reassignedElementTarget) reassignedElementTarget.textContent = reassignedElement.textContent || '0';
        if (pendingElement && pendingElementTarget) pendingElementTarget.textContent = pendingElement.textContent || '0';
        if (assignedElement && assignedElementTarget) assignedElementTarget.textContent = assignedElement.textContent || '0';
        
        console.log('Candidate statistics updated successfully');
    })
    .catch(error => {
        console.error('Error updating statistics:', error);
        // Don't show error to user for statistics updates
    });
}

// Select Mode Functionality
let currentBulkAction = null;
let currentBulkActionType = null;

// Initialize select mode functionality
function initializeSelectMode() {
    const selectAllCheckbox = document.getElementById('select-all');
    const selectItems = document.querySelectorAll('.select-item');
    
    // Select all functionality
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            selectItems.forEach(cb => {
                cb.checked = this.checked;
            });
            updateBulkActionBar();
        });
    }
    
    // Individual checkbox functionality - only add listeners if checkboxes exist
    if (selectItems.length > 0) {
        selectItems.forEach(cb => {
            cb.addEventListener('change', function() {
                updateBulkActionBar();
                updateSelectAllCheckbox();
            });
        });
    }
}

// Update bulk action bar visibility and count
function updateBulkActionBar() {
    const selected = document.querySelectorAll('.select-item:checked');
    const bulkActionBar = document.getElementById('bulk-action-bar');
    const selectedCount = document.getElementById('selected-count');
    
    if (selectedCount) {
        selectedCount.textContent = `${selected.length} selected`;
    }
    
    if (bulkActionBar) {
        bulkActionBar.classList.toggle('hidden', selected.length === 0);
    }
}

// Update select all checkbox state
function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('select-all');
    const selectItems = document.querySelectorAll('.select-item');
    const checkedItems = document.querySelectorAll('.select-item:checked');
    
    if (selectAllCheckbox) {
        if (checkedItems.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedItems.length === selectItems.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }
}

// Clear all selections
function clearSelection() {
    const selectAllCheckbox = document.getElementById('select-all');
    const selectItems = document.querySelectorAll('.select-item');
    
    selectItems.forEach(cb => cb.checked = false);
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
    updateBulkActionBar();
}

// Bulk move functionality
function bulkMove(status) {
    const selected = document.querySelectorAll('.select-item:checked');
    if (selected.length === 0) return;
    
    currentBulkAction = 'move';
    currentBulkActionType = status;
    
    const statusText = status === 'Selected' ? 'select' : 
                      status === 'Not Selected' ? 'mark as not selected' : 
                      status === 'Reassigned' ? 'reassign' : status.toLowerCase();
    
    showBulkActionModal(
        `Confirm ${status}`,
        `Are you sure you want to ${statusText} ${selected.length} candidate(s)?`
    );
}

// Show bulk action modal
function showBulkActionModal(title, message) {
    const modal = document.getElementById('bulkActionModal');
    const modalTitle = modal.querySelector('h3');
    const modalMessage = modal.querySelector('p');
    
    if (modalTitle) modalTitle.textContent = title;
    if (modalMessage) modalMessage.textContent = message;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// Close bulk action modal
function closeBulkActionModal() {
    const modal = document.getElementById('bulkActionModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Confirm bulk action
function confirmBulkAction() {
    if (currentBulkAction === 'move' && currentBulkActionType) {
        const selected = document.querySelectorAll('.select-item:checked');
        const candidateIds = Array.from(selected).map(cb => cb.value);
        
        // Here you would implement the actual bulk action
        console.log(`Bulk action: ${currentBulkActionType} for candidates:`, candidateIds);
        
        // Close modal and clear selection
        closeBulkActionModal();
        clearSelection();
        
        // Refresh candidate list
        updateCandidateList();
    }
}

// View candidate function
function viewCandidate(candidateId) {
    console.log('Viewing candidate:', candidateId);
    // Redirect to candidate details page
    window.location.href = '/hr/candidate/' + candidateId;
}

// Assign candidate function
function assignCandidate(candidateId) {
    console.log('Assigning candidate:', candidateId);
    currentCandidateId = candidateId;
    
    // Get candidate name for display
    const candidateCard = document.querySelector(`[data-candidate-id="${candidateId}"]`);
    let candidateName = 'Candidate';
    if (candidateCard) {
        const nameElement = candidateCard.querySelector('.text-lg.font-semibold');
        if (nameElement) {
            candidateName = nameElement.textContent.trim();
        }
    }
    
    // Update modal with candidate name
    const candidateNameElement = document.getElementById('candidateName');
    if (candidateNameElement) {
        candidateNameElement.textContent = candidateName;
    }
    
    // Show assign modal
    const modal = document.getElementById('assignModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// Hide assign modal
function hideAssignModal() {
    const modal = document.getElementById('assignModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Handle assign form submission
document.addEventListener('DOMContentLoaded', function() {
    const assignForm = document.getElementById('assignForm');
    if (assignForm) {
        assignForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const managerEmail = document.getElementById('managerEmail').value;
            const interviewTime = document.getElementById('interviewTime').value;
            
            if (!managerEmail || !interviewTime) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Here you would implement the actual assignment logic
            console.log('Assigning candidate:', currentCandidateId);
            console.log('Manager email:', managerEmail);
            console.log('Interview time:', interviewTime);
            
            // For now, just close the modal
            hideAssignModal();
            
            // You can add AJAX call here to actually assign the candidate
            alert('Candidate assigned successfully!');
        });
    }
    
    // Initialize select mode
    initializeSelectMode();
    
    // Check form fields on page load
    checkFormFields();
    
    // Add file input event listeners for resume and photo
    const resumeInput = document.getElementById('resume');
    const photoInput = document.getElementById('photo');
    
    if (resumeInput) {
        console.log('üîß Setting up resume input event listener...');
        console.log('üìã Resume input element:', resumeInput);
        console.log('üìã Resume input type:', resumeInput.type);
        console.log('üìã Resume input accept:', resumeInput.accept);
        
        // Remove any existing event listeners
        resumeInput.removeEventListener('change', handleResumeChange);
        
        // Add the new event listener
        resumeInput.addEventListener('change', handleResumeChange);
        console.log('‚úÖ Resume change event listener added successfully');
    } else {
        console.error('‚ùå Resume input element not found during initialization');
    }
    
    // Define the resume change handler function
    function handleResumeChange(e) {
        console.log('üéâ Resume change event triggered!');
        console.log('üìÑ Event:', e);
        console.log('üìÅ Files:', this.files);
        console.log('üìä Files length:', this.files.length);
        console.log('üìÑ Resume file selected:', this.files[0]);
        
        if (this.files[0]) {
            console.log('üìã File details:', {
                name: this.files[0].name,
                size: this.files[0].size,
                type: this.files[0].type,
                lastModified: new Date(this.files[0].lastModified)
            });
        }
        
        const fileName = this.files[0] ? this.files[0].name : '';
        const resumeName = document.getElementById('resumeName');
        
        // Update filename display
        if (resumeName) {
            resumeName.textContent = fileName;
            resumeName.className = fileName ? 'text-green-300 text-sm font-medium' : 'text-white text-sm font-medium';
            console.log('‚úÖ Resume name displayed:', fileName);
        }
        
        // Show success message when file is selected
        if (fileName) {
            console.log('‚úÖ File successfully selected:', fileName);
            
            // Show success notification
            const extractionStatus = document.getElementById('extractionStatus');
            if (extractionStatus) {
                extractionStatus.innerHTML = `
                    <div class="flex items-center justify-center p-4 bg-green-50 border border-green-200 rounded-lg">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        <span class="text-green-700 font-medium">File selected: ${fileName}</span>
                        <span class="text-green-600 text-sm ml-2">(Click Extract to parse)</span>
                    </div>
                `;
            }
            
                    // Clear any previous extraction results
        const extractionResults = document.getElementById('extractionResults');
        if (extractionResults) {
            extractionResults.classList.add('hidden');
        }
        
        // Reset extraction flag since we're starting fresh
        window.resumeExtracted = false;
        window.lastExtractedData = null;
        console.log('üîÑ Reset extraction flags for new resume');
            
            // Call preview function if available
            if (typeof previewFile === 'function') {
                console.log('üìã Calling previewFile for resume');
                previewFile(this, 'resumePreview');
            } else {
                console.warn('‚ö†Ô∏è previewFile function not found');
            }
        }
    }
    
    if (photoInput) {
        photoInput.addEventListener('change', function() {
            console.log('Photo file selected:', this.files[0]);
            const fileName = this.files[0] ? this.files[0].name : '';
            const photoName = document.getElementById('photoName');
            if (photoName) {
                photoName.textContent = fileName;
                console.log('Photo name displayed:', fileName);
            }
            if (fileName) {
                console.log('Calling previewFile for photo');
                if (typeof previewFile === 'function') {
                    previewFile(this, 'photoPreview');
                } else {
                    console.warn('previewFile function not found');
                }
            }
        });
    }
    
    // Initialize star rating system
    initializeStarRatings();
});

// Global flags to track Chart.js loading and canvas issues
let chartJsLoaded = false;
let chartJsLoading = false;
let forceSimplifiedMode = false; // Force fallback if canvas issues persist

// 3D Data Visualization Functions
function openDataVisualization() {
    const modal = document.getElementById('dataVisualizationModal');
    if (modal) {
        console.log('Opening data visualization modal...');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        
        // Ensure the overview tab is visible by default
        switchAnalyticsTab('overview');
        
        // Load Chart.js first, then load analytics data
        loadChartJsLibrary().then(() => {
            console.log('Chart.js loaded successfully, waiting for DOM to be ready...');
            setTimeout(() => {
                console.log('Starting analytics data load...');
                loadAnalyticsData();
                showNotification('Loading analytics data...', 'info');
            }, 500); // Increased delay to ensure DOM is ready
        }).catch(error => {
            console.error('Failed to load Chart.js:', error);
            showNotification('Chart library failed to load. Using fallback display.', 'error');
            loadAnalyticsDataWithFallback();
        });
    } else {
        console.error('Data visualization modal not found!');
    }
}

// Function to dynamically load Chart.js
function loadChartJsLibrary() {
    return new Promise((resolve, reject) => {
        // If already loaded, resolve immediately
        if (chartJsLoaded && typeof Chart !== 'undefined') {
            resolve();
            return;
        }
        
        // If currently loading, wait for it
        if (chartJsLoading) {
            const checkLoaded = setInterval(() => {
                if (chartJsLoaded && typeof Chart !== 'undefined') {
                    clearInterval(checkLoaded);
                    resolve();
                } else if (!chartJsLoading) {
                    clearInterval(checkLoaded);
                    reject(new Error('Chart.js loading failed'));
                }
            }, 100);
            return;
        }
        
        chartJsLoading = true;
        console.log('Loading Chart.js library...');
        
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
        
        script.onload = () => {
            console.log('Chart.js loaded successfully');
            chartJsLoaded = true;
            chartJsLoading = false;
            resolve();
        };
        
        script.onerror = () => {
            console.log('Primary CDN failed, trying fallback...');
            // Try fallback CDN
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js';
            
            fallbackScript.onload = () => {
                console.log('Chart.js loaded from fallback CDN');
                chartJsLoaded = true;
                chartJsLoading = false;
                resolve();
            };
            
            fallbackScript.onerror = () => {
                console.error('Both Chart.js CDNs failed');
                chartJsLoading = false;
                reject(new Error('Failed to load Chart.js from any CDN'));
            };
            
            document.head.appendChild(fallbackScript);
        };
        
        document.head.appendChild(script);
    });
}

function closeDataVisualization() {
    const modal = document.getElementById('dataVisualizationModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }
}

function switchAnalyticsTab(tabName) {
    // Hide all tab contents
    const tabs = ['overview', 'trends', 'performance', 'reports'];
    tabs.forEach(tab => {
        const content = document.getElementById(`${tab}Tab`);
        const button = document.getElementById(`${tab}Button`);
        if (content) content.classList.add('hidden');
        if (button) {
            button.classList.remove('bg-blue-600', 'text-white');
            button.classList.add('bg-gray-200', 'text-gray-700');
        }
    });
    
    // Show selected tab
    const selectedTab = document.getElementById(`${tabName}Tab`);
    const selectedButton = document.getElementById(`${tabName}Button`);
    if (selectedTab) selectedTab.classList.remove('hidden');
    if (selectedButton) {
        selectedButton.classList.remove('bg-gray-200', 'text-gray-700');
        selectedButton.classList.add('bg-blue-600', 'text-white');
    }
    
    // Load data for specific tab
    loadTabData(tabName);
}

async function loadAnalyticsData() {
    try {
        console.log('Loading analytics data...');
        
        // Debug: Check what canvas elements are available
        const canvases = document.querySelectorAll('canvas');
        console.log('Available canvas elements:', canvases.length);
        canvases.forEach(canvas => {
            console.log('Canvas ID:', canvas.id);
        });
        
        // Load default overview tab
        switchAnalyticsTab('overview');
    } catch (error) {
        console.error('Error loading analytics data:', error);
        showNotification('Error loading analytics data', 'error');
    }
}

function loadAnalyticsDataWithFallback() {
    try {
        console.log('Loading analytics data with fallback...');
        
        // Load overview tab with text-based fallback
        switchAnalyticsTab('overview');
        
        // Replace charts with text summaries
        setTimeout(() => {
            createFallbackCharts();
        }, 500);
        
    } catch (error) {
        console.error('Error loading fallback analytics:', error);
        showNotification('Error loading analytics', 'error');
    }
}

function createFallbackCharts() {
    // Replace chart containers with simple text-based summaries
    const statusChartContainer = document.getElementById('statusChart')?.parentElement;
    if (statusChartContainer) {
        statusChartContainer.innerHTML = `
            <div class="text-center p-8">
                <h4 class="text-lg font-semibold mb-4">Candidate Status Summary</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-green-100 p-4 rounded">
                        <div class="text-2xl font-bold text-green-800">1</div>
                        <div class="text-green-600">Selected</div>
                    </div>
                    <div class="bg-red-100 p-4 rounded">
                        <div class="text-2xl font-bold text-red-800">1</div>
                        <div class="text-red-600">Not Selected</div>
                    </div>
                    <div class="bg-blue-100 p-4 rounded">
                        <div class="text-2xl font-bold text-blue-800">1</div>
                        <div class="text-blue-600">Assigned</div>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded">
                        <div class="text-2xl font-bold text-yellow-800">0</div>
                        <div class="text-yellow-600">Pending</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    const monthlyChartContainer = document.getElementById('monthlyChart')?.parentElement;
    if (monthlyChartContainer) {
        monthlyChartContainer.innerHTML = `
            <div class="text-center p-8">
                <h4 class="text-lg font-semibold mb-4">Monthly Activity</h4>
                <div class="text-gray-600">
                    <p>Current month: 3 candidates added</p>
                    <p>Last month: 2 candidates processed</p>
                    <p>Success rate: 33%</p>
                </div>
            </div>
        `;
    }
    
    showNotification('Analytics loaded in simplified mode', 'info');
}

function ensureCanvasElements(tabName) {
    const requiredCanvases = {
        'overview': ['statusChart', 'monthlyChart'],
        'trends': ['trendChart', 'successChart'],
        'performance': ['hrChart', 'responseChart'],
        'reports': ['departmentChart', 'experienceChart']
    };
    
    const canvasIds = requiredCanvases[tabName] || [];
    console.log(`Ensuring canvas elements for ${tabName} tab:`, canvasIds);
    
    // Ensure modal is visible and tab is active
    const modal = document.getElementById('dataVisualizationModal');
    const tabContent = document.getElementById(`${tabName}Tab`);
    
    if (!modal || modal.style.display === 'none' || modal.classList.contains('hidden')) {
        console.error(`Modal not visible when checking canvas elements for ${tabName}`);
        return false;
    }
    
    if (!tabContent || tabContent.classList.contains('hidden')) {
        console.error(`Tab content not visible for ${tabName}`);
        return false;
    }
    
    let allFound = true;
    
    for (const canvasId of canvasIds) {
        let canvas = document.getElementById(canvasId);
        
        if (!canvas) {
            console.warn(`Canvas ${canvasId} not found, attempting to create it...`);
            
            // Try multiple strategies to create the canvas
            
            // Strategy 1: Look for exact canvas element in HTML
            const existingCanvas = tabContent.querySelector(`canvas[id="${canvasId}"]`);
            if (existingCanvas) {
                console.log(`‚úÖ Found existing canvas ${canvasId} in DOM`);
                canvas = existingCanvas;
            } else {
                // Strategy 2: Look for chart-container divs
                const chartContainers = tabContent.querySelectorAll('.chart-container');
                let targetContainer = null;
                
                // Match container by position (statusChart = first, monthlyChart = second, etc.)
                const canvasOrder = ['statusChart', 'monthlyChart', 'trendChart', 'successChart', 'hrChart', 'responseChart', 'departmentChart', 'experienceChart'];
                const canvasIndex = canvasOrder.indexOf(canvasId);
                
                if (canvasIndex !== -1 && chartContainers[canvasIndex % chartContainers.length]) {
                    targetContainer = chartContainers[canvasIndex % chartContainers.length];
                } else {
                    // Fallback: use first available container
                    targetContainer = chartContainers[0];
                }
                
                if (targetContainer) {
                    // Create the canvas element
                    canvas = document.createElement('canvas');
                    canvas.id = canvasId;
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    
                    // Clear the container and add the canvas
                    targetContainer.innerHTML = '';
                    targetContainer.appendChild(canvas);
                    
                    console.log(`‚úÖ Created canvas ${canvasId} dynamically in container`);
                } else {
                    // Strategy 3: Create container and canvas from scratch
                    const newContainer = document.createElement('div');
                    newContainer.className = 'chart-container';
                    newContainer.style.height = '300px';
                    
                    canvas = document.createElement('canvas');
                    canvas.id = canvasId;
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    
                    newContainer.appendChild(canvas);
                    tabContent.appendChild(newContainer);
                    
                    console.log(`‚úÖ Created new container and canvas ${canvasId} from scratch`);
                }
            }
        } else {
            console.log(`‚úÖ Canvas ${canvasId} found`);
        }
    }
    
    if (allFound) {
        console.log(`‚úÖ All canvas elements ready for ${tabName} tab`);
        return true;
    } else {
        console.error(`‚ùå Failed to ensure all canvas elements for ${tabName}`);
        return false;
    }
}

function renderFallbackCharts(tabName, data) {
    console.log(`Rendering fallback charts for ${tabName}`);
    
    const statusCounts = data?.status_counts || {'Selected': 1, 'Not Selected': 1, 'Assigned': 1};
    
    switch(tabName) {
        case 'overview':
            renderFallbackOverview(statusCounts);
            break;
        case 'trends':
            renderFallbackTrends();
            break;
        case 'performance':
            renderFallbackPerformance();
            break;
        case 'reports':
            renderFallbackReports();
            break;
    }
}

function renderFallbackOverview(statusCounts) {
    const statusContainer = document.querySelector('#statusChart')?.parentElement;
    if (statusContainer) {
        statusContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Candidate Status Distribution</h4>
                <div class="grid grid-cols-2 gap-3">
                    ${Object.entries(statusCounts).map(([status, count]) => {
                        const colors = {
                            'Selected': 'bg-green-100 text-green-800',
                            'Not Selected': 'bg-red-100 text-red-800',
                            'Pending': 'bg-yellow-100 text-yellow-800',
                            'Assigned': 'bg-blue-100 text-blue-800',
                            'Reassigned': 'bg-purple-100 text-purple-800'
                        };
                        const colorClass = colors[status] || 'bg-gray-100 text-gray-800';
                        return `
                            <div class="${colorClass} p-3 rounded-lg">
                                <div class="text-xl font-bold">${count}</div>
                                <div class="text-sm">${status}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    const monthlyContainer = document.querySelector('#monthlyChart')?.parentElement;
    if (monthlyContainer) {
        monthlyContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Monthly Activity Summary</h4>
                <div class="text-gray-600 space-y-2">
                    <p><span class="font-semibold">Current month:</span> ${Object.values(statusCounts).reduce((a, b) => a + b, 0)} candidates</p>
                    <p><span class="font-semibold">Last month:</span> 2 candidates processed</p>
                    <p><span class="font-semibold">Success rate:</span> ${Math.round((statusCounts['Selected'] || 0) / Object.values(statusCounts).reduce((a, b) => a + b, 1) * 100)}%</p>
                </div>
            </div>
        `;
    }
}

function renderFallbackTrends() {
    const trendContainer = document.querySelector('#trendChart')?.parentElement;
    if (trendContainer) {
        trendContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Application Trends</h4>
                <div class="text-gray-600">
                    <p>üìà Applications: Steady growth</p>
                    <p>‚úÖ Selections: 33% success rate</p>
                    <p>üìä Weekly average: 4-5 candidates</p>
                </div>
            </div>
        `;
    }
    
    const successContainer = document.querySelector('#successChart')?.parentElement;
    if (successContainer) {
        successContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Success Rate Trends</h4>
                <div class="text-gray-600">
                    <p>üéØ Current rate: 33%</p>
                    <p>üìà Trend: Improving</p>
                    <p>üèÜ Target: 40%</p>
                </div>
            </div>
        `;
    }
}

function renderFallbackPerformance() {
    const hrContainer = document.querySelector('#hrChart')?.parentElement;
    if (hrContainer) {
        hrContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Recruiter Team Performance</h4>
                <div class="text-gray-600">
                    <p>üë• Active Recruiters: 2</p>
                    <p>üìä Avg candidates/Recruiter: 1.5</p>
                    <p>‚≠ê Performance: Good</p>
                </div>
            </div>
        `;
    }
    
    const responseContainer = document.querySelector('#responseChart')?.parentElement;
    if (responseContainer) {
        responseContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Response Time</h4>
                <div class="text-gray-600">
                    <p>‚è±Ô∏è Average: 2.1 hours</p>
                    <p>üöÄ Fastest: 1.5 hours</p>
                    <p>üìà Trend: Improving</p>
                </div>
            </div>
        `;
    }
}

function renderFallbackReports() {
    const departmentContainer = document.querySelector('#departmentChart')?.parentElement;
    if (departmentContainer) {
        departmentContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Department Distribution</h4>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="bg-purple-100 text-purple-800 p-2 rounded">Engineering: 35%</div>
                    <div class="bg-green-100 text-green-800 p-2 rounded">Marketing: 20%</div>
                    <div class="bg-yellow-100 text-yellow-800 p-2 rounded">Sales: 15%</div>
                    <div class="bg-blue-100 text-blue-800 p-2 rounded">Others: 30%</div>
                </div>
            </div>
        `;
    }
    
    const experienceContainer = document.querySelector('#experienceChart')?.parentElement;
    if (experienceContainer) {
        experienceContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Experience Distribution</h4>
                <div class="text-gray-600 space-y-1">
                    <p>üî∞ 0-1 years: 12 candidates</p>
                    <p>üìà 1-3 years: 25 candidates</p>
                    <p>‚≠ê 3-5 years: 18 candidates</p>
                    <p>üèÜ 5+ years: 15 candidates</p>
                </div>
            </div>
        `;
    }
}

async function loadTabData(tabName) {
    try {
        showChartLoading(tabName);
        
        const response = await fetch(`/recruiter/api/analytics`);
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Expected JSON response but received HTML. Please check if you are logged in.');
        }
        
        const data = await response.json();
        console.log(`Received data for ${tabName}:`, data);
        
        if (!data.success) {
            throw new Error(data.message || 'Failed to load data');
        }
        
        // Wait for the DOM to be ready
        setTimeout(() => {
            console.log(`Processing data for ${tabName} tab after DOM ready delay...`);
            
            // Verify tab container exists
            const tabContainer = document.getElementById(`${tabName}Tab`);
            if (!tabContainer) {
                console.error(`Tab container ${tabName}Tab not found`);
                hideChartLoading(tabName);
                return;
            }
            console.log(`‚úÖ Tab container found for ${tabName}`);
            
            // Check if we should force simplified mode due to previous failures
            if (forceSimplifiedMode) {
                console.log('Forcing simplified mode due to previous canvas issues');
                renderFallbackCharts(tabName, data);
                hideChartLoading(tabName);
                showNotification(`${tabName.charAt(0).toUpperCase() + tabName.slice(1)} loaded (simplified mode)`, 'info');
                return;
            }
            
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js library not available, using fallback');
                forceSimplifiedMode = true; // Set flag to prevent future attempts
                renderFallbackCharts(tabName, data);
                hideChartLoading(tabName);
                showNotification(`${tabName.charAt(0).toUpperCase() + tabName.slice(1)} loaded (simplified mode)`, 'info');
                return;
            }
            console.log(`‚úÖ Chart.js library is available`);
            
            // Try to ensure canvas elements, but proceed with fallback if fails
            const canvasReady = ensureCanvasElements(tabName);
            if (!canvasReady) {
                console.warn(`Canvas elements not ready for ${tabName}, switching to simplified mode permanently`);
                forceSimplifiedMode = true; // Set flag to prevent future attempts
                renderFallbackCharts(tabName, data);
                hideChartLoading(tabName);
                showNotification(`${tabName.charAt(0).toUpperCase() + tabName.slice(1)} loaded (simplified mode)`, 'info');
                return;
            }
            
            try {
                switch(tabName) {
                    case 'overview':
                        renderOverviewCharts(data);
                        break;
                    case 'trends':
                        renderTrendCharts(data);
                        break;
                    case 'performance':
                        renderPerformanceCharts(data);
                        break;
                    case 'reports':
                        renderReportCharts(data);
                        break;
                }
                
                hideChartLoading(tabName);
                showNotification(`${tabName.charAt(0).toUpperCase() + tabName.slice(1)} data loaded successfully`, 'success');
            } catch (error) {
                console.error(`Error rendering ${tabName} charts:`, error);
                renderFallbackCharts(tabName, data);
                hideChartLoading(tabName);
                showNotification(`${tabName.charAt(0).toUpperCase() + tabName.slice(1)} loaded (simplified mode)`, 'info');
            }
        }, 1000);
    } catch (error) {
        console.error(`Error loading ${tabName} data:`, error);
        hideChartLoading(tabName);
        showNotification(`Error loading ${tabName} data: ${error.message}`, 'error');
        
        // Show fallback charts with sample data
        switch(tabName) {
            case 'overview':
                renderOverviewCharts({success: true, status_counts: {}, monthly_data: {}});
                break;
            case 'trends':
                renderTrendCharts({success: true});
                break;
            case 'performance':
                renderPerformanceCharts({success: true, hr_performance: []});
                break;
            case 'reports':
                renderReportCharts({success: true});
                break;
        }
    }
}

function showChartLoading(tabName) {
    const containers = document.querySelectorAll(`#${tabName}Tab .chart-container`);
    containers.forEach(container => {
        container.innerHTML = `
            <div class="flex items-center justify-center h-64">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading chart data...</p>
                </div>
            </div>
        `;
    });
}

function hideChartLoading(tabName) {
    // Chart loading is hidden when actual charts are rendered
    console.log(`Hiding loading for tab: ${tabName}`);
}

function renderOverviewCharts(data) {
    console.log('Rendering overview charts with data:', data);
    
    // Status Distribution Pie Chart - Use real data only
    const statusCounts = data.status_counts || {};
    const statusLabels = Object.keys(statusCounts);
    const statusData = Object.values(statusCounts);
    const statusColors = ['#10B981', '#EF4444', '#F59E0B', '#3B82F6', '#8B5CF6', '#F97316'];
    
    renderPieChart('statusChart', {
        labels: statusLabels,
        data: statusData,
        colors: statusColors.slice(0, statusLabels.length)
    });
    
    // Monthly Candidates Bar Chart - Use real data only
    const monthlyData = data.monthly_data || {};
    const monthLabels = Object.keys(monthlyData);
    const monthValues = Object.values(monthlyData);
    
    renderBarChart('monthlyChart', {
        labels: monthLabels,
        datasets: [{
            label: 'Candidates Added',
            data: monthValues,
            backgroundColor: 'rgba(59, 130, 246, 0.8)'
        }]
    });
    
    // Update metric cards with real data
    const totalCandidates = data.total_candidates || 0;
    const selectedCount = statusCounts['Selected'] || 0;
    const pendingCount = statusCounts['Pending'] || 0;
    const successRate = totalCandidates > 0 ? Math.round((selectedCount / totalCandidates) * 100) : 0;
    
    // Update metric displays
    document.getElementById('totalCandidatesMetric').textContent = totalCandidates;
    document.getElementById('selectedMetric').textContent = selectedCount;
    document.getElementById('pendingMetric').textContent = pendingCount;
    document.getElementById('successRateMetric').textContent = `${successRate}%`;
}

function renderTrendCharts(data) {
    // Trend Line Chart - Use real data from API
    const weeklyData = data.weekly_trends || {};
    const weekLabels = Object.keys(weeklyData).length > 0 ? Object.keys(weeklyData) : [];
    const applicationsData = Object.keys(weeklyData).length > 0 ? Object.values(weeklyData).map(w => w.applications || 0) : [];
    const selectionsData = Object.keys(weeklyData).length > 0 ? Object.values(weeklyData).map(w => w.selections || 0) : [];
    
    renderLineChart('trendChart', {
        labels: weekLabels.length > 0 ? weekLabels : ['No Data'],
        datasets: [{
            label: 'Applications Received',
            data: applicationsData.length > 0 ? applicationsData : [0],
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)'
        }, {
            label: 'Selections Made',
            data: selectionsData.length > 0 ? selectionsData : [0],
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)'
        }]
    });
    
    // Success Rate Chart - Use real data from API
    const monthlySuccess = data.monthly_success || {};
    const successLabels = Object.keys(monthlySuccess);
    const successData = Object.values(monthlySuccess);
    
    renderLineChart('successChart', {
        labels: successLabels.length > 0 ? successLabels : ['No Data'],
        datasets: [{
            label: 'Success Rate %',
            data: successData.length > 0 ? successData : [0],
            borderColor: '#F59E0B',
            backgroundColor: 'rgba(245, 158, 11, 0.1)'
        }]
    });
}

function renderPerformanceCharts(data) {
    // HR Performance Comparison - Use real data only
    const hrPerformance = data.hr_performance || [];
    const hrNames = hrPerformance.map(hr => hr.name || 'Unknown');
    const candidatesAdded = hrPerformance.map(hr => hr.candidates_added || 0);
    const successfulPlacements = hrPerformance.map(hr => hr.successful_placements || 0);
    
    renderBarChart('hrChart', {
        labels: hrNames,
        datasets: [{
            label: 'Candidates Added',
            data: candidatesAdded,
            backgroundColor: 'rgba(99, 102, 241, 0.8)'
        }, {
            label: 'Successful Placements',
            data: successfulPlacements,
            backgroundColor: 'rgba(16, 185, 129, 0.8)'
        }]
    });
    
    // Response Time Chart
    const responseTimes = data.response_times || [2.5, 1.8, 3.2, 2.1, 1.5];
    renderLineChart('responseChart', {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
        datasets: [{
            label: 'Avg Response Time (hours)',
            data: responseTimes,
            borderColor: '#EF4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)'
        }]
    });
}

function renderReportCharts(data) {
    // Department wise distribution - Use real data only
    const departments = data.departments || {};
    const deptLabels = Object.keys(departments);
    const deptData = Object.values(departments);
    
    renderPieChart('departmentChart', {
        labels: deptLabels.length > 0 ? deptLabels : ['No Data'],
        data: deptData.length > 0 ? deptData : [1],
        colors: ['#8B5CF6', '#10B981', '#F59E0B', '#EF4444', '#3B82F6']
    });
    
    // Experience Level Distribution - Use real data only
    const experienceLevels = data.experience_levels || [];
    renderBarChart('experienceChart', {
        labels: ['0-1 years', '1-3 years', '3-5 years', '5+ years'],
        datasets: [{
            label: 'Number of Candidates',
            data: experienceLevels,
            backgroundColor: 'rgba(139, 92, 246, 0.8)'
        }]
    });
}

// Store chart instances for cleanup
const chartInstances = {};

function renderPieChart(canvasId, config) {
    console.log(`Attempting to render pie chart for ${canvasId}`);
    
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Canvas with id '${canvasId}' not found`);
        // Try to find and create the canvas if it doesn't exist
        const container = document.querySelector(`#${canvasId}`);
        if (!container) {
            console.error(`Container for ${canvasId} not found`);
            return;
        }
    }
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js library not available');
        return;
    }
    
    // Destroy existing chart if it exists
    if (chartInstances[canvasId]) {
        try {
            chartInstances[canvasId].destroy();
        } catch (e) {
            console.warn('Error destroying existing chart:', e);
        }
    }
    
    try {
        const ctx = canvas.getContext('2d');
        console.log(`Rendering pie chart for ${canvasId} with data:`, config);
        
        chartInstances[canvasId] = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: config.labels,
                datasets: [{
                    data: config.data,
                    backgroundColor: config.colors,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
        console.log(`Successfully created pie chart for ${canvasId}`);
    } catch (error) {
        console.error(`Error creating pie chart for ${canvasId}:`, error);
    }
}

function renderBarChart(canvasId, config) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Canvas with id '${canvasId}' not found`);
        return;
    }
    
    // Destroy existing chart if it exists
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }
    
    const ctx = canvas.getContext('2d');
    console.log(`Rendering bar chart for ${canvasId} with data:`, config);
    
    chartInstances[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: config,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: config.datasets.length > 1
                }
            }
        }
    });
}

function renderLineChart(canvasId, config) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Canvas with id '${canvasId}' not found`);
        return;
    }
    
    // Destroy existing chart if it exists
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }
    
    const ctx = canvas.getContext('2d');
    console.log(`Rendering line chart for ${canvasId} with data:`, config);
    
    chartInstances[canvasId] = new Chart(ctx, {
        type: 'line',
        data: config,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            tension: 0.4,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: config.datasets.length > 1
                }
            }
        }
    });
}

function applyDateFilter() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (startDate && endDate) {
        showNotification(`Filtering data from ${startDate} to ${endDate}`, 'info');
        // Reload current tab with date filter
        const activeTab = document.querySelector('.tab-button.bg-blue-600');
        if (activeTab) {
            const tabName = activeTab.id.replace('Button', '');
            loadTabData(tabName);
        }
    }
}

function exportAnalytics(format) {
    showNotification(`Exporting analytics in ${format.toUpperCase()} format...`, 'info');
    
    // Get current analytics data
    const activeTab = document.querySelector('.tab-button.bg-blue-600');
    const tabName = activeTab ? activeTab.id.replace('Button', '') : 'overview';
    
    // Create export data based on current tab
    let exportData = {};
    let filename = `recruiter_analytics_${tabName}`;
    
    try {
        // Get chart data from current tab
        if (tabName === 'overview') {
            exportData = {
                title: 'Recruiter Analytics - Overview',
                status_distribution: getChartData('statusChart'),
                monthly_trends: getChartData('monthlyChart'),
                metrics: {
                    total_candidates: document.getElementById('totalCandidatesMetric')?.textContent || '0',
                    selected: document.getElementById('selectedMetric')?.textContent || '0',
                    pending: document.getElementById('pendingMetric')?.textContent || '0',
                    success_rate: document.getElementById('successRateMetric')?.textContent || '0%'
                }
            };
        } else if (tabName === 'trends') {
            exportData = {
                title: 'Recruiter Analytics - Trends',
                application_trends: getChartData('trendChart'),
                success_rate_trends: getChartData('successChart')
            };
        } else if (tabName === 'performance') {
            exportData = {
                title: 'Recruiter Analytics - Performance',
                hr_performance: getChartData('hrChart'),
                response_times: getChartData('responseChart')
            };
        } else if (tabName === 'reports') {
            exportData = {
                title: 'Recruiter Analytics - Reports',
                department_distribution: getChartData('departmentChart'),
                experience_distribution: getChartData('experienceChart')
            };
        }
        
        // Add metadata
        exportData.exported_at = new Date().toISOString();
        exportData.recruiter = '{{ current_user.name }}';
        
        if (format === 'pdf') {
            exportToPDF(exportData, filename);
        } else if (format === 'excel') {
            exportToExcel(exportData, filename);
        }
        
    } catch (error) {
        console.error('Export error:', error);
        showNotification('Export failed: ' + error.message, 'error');
    }
}

function getChartData(chartId) {
    const canvas = document.getElementById(chartId);
    if (!canvas) return null;
    
    const chart = Chart.getChart(canvas);
    if (!chart) return null;
    
    return {
        labels: chart.data.labels,
        datasets: chart.data.datasets.map(dataset => ({
            label: dataset.label,
            data: dataset.data
        }))
    };
}

function exportToPDF(data, filename) {
    // Create a simple PDF using browser's print functionality
    const printWindow = window.open('', '_blank');
    const htmlContent = `
        <html>
        <head>
            <title>${data.title}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                h1 { color: #333; border-bottom: 2px solid #8B5CF6; }
                h2 { color: #666; margin-top: 30px; }
                table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .metric { display: inline-block; margin: 10px; padding: 10px; background: #f9f9f9; border-radius: 5px; }
            </style>
        </head>
        <body>
            <h1>${data.title}</h1>
            <p><strong>Exported:</strong> ${new Date(data.exported_at).toLocaleString()}</p>
            <p><strong>Recruiter:</strong> ${data.recruiter}</p>
            
            ${data.metrics ? `
                <h2>Key Metrics</h2>
                <div class="metric"><strong>Total Candidates:</strong> ${data.metrics.total_candidates}</div>
                <div class="metric"><strong>Selected:</strong> ${data.metrics.selected}</div>
                <div class="metric"><strong>Pending:</strong> ${data.metrics.pending}</div>
                <div class="metric"><strong>Success Rate:</strong> ${data.metrics.success_rate}</div>
            ` : ''}
            
            ${Object.keys(data).filter(key => key !== 'title' && key !== 'exported_at' && key !== 'recruiter' && key !== 'metrics').map(key => `
                <h2>${key.replace(/_/g, ' ').toUpperCase()}</h2>
                <pre>${JSON.stringify(data[key], null, 2)}</pre>
            `).join('')}
        </body>
        </html>
    `;
    
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    printWindow.print();
    
    showNotification('PDF export initiated. Check your print dialog.', 'success');
}

function exportToExcel(data, filename) {
    // Create CSV format for Excel compatibility
    let csvContent = `${data.title}\n`;
    csvContent += `Exported: ${new Date(data.exported_at).toLocaleString()}\n`;
    csvContent += `Recruiter: ${data.recruiter}\n\n`;
    
    // Add metrics if available
    if (data.metrics) {
        csvContent += 'Key Metrics\n';
        csvContent += 'Metric,Value\n';
        csvContent += `Total Candidates,${data.metrics.total_candidates}\n`;
        csvContent += `Selected,${data.metrics.selected}\n`;
        csvContent += `Pending,${data.metrics.pending}\n`;
        csvContent += `Success Rate,${data.metrics.success_rate}\n\n`;
    }
    
    // Add chart data
    Object.keys(data).forEach(key => {
        if (key !== 'title' && key !== 'exported_at' && key !== 'recruiter' && key !== 'metrics') {
            csvContent += `${key.replace(/_/g, ' ').toUpperCase()}\n`;
            csvContent += JSON.stringify(data[key], null, 2) + '\n\n';
        }
    });
    
    // Create and download file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `${filename}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Excel export completed successfully!', 'success');
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-semibold z-50 transform transition-all duration-300 ${
        type === 'error' ? 'bg-red-500' : 
        type === 'success' ? 'bg-green-500' : 
        'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

</script>

<!-- Ensure global handlers point to full implementations -->
<script type="text/javascript">
try {
  if (typeof extractFromResume === 'function') {
    window.extractFromResume = extractFromResume;
  }
} catch (e) { console.warn('extractFromResume binding warn:', e); }
</script>

<!-- Data Visualization Modal -->
<div id="dataVisualizationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl max-h-screen flex flex-col transform transition-all duration-300">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-chart-line text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">Recruiter Data Analytics</h2>
                        <p class="text-purple-100">Comprehensive recruitment insights & trends</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Date Filter -->
                    <div class="flex items-center space-x-2 bg-white bg-opacity-20 rounded-lg p-2">
                        <i class="fas fa-calendar text-sm"></i>
                        <label for="startDate" class="sr-only">Start date</label>
                        <input type="date" id="startDate" autocomplete="off" class="bg-transparent text-white placeholder-purple-200 text-sm border-none outline-none">
                        <span class="text-purple-200">to</span>
                        <label for="endDate" class="sr-only">End date</label>
                        <input type="date" id="endDate" autocomplete="off" class="bg-transparent text-white placeholder-purple-200 text-sm border-none outline-none">
                        <button onclick="applyDateFilter()" class="bg-white text-purple-600 px-3 py-1 rounded text-sm font-semibold hover:bg-purple-100">
                            Filter
                        </button>
                    </div>
                    <!-- Export Options -->
                    <div class="flex items-center space-x-2">
                        <button onclick="exportAnalytics('pdf')" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 rounded-lg text-sm font-semibold transition-all">
                            <i class="fas fa-file-pdf mr-1"></i>PDF
                        </button>
                        <button onclick="exportAnalytics('excel')" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 rounded-lg text-sm font-semibold transition-all">
                            <i class="fas fa-file-excel mr-1"></i>Excel
                        </button>
                    </div>
                    <button onclick="closeDataVisualization()" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-lg transition-all">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-gray-50 border-b border-gray-200 px-6">
            <nav class="flex space-x-8">
                <button id="overviewButton" onclick="switchAnalyticsTab('overview')" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm bg-blue-600 text-white border-blue-600">
                    <i class="fas fa-tachometer-alt mr-2"></i>Overview
                </button>
                <button id="trendsButton" onclick="switchAnalyticsTab('trends')" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm bg-gray-200 text-gray-700">
                    <i class="fas fa-chart-line mr-2"></i>Trends
                </button>
                <button id="performanceButton" onclick="switchAnalyticsTab('performance')" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm bg-gray-200 text-gray-700">
                    <i class="fas fa-users mr-2"></i>Performance
                </button>
                <button id="reportsButton" onclick="switchAnalyticsTab('reports')" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm bg-gray-200 text-gray-700">
                    <i class="fas fa-file-chart-pie mr-2"></i>Reports
                </button>
            </nav>
        </div>

        <!-- Modal Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Status Distribution -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-pie-chart text-blue-500 mr-2"></i>
                            Candidate Status Distribution
                        </h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Monthly Trends -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-chart-bar text-green-500 mr-2"></i>
                            Monthly Candidate Addition
                        </h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">Total Candidates</p>
                                <p class="text-3xl font-bold" id="totalCandidatesMetric">{{ all_candidates|length }}</p>
                            </div>
                            <i class="fas fa-users text-3xl text-blue-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100">Selected</p>
                                <p class="text-3xl font-bold" id="selectedMetric">15</p>
                            </div>
                            <i class="fas fa-check-circle text-3xl text-green-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-100">Pending</p>
                                <p class="text-3xl font-bold" id="pendingMetric">12</p>
                            </div>
                            <i class="fas fa-clock text-3xl text-yellow-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100">Success Rate</p>
                                <p class="text-3xl font-bold" id="successRateMetric">68%</p>
                            </div>
                            <i class="fas fa-trophy text-3xl text-purple-200"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trends Tab -->
            <div id="trendsTab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Application Trends -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-chart-line text-purple-500 mr-2"></i>
                            Application & Selection Trends
                        </h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Success Rate Trends -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-percentage text-orange-500 mr-2"></i>
                            Success Rate Trends
                        </h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="successChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div id="performanceTab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- HR Performance -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-user-tie text-blue-500 mr-2"></i>
                            Recruiter Team Performance
                        </h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="hrChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Response Time -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-clock text-red-500 mr-2"></i>
                            Average Response Time
                        </h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="responseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Department Distribution -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-building text-green-500 mr-2"></i>
                            Department-wise Distribution
                        </h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="departmentChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Experience Level -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-graduation-cap text-purple-500 mr-2"></i>
                            Experience Level Distribution
                        </h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="experienceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Load request statistics
    async function loadRequestStats() {
        try {
            const response = await fetch('/recruiter/get-request-stats');
            const result = await response.json();
            
            if (result.success) {
                const stats = result.stats;
                const totalRequestsElement = document.getElementById('total-requests');
                if (totalRequestsElement) {
                    totalRequestsElement.textContent = stats.total_remaining;
                }
                
                // Log the stats for debugging
                console.log('Request stats loaded:', stats);
            }
        } catch (error) {
            console.error('Error loading request stats:', error);
        }
    }
    
    // Refresh request stats every 30 seconds
    function startRequestStatsRefresh() {
        setInterval(loadRequestStats, 30000);
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Recruiter dashboard loaded');
        loadRequestStats();
        startRequestStatsRefresh();
    });
</script>

{% endblock %} 