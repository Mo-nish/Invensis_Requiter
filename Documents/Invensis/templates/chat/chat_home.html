{% extends "base.html" %}

{% block title %}Invensis Chat - Internal Communication{% endblock %}

{% block head %}
<style>
/* Chat Home Page Styles */
.chat-home-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
}

.chat-home-content {
    max-width: 1200px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    overflow: hidden;
}

.chat-home-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    text-align: center;
}

.chat-home-header h1 {
    margin: 0 0 10px 0;
    font-size: 2.5rem;
    font-weight: 700;
}

.chat-home-header p {
    margin: 0;
    font-size: 1.1rem;
    opacity: 0.9;
}

.chat-home-body {
    padding: 40px;
}

.departments-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 30px;
    margin-bottom: 40px;
}

.department-card {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 15px;
    padding: 25px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.department-card:hover {
    border-color: #667eea;
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
}

.department-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.department-header {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.department-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    margin-right: 15px;
}

.department-info h3 {
    margin: 0 0 5px 0;
    font-size: 1.3rem;
    color: #1e293b;
}

.department-info p {
    margin: 0;
    color: #64748b;
    font-size: 0.9rem;
}

.users-list {
    max-height: 200px;
    overflow-y: auto;
}

.user-item {
    display: flex;
    align-items: center;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
    border: 1px solid transparent;
}

.user-item:hover {
    background: #f8fafc;
    border-color: #e2e8f0;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    margin-right: 12px;
    font-size: 0.9rem;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 2px;
}

.user-email {
    font-size: 0.8rem;
    color: #64748b;
}

.user-status {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #10b981;
    margin-left: 10px;
}

.user-status.offline {
    background: #94a3b8;
}

.ai-chat-section {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 2px solid #0ea5e9;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    margin-top: 30px;
}

.ai-chat-section h3 {
    margin: 0 0 15px 0;
    color: #0c4a6e;
    font-size: 1.5rem;
}

.ai-chat-section p {
    margin: 0 0 25px 0;
    color: #0369a1;
    font-size: 1rem;
}

.ai-chat-button {
    background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 25px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 10px;
}

.ai-chat-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(14, 165, 233, 0.3);
}

.empty-department {
    text-align: center;
    color: #64748b;
    padding: 20px;
    font-style: italic;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .chat-home-container {
        padding: 10px;
    }
    
    .chat-home-body {
        padding: 20px;
    }
    
    .departments-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .chat-home-header h1 {
        font-size: 2rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="chat-home-container">
    <div class="chat-home-content">
        <div class="chat-home-header">
            <h1>üí¨ Invensis Internal Chat</h1>
            <p>Connect with your team and get AI assistance</p>
        </div>
        
        <div class="chat-home-body">
            <div class="departments-grid" id="departmentsGrid">
                <!-- Departments will be loaded here -->
            </div>
            
            <div class="ai-chat-section">
                <h3>ü§ñ Invensis AI Assistant</h3>
                <p>Get intelligent help with real-time data and insights</p>
                <button class="ai-chat-button" onclick="openAIChat()">
                    <i class="fas fa-robot"></i>
                    Chat with AI Assistant
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden templates -->
<div id="departmentTemplate" style="display: none;">
    <div class="department-card" data-department="">
        <div class="department-header">
            <div class="department-icon"></div>
            <div class="department-info">
                <h3></h3>
                <p></p>
            </div>
        </div>
        <div class="users-list"></div>
    </div>
</div>

<div id="userTemplate" style="display: none;">
    <div class="user-item" data-user-email="">
        <div class="user-avatar"></div>
        <div class="user-info">
            <div class="user-name"></div>
            <div class="user-email"></div>
        </div>
        <div class="user-status"></div>
    </div>
</div>

<script>
class ChatHome {
    constructor() {
        this.departments = [
            {
                name: 'HR Department',
                icon: 'üë•',
                role: 'hr',
                description: 'Human Resources team'
            },
            {
                name: 'Manager Department',
                icon: 'üëî',
                role: 'manager',
                description: 'Management team'
            },
            {
                name: 'Recruiter Department',
                icon: 'üéØ',
                role: 'recruiter',
                description: 'Recruitment specialists'
            },
            {
                name: 'Cluster Department',
                icon: 'üè¢',
                role: 'cluster',
                description: 'Cluster administrators'
            },
            {
                name: 'Admin Department',
                icon: '‚öôÔ∏è',
                role: 'admin',
                description: 'System administrators'
            }
        ];
        
        this.init();
    }
    
    init() {
        this.loadDepartments();
    }
    
    async loadDepartments() {
        const departmentsGrid = document.getElementById('departmentsGrid');
        departmentsGrid.innerHTML = '<div class="loading-spinner"></div>';
        
        try {
            // Load users for each department
            const departmentsWithUsers = await Promise.all(
                this.departments.map(async (dept) => {
                    const users = await this.loadUsersByRole(dept.role);
                    return { ...dept, users };
                })
            );
            
            this.renderDepartments(departmentsWithUsers);
        } catch (error) {
            console.error('Error loading departments:', error);
            departmentsGrid.innerHTML = '<p>Error loading departments. Please try again.</p>';
        }
    }
    
    async loadUsersByRole(role) {
        try {
            const response = await fetch(`/api/chat/users?role=${role}`);
            const data = await response.json();
            
            if (data.success) {
                return data.users;
            }
            return [];
        } catch (error) {
            console.error(`Error loading ${role} users:`, error);
            return [];
        }
    }
    
    renderDepartments(departments) {
        const departmentsGrid = document.getElementById('departmentsGrid');
        departmentsGrid.innerHTML = '';
        
        departments.forEach(dept => {
            const deptElement = this.createDepartmentElement(dept);
            departmentsGrid.appendChild(deptElement);
        });
    }
    
    createDepartmentElement(department) {
        const template = document.getElementById('departmentTemplate');
        const element = template.cloneNode(true);
        element.style.display = 'block';
        element.id = '';
        element.dataset.department = department.role;
        
        const icon = element.querySelector('.department-icon');
        const name = element.querySelector('h3');
        const description = element.querySelector('p');
        const usersList = element.querySelector('.users-list');
        
        icon.textContent = department.icon;
        name.textContent = department.name;
        description.textContent = `${department.description} (${department.users.length} members)`;
        
        if (department.users.length === 0) {
            usersList.innerHTML = '<div class="empty-department">No users in this department</div>';
        } else {
            department.users.forEach(user => {
                const userElement = this.createUserElement(user);
                usersList.appendChild(userElement);
            });
        }
        
        return element;
    }
    
    createUserElement(user) {
        const template = document.getElementById('userTemplate');
        const element = template.cloneNode(true);
        element.style.display = 'flex';
        element.id = '';
        element.dataset.userEmail = user.email;
        
        const avatar = element.querySelector('.user-avatar');
        const name = element.querySelector('.user-name');
        const email = element.querySelector('.user-email');
        const status = element.querySelector('.user-status');
        
        avatar.textContent = user.name.charAt(0).toUpperCase();
        name.textContent = user.name;
        email.textContent = user.email;
        
        if (user.is_online) {
            status.classList.remove('offline');
        } else {
            status.classList.add('offline');
        }
        
        // Add click handler
        element.addEventListener('click', () => {
            this.startChatWithUser(user);
        });
        
        return element;
    }
    
    async startChatWithUser(user) {
        try {
            // Create or get conversation with this user
            const response = await fetch('/api/chat/conversations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    participants: [user.email],
                    type: 'direct'
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Redirect to chat interface with this conversation
                window.location.href = `/chat?conversation=${data.conversation_id}`;
            } else {
                alert('Failed to start chat. Please try again.');
            }
        } catch (error) {
            console.error('Error starting chat:', error);
            alert('Error starting chat. Please try again.');
        }
    }
}

function openAIChat() {
    // Redirect to chat interface with AI
    window.location.href = '/chat?ai=true';
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    window.chatHome = new ChatHome();
});
</script>
{% endblock %}
