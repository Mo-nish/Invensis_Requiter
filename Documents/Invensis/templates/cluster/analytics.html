{% extends "base.html" %}

{% block title %}Analytics - Cluster Dashboard{% endblock %}

{% block content %}
<style>
    .chart-container {
        position: relative;
        transition: all 0.3s ease;
    }
    
    .chart-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    @media (max-width: 768px) {
        .chart-container {
            height: 300px !important;
        }
    }
    
    @media (max-width: 480px) {
        .chart-container {
            height: 250px !important;
        }
    }
</style>

<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Analytics Dashboard</h1>
                <p class="text-gray-600">Comprehensive insights and performance metrics</p>
            </div>
            <a href="{{ url_for('cluster.dashboard') }}" 
               class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg btn-animate">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Status Distribution Chart -->
    <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Candidate Status Distribution</h2>
        <div class="h-64 chart-container">
            <canvas id="statusChart"></canvas>
        </div>
    </div>

    <!-- Monthly Trends Chart -->
    <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Monthly Candidate Trends</h2>
        <div class="h-80">
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>

    <!-- Manager Performance -->
    <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Manager Performance</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Manager
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Total Assigned
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Shortlisted
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Rejected
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Pending
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Success Rate
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for manager, stats in manager_stats.items() %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ manager }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ stats.total }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="text-green-600 font-medium">{{ stats.shortlisted }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="text-red-600 font-medium">{{ stats.rejected }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="text-yellow-600 font-medium">{{ stats.pending }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {% if stats.total > 0 %}
                                {% set success_rate = ((stats.shortlisted / stats.total) * 100) | round(1) %}
                                <span class="font-medium {% if success_rate >= 50 %}text-green-600{% elif success_rate >= 30 %}text-yellow-600{% else %}text-red-600{% endif %}">
                                    {{ success_rate }}%
                                </span>
                            {% else %}
                                <span class="text-gray-400">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Total Candidates -->
        <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-users text-blue-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Total Candidates</p>
                    <p class="text-2xl font-bold text-gray-900">
                        {{ status_counts.values() | sum }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Pending Candidates -->
        <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Pending</p>
                    <p class="text-2xl font-bold text-gray-900">
                        {{ status_counts.get('Pending', 0) }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Shortlisted Candidates -->
        <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check text-green-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Shortlisted</p>
                    <p class="text-2xl font-bold text-gray-900">
                        {{ status_counts.get('Shortlisted', 0) }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Rejected Candidates -->
        <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-times text-red-600"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500">Rejected</p>
                    <p class="text-2xl font-bold text-gray-900">
                        {{ status_counts.get('Rejected', 0) }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<!-- Chart data from server -->
<div id="chart-data" 
     data-status-labels='{{ status_counts.keys() | list | tojson }}'
     data-status-data='{{ status_counts.values() | list | tojson }}'
     data-monthly-labels='{{ monthly_data.keys() | list | tojson }}'
     data-monthly-data='{{ monthly_data.values() | list | tojson }}'
     style="display: none;"></div>

// Get chart data from hidden div
const chartDataElement = document.getElementById('chart-data');
const statusLabels = JSON.parse(chartDataElement.dataset.statusLabels);
const statusData = JSON.parse(chartDataElement.dataset.statusData);
const monthlyLabels = JSON.parse(chartDataElement.dataset.monthlyLabels);
const monthlyData = JSON.parse(chartDataElement.dataset.monthlyData);

// Status Distribution Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'bar',
    data: {
        labels: statusLabels,
        datasets: [{
            label: 'Candidates',
            data: statusData,
            backgroundColor: [
                '#3B82F6', // Blue - Pending
                '#10B981', // Green - Shortlisted
                '#EF4444', // Red - Rejected
                '#8B5CF6', // Purple - Assigned
                '#F59E0B'  // Yellow - On Hold
            ],
            borderColor: [
                '#2563EB', // Darker Blue
                '#059669', // Darker Green
                '#DC2626', // Darker Red
                '#7C3AED', // Darker Purple
                '#D97706'  // Darker Yellow
            ],
            borderWidth: 1,
            borderRadius: 4,
            borderSkipped: false
        }]
    },
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        animation: {
            duration: 1000,
            easing: 'easeInOutQuart'
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: '#3B82F6',
                borderWidth: 1,
                callbacks: {
                    label: function(context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                        return `${context.parsed} candidates (${percentage}%)`;
                    }
                }
            },
            datalabels: {
                color: '#ffffff',
                anchor: 'end',
                align: 'right',
                offset: 8,
                font: {
                    weight: 'bold',
                    size: 11
                },
                formatter: function(value) {
                    return value;
                }
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.1)',
                    drawBorder: false
                },
                ticks: {
                    color: '#6B7280',
                    font: {
                        size: 12
                    }
                }
            },
            y: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#374151',
                    font: {
                        size: 13,
                        weight: '500'
                    }
                }
            }
        }
    }
});

// Monthly Trends Chart
const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
const monthlyChart = new Chart(monthlyCtx, {
    type: 'line',
    data: {
        labels: monthlyLabels,
        datasets: [{
            label: 'Candidates Added',
            data: monthlyData,
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                position: 'top'
            }
        }
    }
});
</script>
{% endblock %} 