{% extends "base.html" %}

{% block title %}Recruiter Dashboard - Invensis Hiring Portal{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">HR Dashboard</h1>
                <p class="text-gray-600">Manage employee onboarding and lifecycle</p>
            </div>
            <div class="flex flex-wrap gap-4">
                <a href="{{ url_for('hr.onboarding') }}" class="btn-3d btn-hr px-6 py-3 text-lg font-semibold">
                    <i class="fas fa-user-check mr-2"></i>Onboarding Management
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Section - Candidate Counts -->
    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('all')">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-blue-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-users text-2xl text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-600 mb-2">All Candidates</p>
                    <p class="text-3xl font-bold text-gray-900" id="total-candidates">{{ all_candidates|length }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('Selected')">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-green-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-user-check text-2xl text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-600 mb-2">Selected</p>
                    <p class="text-3xl font-bold text-gray-900" id="selected-count">{{ all_candidates|selectattr('status', 'equalto', 'Selected')|list|length }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('Not Selected')">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-gradient-to-r from-red-500 to-red-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-user-times text-2xl text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-600 mb-2">Not Selected</p>
                    <p class="text-3xl font-bold text-gray-900" id="not-selected-count">{{ all_candidates|selectattr('status', 'equalto', 'Not Selected')|list|length }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('Reassigned')">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-gradient-to-r from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-exchange-alt text-2xl text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-600 mb-2">Reassigned</p>
                    <p class="text-3xl font-bold text-gray-900" id="reassigned-count">{{ all_candidates|selectattr('status', 'equalto', 'Reassigned')|list|length }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('Pending')">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-clock text-2xl text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-600 mb-2">Pending</p>
                    <p class="text-3xl font-bold text-gray-900" id="pending-count">{{ all_candidates|selectattr('status', 'equalto', 'Pending')|list|length }}</p>
            </div>
        </div>
    </div>

        <div class="bg-white rounded-xl shadow-lg p-6 fade-in cursor-pointer transform hover:scale-105 transition-all duration-300" onclick="filterByStatus('Assigned')">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-purple-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-user-clock text-2xl text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-600 mb-2">Assigned</p>
                    <p class="text-3xl font-bold text-gray-900" id="assigned-count">{{ all_candidates|selectattr('status', 'equalto', 'Assigned')|list|length }}</p>
                </div>
            </div>
        </div>
        </div>

    <!-- Add New Candidate Profile Section -->
    <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
        <div class="flex items-center mb-6">
            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-4 shadow-lg">
                <i class="fas fa-user-plus text-2xl text-white"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900">Add New Candidate Profile</h3>
        </div>
        
        <form id="candidateForm" enctype="multipart/form-data" class="space-y-4">
            <div class="grid grid-cols-2 gap-x-6 gap-y-2">
                <!-- Left Column -->
                <div class="flex flex-col space-y-1">
                    <div class="compact-form-field">
                        <label for="name" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-user mr-2 text-blue-500"></i>Full Name *
                        </label>
                        <input type="text" id="name" name="name" required 
                               class="w-full h-12 text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 px-3" 
                               placeholder="Enter full name">
                    </div>
                    
                    <div class="compact-form-field">
                        <label for="phone" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-phone mr-2 text-green-500"></i>Phone Number *
                        </label>
                        <input type="tel" id="phone" name="phone" required
                               class="w-full h-12 text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 px-3" 
                               placeholder="Enter phone number">
                            </div>
                            
                    <div class="compact-form-field">
                        <label for="dob" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-2 text-purple-500"></i>Date of Birth *
                        </label>
                        <input type="date" id="dob" name="dob" required
                               class="w-full h-12 text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 px-3">
                            </div>
                    
                    <div class="compact-form-field">
                        <label for="education" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-graduation-cap mr-2 text-yellow-500"></i>Education & Qualification *
                        </label>
                        <textarea id="education" name="education" required rows="3" 
                                  class="w-full text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 resize-none px-3 py-2" 
                                  placeholder="Enter educational background (degree, institution, year)"></textarea>
                        </div>
                        
                    <div class="compact-form-field">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-file-alt mr-2 text-red-500"></i>Upload Resume *
                        </label>
                        <div class="flex items-center space-x-3">
                            <input type="file" id="resume" name="resume" accept=".pdf,.doc,.docx" required 
                                   class="hidden">
                            <button type="button" onclick="document.getElementById('resume').click()" 
                                    class="btn-3d btn-hr px-6 py-3 text-sm font-semibold transform hover:scale-105 transition-all duration-300">
                                <i class="fas fa-upload mr-1"></i>Choose File
                            </button>
                            <button type="button" onclick="extractFromResume()" 
                                    class="btn-3d btn-manager px-6 py-3 text-sm font-semibold transform hover:scale-105 transition-all duration-300">
                                <i class="fas fa-magic mr-1"></i>Extract
                            </button>
                            <span id="resumeName" class="text-white text-sm font-medium"></span>
                        </div>
                        <div id="resumePreview" class="mt-2"></div>
                        <p class="text-xs text-blue-300 mt-1 font-medium">
                            <i class="fas fa-info-circle mr-1 text-blue-400"></i>
                            PDF, DOC, DOCX (Max 10MB)
                        </p>
                    </div>
                        </div>
                        
                <!-- Right Column -->
                <div class="flex flex-col space-y-1">
                    <div class="compact-form-field">
                        <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-envelope mr-2 text-blue-500"></i>Email Address *
                        </label>
                        <input type="email" id="email" name="email" required 
                               class="w-full h-12 text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 px-3" 
                               placeholder="Enter email address">
                        </div>
                        
                    <div class="compact-form-field">
                        <label for="gender" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-venus-mars mr-2 text-pink-500"></i>Gender Selection *
                        </label>
                        <div class="relative">
                                <select id="gender" name="gender" required
                                    class="w-full h-12 text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-pink-500 focus:ring-2 focus:ring-pink-200 transition-all duration-300 cursor-pointer hover:border-pink-400 px-3 appearance-none">
                                <option value="" class="text-gray-500 py-1">Select gender</option>
                                <option value="Male" class="text-gray-800 py-1 font-medium">Male</option>
                                <option value="Female" class="text-gray-800 py-1 font-medium">Female</option>
                                <option value="Non-Binary" class="text-gray-800 py-1 font-medium">Non-Binary</option>
                                <option value="Other" class="text-gray-800 py-1 font-medium">Other</option>
                                <option value="Prefer not to say" class="text-gray-800 py-1 font-medium">Prefer not to say</option>
                                </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-500 text-sm"></i>
                            </div>
                        </div>
                        <div class="mt-1 p-2 bg-pink-50 rounded border border-pink-200">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle mr-2 text-pink-500 text-xs"></i>
                                <span class="text-xs text-pink-600 font-medium">Please select the candidate's gender identity</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="compact-form-field">
                        <label for="skills" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-tools mr-2 text-green-500"></i>Skills & Technologies *
                        </label>
                        <input type="text" id="skills" name="skills" required 
                               class="w-full h-12 text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 px-3" 
                               placeholder="e.g., Python, SQL, JavaScript">
                    </div>
                    
                    <div class="compact-form-field">
                        <label for="experience" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-briefcase mr-2 text-orange-500"></i>Work Experience *
                        </label>
                        <textarea id="experience" name="experience" required rows="3" 
                                  class="w-full text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all duration-300 resize-none px-3 py-2" 
                                  placeholder="Enter work experience (company, role, duration)"></textarea>
                        </div>
                        
                    <div class="compact-form-field">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-camera mr-2 text-purple-500"></i>Upload Profile Photo
                        </label>
                        <div class="flex items-center space-x-3">
                            <input type="file" id="photo" name="photo" accept="image/*" 
                                   class="hidden">
                            <button type="button" onclick="document.getElementById('photo').click()" 
                                    class="btn-3d btn-cluster px-6 py-3 text-sm font-semibold transform hover:scale-105 transition-all duration-300">
                                <i class="fas fa-upload mr-1"></i>Choose File
                            </button>
                            <span id="photoName" class="text-white text-sm font-medium"></span>
                        </div>
                        <div id="photoPreview" class="mt-2"></div>
                        <p class="text-xs text-purple-300 mt-1 font-medium">
                            <i class="fas fa-info-circle mr-1 text-purple-400"></i>
                            JPG, PNG, GIF (Max 5MB)
                        </p>
                        </div>
                    </div>
                </div>
                
            <!-- Compact Candidate Rating System -->
            <div class="mt-6 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <div class="text-center mb-4">
                    <div class="inline-flex items-center justify-center w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full mb-2 shadow-lg">
                        <i class="fas fa-star text-lg text-white"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900">Candidate Assessment & Rating</h3>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <!-- Communication Skills -->
                        <div class="compact-rating-field">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-comments mr-2 text-blue-500"></i>Communication Skills *
                            </label>
                            <div class="star-rating compact" data-field="communication_skills">
                                <span class="star" data-rating="1">○</span>
                                <span class="star" data-rating="2">○</span>
                                <span class="star" data-rating="3">○</span>
                                <span class="star" data-rating="4">○</span>
                                <span class="star" data-rating="5">○</span>
                            </div>
                            <input type="hidden" id="communication_skills" name="communication_skills" value="0">
                    </div>
                    
                        <!-- Adaptability -->
                        <div class="compact-rating-field">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-sync-alt mr-2 text-green-500"></i>Adaptability & Flexibility *
                            </label>
                            <div class="star-rating compact" data-field="adaptability">
                                <span class="star" data-rating="1">○</span>
                                <span class="star" data-rating="2">○</span>
                                <span class="star" data-rating="3">○</span>
                                <span class="star" data-rating="4">○</span>
                                <span class="star" data-rating="5">○</span>
                    </div>
                            <input type="hidden" id="adaptability" name="adaptability" value="0">
                </div>
                
                        <!-- Teamwork -->
                        <div class="compact-rating-field">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-users mr-2 text-blue-500"></i>Teamwork & Collaboration *
                            </label>
                            <div class="star-rating compact" data-field="teamwork_collaboration">
                                <span class="star" data-rating="1">○</span>
                                <span class="star" data-rating="2">○</span>
                                <span class="star" data-rating="3">○</span>
                                <span class="star" data-rating="4">○</span>
                                <span class="star" data-rating="5">○</span>
                            </div>
                            <input type="hidden" id="teamwork_collaboration" name="teamwork_collaboration" value="0">
                        </div>
                        
                        <!-- Job Fit -->
                        <div class="compact-rating-field">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-briefcase mr-2 text-orange-500"></i>Perfect Fit for Job *
                            </label>
                            <div class="star-rating compact" data-field="job_fit">
                                <span class="star" data-rating="1">○</span>
                                <span class="star" data-rating="2">○</span>
                                <span class="star" data-rating="3">○</span>
                                <span class="star" data-rating="4">○</span>
                                <span class="star" data-rating="5">○</span>
                            </div>
                            <input type="hidden" id="job_fit" name="job_fit" value="0">
                        </div>
                </div>
                
                <!-- Overall Rating & Notes Row -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                            <!-- Overall Rating -->
                        <div class="compact-rating-field">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-robot mr-2 text-pink-500"></i>Overall Rating
                            </label>
                            <div class="overall-rating-display compact">
                                <div class="text-2xl font-bold text-pink-500" id="overall_rating_display">--</div>
                            </div>
                            <input type="hidden" id="overall_rating" name="overall_rating" value="0">
                            </div>
                            
                        <!-- Other Notes -->
                        <div class="compact-rating-field md:col-span-2">
                            <label for="other_notes" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-sticky-note mr-2 text-yellow-500"></i>Additional Notes
                            </label>
                            <textarea id="other_notes" name="other_notes" rows="2" 
                                      class="w-full text-sm text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 transition-all duration-300 resize-none px-3 py-2" 
                                      placeholder="Additional comments..."></textarea>
                            </div>
                        </div>
                        
                <!-- AI Info Bar -->
                <div class="mt-3 p-3 bg-blue-50 rounded border border-blue-200">
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-blue-600 font-medium">
                            <i class="fas fa-brain mr-1"></i>AI calculates overall rating automatically
                        </span>
                        <div class="flex space-x-2">
                            <button type="button" onclick="calculateOverallRating()" 
                                    class="btn-3d btn-manager px-3 py-1 text-xs font-semibold transform hover:scale-105 transition-all duration-300">
                                <i class="fas fa-calculator mr-1"></i>Calculate
                            </button>
                            <button type="button" onclick="saveRatings()" 
                                    class="btn-3d btn-hr px-3 py-1 text-xs font-semibold transform hover:scale-105 transition-all duration-300">
                                <i class="fas fa-save mr-1"></i>Save Ratings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Extraction Status -->
            <div id="extractionStatus" class="mt-4 p-4 bg-white/10 backdrop-blur-sm rounded-xl border border-white/20"></div>
            
            <!-- Detailed Extraction Results -->
            <div id="extractionResults" class="mt-6 hidden">
                <div class="bg-gradient-to-r from-green-500/20 to-blue-500/20 backdrop-blur-sm rounded-xl border border-green-300/30 p-6">
                    <div class="text-center mb-6">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-green-500 rounded-full mb-4">
                            <i class="fas fa-check text-2xl text-white"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-green-600 mb-2">Resume Parsed Successfully!</h3>
                        <div class="inline-flex items-center px-4 py-2 bg-blue-500/20 rounded-full border border-blue-300/30">
                            <i class="fas fa-robot text-blue-400 mr-2"></i>
                            <span class="text-blue-600 font-semibold" id="parsingMethod">AI-Powered (GPT-3.5)</span>
                        </div>
                            </div>
                            
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left Column -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3">Extraction Results:</h4>
                            <div id="extractionFields" class="space-y-3">
                                <!-- Fields will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div class="space-y-4">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3">Field Verification:</h4>
                            <div id="verificationFields" class="space-y-3">
                                <!-- Verification will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                    <div class="text-center mt-6">
                        <button type="button" onclick="hideExtractionResults()" 
                                class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                            <i class="fas fa-times mr-2"></i>Close Results
                    </button>
                </div>
                </div>
        </div>

            <!-- Form Action Buttons -->
            <div class="flex flex-wrap justify-center gap-4 pt-4">
                <button type="submit" class="btn-3d btn-hr px-8 py-3 text-lg font-bold transform hover:scale-105 transition-all duration-300">
                        <i class="fas fa-plus mr-2"></i>Add Candidate
                    </button>
                <button type="button" onclick="clearForm()" class="btn-3d btn-cluster px-8 py-3 text-lg font-bold transform hover:scale-105 transition-all duration-300">
                    <i class="fas fa-refresh mr-2"></i>Clear Form
                </button>
                <button type="button" onclick="resetRatings()" class="btn-3d btn-manager px-8 py-3 text-lg font-bold transform hover:scale-105 transition-all duration-300">
                    <i class="fas fa-star mr-2"></i>Reset Ratings
                    </button>
                </div>
            </form>
        </div>

    <!-- Candidate List -->
    <div class="bg-white rounded-xl shadow-lg p-8">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-users text-2xl text-white"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900">Candidate List</h3>
            </div>
            
            <!-- Search and Filter Controls -->
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <input type="text" id="searchCandidates" 
                           class="w-64 px-4 py-2 pl-10 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="Search candidates...">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                </div>
                </div>
                
                <select id="statusFilter" 
                        class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Status</option>
                    <option value="Pending">Pending</option>
                        <option value="Assigned">Assigned</option>
                    <option value="Selected">Selected</option>
                    <option value="Not Selected">Not Selected</option>
                    <option value="Reassigned">Reassigned</option>
                    </select>
                </div>
            </div>
            
        <div id="candidateList" class="space-y-4">
            {% if all_candidates %}
                        {% for candidate in all_candidates %}
            <div class="bg-gray-50 rounded-xl p-6 border border-gray-200 hover:bg-gray-100 transition-all duration-300 candidate-item transform hover:scale-102" data-status="{{ candidate.status }}" data-candidate-id="{{ candidate._id }}">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="flex items-center space-x-4 mb-4 sm:mb-0">
                        <div class="w-20 h-20 bg-gradient-to-r from-purple-400 to-blue-400 rounded-full flex items-center justify-center shadow-lg">
                            {% if candidate.image_path and candidate.image_path != '' %}
                            <img src="{{ url_for('static', filename=candidate.image_path) }}" 
                                 alt="{{ candidate.first_name }} {{ candidate.last_name }}" 
                                 class="w-20 h-20 rounded-full object-cover"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <i class="fas fa-user text-3xl text-white" style="display: none;"></i>
                                    {% else %}
                            <i class="fas fa-user text-3xl text-white"></i>
                                    {% endif %}
                                </div>
                        <div>
                            <h4 class="text-xl font-bold text-gray-900 mb-2">{{ candidate.first_name }} {{ candidate.last_name }}</h4>
                            <p class="text-base mb-2 text-blue-600">
                                <i class="fas fa-envelope mr-2 text-blue-500"></i>{{ candidate.email }}
                            </p>
                            <p class="text-base mb-3 text-green-600">
                                <i class="fas fa-phone mr-2 text-green-500"></i>{{ candidate.phone }}
                            </p>
                            <div class="flex items-center space-x-3">
                                <span class="px-3 py-1 text-sm font-semibold rounded-full bg-blue-100 text-blue-800">
                                    {{ candidate.status }}
                                            </span>
                                {% if candidate.assigned_manager_id %}
                                <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    <i class="fas fa-user-check mr-1"></i>Assigned
                                </span>
                                    {% endif %}
                                </div>
                                </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-3">
                        <button onclick="viewCandidate('{{ candidate._id }}')" 
                                class="btn-3d btn-hr px-6 py-3 text-lg font-semibold transform hover:scale-105 transition-all duration-300">
                            <i class="fas fa-eye mr-2"></i>View
                                    </button>
                        
                        {% if candidate.status == 'Pending' %}
                        <button onclick="assignCandidate('{{ candidate._id }}')" 
                                class="btn-3d btn-manager px-6 py-3 text-lg font-semibold transform hover:scale-105 transition-all duration-300">
                            <i class="fas fa-user-plus mr-2"></i>Assign
                                    </button>
                                    {% endif %}
                                </div>
            </div>
            </div>
                {% endfor %}
            {% else %}
                <div class="text-center py-8">
                    <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-users text-2xl text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">No Candidates Yet</h3>
                    <p class="text-gray-500">Start by adding your first candidate using the form above.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Assign Candidate Modal -->
<div id="assignModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">Assign Candidate to Manager</h3>
            <button onclick="hideAssignModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="assignForm">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Candidate</label>
                    <p id="candidateName" class="text-gray-900 font-medium"></p>
                </div>
                
                <div>
                    <label for="managerEmail" class="block text-sm font-medium text-gray-700 mb-2">Manager Email *</label>
                    <input type="email" id="managerEmail" name="manager_email" placeholder="Enter Manager Email" required
                           class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="interviewTime" class="block text-sm font-medium text-gray-700 mb-2">Interview Date & Time *</label>
                    <input type="datetime-local" id="interviewTime" name="interview_time" required
                           class="block w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="flex space-x-3">
                    <button type="submit" 
                            class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg btn-animate">
                        <i class="fas fa-paper-plane mr-2"></i>Assign
                    </button>
                    <button type="button" onclick="hideAssignModal()"
                            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 px-4 rounded-lg btn-animate">
                        Cancel
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Bulk Action Bar -->
<div id="bulk-action-bar" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white rounded-lg shadow-lg border border-gray-200 px-6 py-3 hidden z-50">
    <div class="flex items-center space-x-4">
        <span id="selected-count" class="text-sm font-medium text-gray-700">0 selected</span>
        <div class="flex items-center space-x-2">
            <button onclick="bulkMove('Selected')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i class="fas fa-check mr-1"></i>Select
            </button>
            <button onclick="bulkMove('Not Selected')" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i class="fas fa-times mr-1"></i>Not Select
            </button>
            <button onclick="bulkMove('Reassigned')" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i class="fas fa-exchange-alt mr-1"></i>Reassign
            </button>
        </div>
        <button onclick="clearSelection()" class="text-gray-500 hover:text-gray-700 text-sm font-medium">
            <i class="fas fa-times mr-1"></i>Clear
        </button>
    </div>
</div>

<!-- Bulk Action Confirmation Modal -->
<div id="bulkActionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-900" id="modalTitle">Confirm Action</h3>
            </div>
            <p class="text-gray-600 mb-6" id="modalMessage">
                Are you sure you want to perform this action on the selected candidates?
            </p>
            <div class="flex justify-end space-x-3">
                <button onclick="closeBulkActionModal()" 
                        class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button onclick="confirmBulkAction()" 
                        class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700" id="confirmButton">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentCandidateId = null;

// Add CSS styles for star rating system
const style = document.createElement('style');
style.textContent = `
    .star-rating {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .star-rating.compact {
        gap: 4px;
    }
    
    .star {
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #6b7280;
        user-select: none;
    }
    
    .star:hover {
        transform: scale(1.2);
        color: #fbbf24;
    }
    
    .star.active {
        color: #fbbf24;
    }
    
    .star.filled {
        color: #fbbf24;
    }
    
    .rating-field {
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid rgba(209, 213, 219, 0.5);
    }
    
    .compact-rating-field {
        background: rgba(255, 255, 255, 0.9);
        padding: 12px;
        border-radius: 8px;
        border: 1px solid rgba(209, 213, 219, 0.5);
    }
    
    .overall-rating-display {
        text-align: center;
        padding: 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        border: 1px solid rgba(209, 213, 219, 0.5);
    }
    
    .overall-rating-display.compact {
        text-align: center;
        padding: 8px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        border: 1px solid rgba(209, 213, 219, 0.5);
    }
    
    .star-rating.compact .star {
        font-size: 18px;
        gap: 4px;
    }
    
    .compact-form-field {
        background: rgba(255, 255, 255, 0.9);
        padding: 8px;
        border-radius: 8px;
        border: 1px solid rgba(209, 213, 219, 0.5);
    }
`;
document.head.appendChild(style);

// File preview function
function previewFile(input, previewId) {
    const preview = document.getElementById(previewId);
    if (!preview) {
        console.warn(`Preview element with ID '${previewId}' not found`);
        return;
    }
    
    const file = input.files[0];
    
    if (file) {
        if (file.type.startsWith('image/')) {
            // Image preview
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" class="w-20 h-20 object-cover rounded-lg border">`;
            };
            reader.readAsDataURL(file);
        } else {
            // Document preview
            preview.innerHTML = `<div class="p-3 bg-gray-100 rounded-lg border">
                <i class="fas fa-file-alt text-gray-600 mr-2"></i>
                <span class="text-sm text-gray-700">${file.name}</span>
                <br><span class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</span>
            </div>`;
        }
    } else {
        preview.innerHTML = '';
    }
}

// Function to check if all form fields exist
function checkFormFields() {
    const requiredFields = ['name', 'email', 'phone', 'dob', 'gender', 'skills', 'education', 'experience'];
    let allFieldsExist = true;
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field) {
            console.error(`Field ${fieldId} not found in DOM`);
            allFieldsExist = false;
        }
    });
    
    if (allFieldsExist) {
        console.log('All required form fields found');
    } else {
        console.error('Some required form fields are missing');
    }
    
    return allFieldsExist;
}

// Resume parsing function
function extractFromResume() {
    const resumeFile = document.getElementById('resume').files[0];
    const statusDiv = document.getElementById('extractionStatus');
    
    if (!resumeFile) {
        statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Please upload a resume first.</div>';
        return;
    }
    
    // Check if all form fields exist
    if (!checkFormFields()) {
        statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Form fields not found. Please refresh the page.</div>';
        return;
    }
    
    statusDiv.innerHTML = '<div class="text-blue-600"><i class="fas fa-spinner fa-spin mr-2"></i>Extracting information from resume...</div>';
    
    const formData = new FormData();
    formData.append('resume', resumeFile);
    
    fetch('{{ url_for("hr.parse_resume") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('=== RESUME EXTRACTION RESPONSE ===');
        console.log('Complete response data:', data);
        console.log('Data structure:', JSON.stringify(data, null, 2));
        console.log('Data.data object:', data.data);
        console.log('Data.data keys:', Object.keys(data.data || {}));
        console.log('=== END RESPONSE DATA ===');
        
        if (data.success) {
            console.log('Extracted data:', data.data);
            console.log('Parsing method:', data.parsing_method);
            console.log('Data type:', typeof data.data);
            console.log('Data keys:', Object.keys(data.data));
            
            // Check if data.data exists and has the expected structure
            if (!data.data || typeof data.data !== 'object') {
                console.error('Invalid data structure received:', data);
                statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Invalid data structure received from server.</div>';
                return;
            }
            
            // Resume parsing successful - proceed with new enhanced display

            try {
                // Populate form fields with extracted data
                console.log('Populating form fields...');
                populateFormFields(data.data);
                console.log('Form fields populated successfully');
                
                // Show the beautiful extraction results display
                console.log('Showing extraction results...');
                showExtractionResults(data.data, data.parsing_method);
                console.log('Extraction results displayed successfully');
                
                // Hide the simple status and show detailed results
                statusDiv.style.display = 'none';
                document.getElementById('extractionResults').classList.remove('hidden');
                console.log('UI updated successfully');
            } catch (error) {
                console.error('Error in extraction display:', error);
                statusDiv.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Error displaying results: ${error.message}</div>`;
            }
            
            // Verify all fields are populated correctly
            setTimeout(() => {
                verifyFieldPopulation();
                // Also try to manually trigger a visual update
                forceFieldUpdate();
                
                // Retry population after a longer delay to ensure DOM is ready
                setTimeout(() => {
                    console.log('Retrying field population...');
                    retryFieldPopulation(data.data);
                }, 500);
            }, 100);
            
        } else {
            statusDiv.innerHTML = `<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>${data.message}</div>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        statusDiv.innerHTML = '<div class="text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>Failed to extract information. Please enter manually.</div>';
    });
}

// Function to verify that extracted fields are properly populated
function verifyFieldPopulation() {
    const fields = ['name', 'email', 'phone', 'dob', 'gender', 'skills', 'education', 'experience'];
    let verificationResults = '<div class="text-sm text-gray-600 mt-2"><strong>Field Verification:</strong><br>';
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        const value = field ? field.value.trim() : '';
        if (value) {
            verificationResults += `✅ ${fieldId.charAt(0).toUpperCase() + fieldId.slice(1)}: "${value}"<br>`;
        } else {
            verificationResults += `❌ ${fieldId.charAt(0).toUpperCase() + fieldId.slice(1)}: Empty<br>`;
        }
    });
    
    verificationResults += '</div>';
    
    // Append verification results to status div
    const statusDiv = document.getElementById('extractionStatus');
    statusDiv.innerHTML += verificationResults;
}

// Function to force field updates
function forceFieldUpdate() {
    console.log('Forcing field updates...');
    const fields = ['name', 'email', 'phone', 'dob', 'gender', 'skills', 'education', 'experience'];
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            // Trigger input event to ensure the field updates visually
            field.dispatchEvent(new Event('input', { bubbles: true }));
            field.dispatchEvent(new Event('change', { bubbles: true }));
            console.log(`Field ${fieldId} updated, current value:`, field.value);
        } else {
            console.error(`Field ${fieldId} not found`);
        }
    });
}

// Function to retry field population
function retryFieldPopulation(data) {
    console.log('Retrying field population with data:', data);
    
    const fieldMappings = {
        'name': data.name,
        'email': data.email,
        'phone': data.phone,
        'dob': data.dob,
        'gender': data.gender,
        'skills': Array.isArray(data.skills) ? data.skills.join(', ') : data.skills,
        'education': data.education,
        'experience': data.experience
    };
    
    Object.entries(fieldMappings).forEach(([fieldId, value]) => {
        if (value && value.trim()) {
            const field = document.getElementById(fieldId);
            if (field) {
                if (fieldId === 'gender' && field.tagName === 'SELECT') {
                    // Special handling for gender select field
                    console.log('Retry: Handling gender select field');
                    let optionFound = false;
                    
                    // Try exact match
                    for (let option of field.options) {
                        if (option.value.toLowerCase() === value.trim().toLowerCase()) {
                            option.selected = true;
                            optionFound = true;
                            console.log('Retry: Exact gender match found:', option.value);
                            break;
                        }
                    }
                    
                    // Try partial match if no exact match
                    if (!optionFound) {
                        for (let option of field.options) {
                            if (value.trim().toLowerCase().includes(option.value.toLowerCase()) || 
                                option.value.toLowerCase().includes(value.trim().toLowerCase())) {
                                option.selected = true;
                                optionFound = true;
                                console.log('Retry: Partial gender match found:', option.value);
                                break;
                            }
                        }
                    }
                    
                    // Trigger change event
                    field.dispatchEvent(new Event('change', { bubbles: true }));
                    
                    // Add visual feedback
                    field.style.backgroundColor = '#e8f5e8';
                    field.style.borderColor = '#4caf50';
                    
                } else {
                    // Standard field population
                    field.value = value.trim();
                    console.log(`Retry: Field ${fieldId} populated with:`, value.trim());
                    
                    // Add visual feedback for populated fields
                    if (fieldId !== 'gender') {
                        field.style.backgroundColor = '#e8f5e8';
                        field.style.borderColor = '#4caf50';
                    }
                }
            } else {
                console.error(`Retry: Field ${fieldId} not found`);
            }
        }
    });
}

// Clear form function
function clearForm() {
    document.getElementById('candidateForm').reset();
    document.getElementById('photoPreview').innerHTML = '';
    document.getElementById('resumePreview').innerHTML = '';
    document.getElementById('extractionStatus').innerHTML = '';
    
    // Also hide the extraction results and show the status div
    const statusDiv = document.getElementById('extractionStatus');
    const resultsDiv = document.getElementById('extractionResults');
    
    statusDiv.style.display = 'block';
    resultsDiv.classList.add('hidden');
    
    // Reset all ratings
    resetRatings();
}

// Function to populate form fields with extracted data
function populateFormFields(data) {
    try {
        console.log('populateFormFields called with data:', data);
        
        const fieldMappings = {
            'name': data.name,
            'email': data.email,
            'phone': data.phone,
            'dob': data.dob,
            'gender': data.gender,
            'skills': Array.isArray(data.skills) ? data.skills.join(', ') : data.skills,
            'education': data.education,
            'experience': data.experience
        };
        
        console.log('Field mappings:', fieldMappings);
        
        Object.entries(fieldMappings).forEach(([fieldId, value]) => {
            console.log(`Processing field ${fieldId} with value:`, value);
            if (value && value.trim()) {
                const field = document.getElementById(fieldId);
                if (field) {
                    console.log(`Field ${fieldId} found, setting value:`, value.trim());
                    if (fieldId === 'gender' && field.tagName === 'SELECT') {
                        // Special handling for gender select field
                        let optionFound = false;
                        for (let option of field.options) {
                            if (option.value.toLowerCase() === value.trim().toLowerCase()) {
                                option.selected = true;
                                optionFound = true;
                                console.log(`Gender option selected: ${option.value}`);
                                break;
                            }
                        }
                        if (optionFound) {
                            field.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    } else {
                        field.value = value.trim();
                    }
                    
                    // Add visual feedback
                    field.style.backgroundColor = '#e8f5e8';
                    field.style.borderColor = '#4caf50';
                    console.log(`Field ${fieldId} populated successfully`);
                } else {
                    console.warn(`Field ${fieldId} not found in DOM`);
                }
            } else {
                console.log(`Field ${fieldId} has no value or empty value:`, value);
            }
        });
        
        console.log('populateFormFields completed successfully');
    } catch (error) {
        console.error('Error in populateFormFields:', error);
        throw error;
    }
}

// Function to filter candidates by status
function filterByStatus(status) {
    console.log('Filtering by status:', status);
    try {
        const candidateItems = document.querySelectorAll('.candidate-item');
        console.log('Found candidate items:', candidateItems.length);
        
        candidateItems.forEach(item => {
            if (status === 'all' || item.getAttribute('data-status') === status) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
        
        // Update active filter indicator
        const allFilters = document.querySelectorAll('.bg-white.rounded-xl.shadow-lg');
        allFilters.forEach(filter => filter.classList.remove('ring-4', 'ring-blue-400'));
        
        if (status !== 'all') {
            const activeFilter = document.querySelector(`[onclick="filterByStatus('${status}')"]`);
            if (activeFilter) {
                activeFilter.classList.add('ring-4', 'ring-blue-400');
            }
        }
        
        console.log('Filter applied successfully');
    } catch (error) {
        console.error('Error in filterByStatus:', error);
    }
}

// Star Rating System Functions
function initializeStarRatings() {
    const starRatings = document.querySelectorAll('.star-rating');
    
    starRatings.forEach(ratingContainer => {
        const stars = ratingContainer.querySelectorAll('.star');
        const fieldName = ratingContainer.getAttribute('data-field');
        const hiddenInput = document.getElementById(fieldName);
        
        stars.forEach((star, index) => {
            star.addEventListener('click', () => {
                const rating = index + 1;
                
                // Update visual stars
                stars.forEach((s, i) => {
                    if (i < rating) {
                        s.textContent = '★';
                        s.classList.add('filled');
                    } else {
                        s.textContent = '○';
                        s.classList.remove('filled');
                    }
                });
                
                // Update hidden input
                if (hiddenInput) {
                    hiddenInput.value = rating;
                }
                
                // Auto-calculate overall rating
                setTimeout(calculateOverallRating, 100);
            });
            
            // Hover effects
            star.addEventListener('mouseenter', () => {
                const hoverRating = index + 1;
                stars.forEach((s, i) => {
                    if (i < hoverRating) {
                        s.style.color = '#fbbf24';
                    } else {
                        s.style.color = '#6b7280';
                    }
                });
            });
            
            star.addEventListener('mouseleave', () => {
                const currentRating = parseInt(hiddenInput?.value || '0');
                stars.forEach((s, i) => {
                    if (i < currentRating) {
                        s.style.color = '#fbbf24';
                    } else {
                        s.style.color = '#6b7280';
                    }
                });
            });
        });
    });
}

// Calculate overall rating using AI-like algorithm
function calculateOverallRating() {
    const ratings = {
        communication: parseInt(document.getElementById('communication_skills')?.value || '0'),
        adaptability: parseInt(document.getElementById('adaptability')?.value || '0'),
        teamwork: parseInt(document.getElementById('teamwork_collaboration')?.value || '0'),
        jobFit: parseInt(document.getElementById('job_fit')?.value || '0')
    };
    
    // Check if all ratings are provided
    const allRated = Object.values(ratings).every(rating => rating > 0);
    
    if (!allRated) {
        document.getElementById('overall_rating_display').textContent = '--';
        document.getElementById('overall_rating').value = '0';
        return;
    }
    
    // AI-like weighted calculation
    let overallScore = 0;
    let totalWeight = 0;
    
    // Communication skills (weight: 25%)
    overallScore += ratings.communication * 0.25;
    totalWeight += 0.25;
    
    // Adaptability (weight: 20%)
    overallScore += ratings.adaptability * 0.20;
    totalWeight += 0.20;
    
    // Teamwork & Collaboration (weight: 25%)
    overallScore += ratings.teamwork * 0.25;
    totalWeight += 0.25;
    
    // Job Fit (weight: 30%)
    overallScore += ratings.jobFit * 0.30;
    totalWeight += 0.30;
    
    // Calculate final score
    const finalScore = Math.round(overallScore / totalWeight * 10) / 10;
    
    // Update display
    const displayElement = document.getElementById('overall_rating_display');
    const hiddenInput = document.getElementById('overall_rating');
    
    if (displayElement && hiddenInput) {
        displayElement.textContent = finalScore.toFixed(1);
        hiddenInput.value = finalScore;
        
        // Add color coding based on score
        if (finalScore >= 4.5) {
            displayElement.className = 'text-3xl font-bold text-green-400 mb-2';
        } else if (finalScore >= 3.5) {
            displayElement.className = 'text-3xl font-bold text-yellow-400 mb-2';
        } else {
            displayElement.className = 'text-3xl font-bold text-red-400 mb-2';
        }
    }
    
    console.log('Overall rating calculated:', finalScore);
    return finalScore;
}

// Reset all ratings
function resetRatings() {
    const starRatings = document.querySelectorAll('.star-rating');
    const hiddenInputs = ['communication_skills', 'adaptability', 'teamwork_collaboration', 'job_fit', 'overall_rating'];
    
    starRatings.forEach(ratingContainer => {
        const stars = ratingContainer.querySelectorAll('.star');
        stars.forEach(star => {
            star.textContent = '○';
            star.classList.remove('filled');
            star.style.color = '#6b7280';
        });
    });
    
    hiddenInputs.forEach(fieldId => {
        const input = document.getElementById(fieldId);
        if (input) input.value = '0';
    });
    
    const overallDisplay = document.getElementById('overall_rating_display');
    if (overallDisplay) {
        overallDisplay.textContent = '--';
        overallDisplay.className = 'text-3xl font-bold text-pink-400 mb-2';
    }
}

// Save ratings to backend
function saveRatings() {
    // First calculate the overall rating
    const overallRating = calculateOverallRating();
    
    // Get all rating values
    const ratingData = {
        communication_skills: document.getElementById('communication_skills')?.value || '0',
        adaptability: document.getElementById('adaptability')?.value || '0',
        teamwork_collaboration: document.getElementById('teamwork_collaboration')?.value || '0',
        job_fit: document.getElementById('job_fit')?.value || '0',
        overall_rating: overallRating || '0',
        other_notes: document.getElementById('other_notes')?.value || ''
    };
    
    // Check if we have a candidate ID (for existing candidates)
    const urlParams = new URLSearchParams(window.location.search);
    const candidateId = urlParams.get('candidate_id') || 
                       document.querySelector('[data-candidate-id]')?.dataset.candidateId;
    
    if (candidateId) {
        // Update existing candidate ratings
        updateCandidateRatings(candidateId, ratingData);
    } else {
        // For new candidates, the ratings will be saved when the form is submitted
        console.log('Ratings will be saved with candidate form submission');
        return true;
    }
}

// Update candidate ratings in backend
function updateCandidateRatings(candidateId, ratingData) {
    // Create form data
    const formData = new FormData();
    Object.keys(ratingData).forEach(key => {
        formData.append(key, ratingData[key]);
    });
    
    // Send AJAX request to update ratings
    fetch(`/hr/update_candidate_ratings/${candidateId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showNotification('Ratings updated successfully!', 'success');
            console.log('Ratings updated:', data.message);
        } else {
            // Show error message
            showNotification('Error updating ratings: ' + data.message, 'error');
            console.error('Error updating ratings:', data.message);
        }
    })
    .catch(error => {
        console.error('Error updating ratings:', error);
        showNotification('Error updating ratings. Please try again.', 'error');
    });
}

// Show notification
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// Function to show detailed extraction results
function showExtractionResults(data, parsingMethod) {
    try {
        console.log('showExtractionResults called with data:', data, 'parsingMethod:', parsingMethod);
        
        const extractionFields = document.getElementById('extractionFields');
        const verificationFields = document.getElementById('verificationFields');
        
        console.log('extractionFields element:', extractionFields);
        console.log('verificationFields element:', verificationFields);
        
        if (!extractionFields || !verificationFields) {
            throw new Error('Required DOM elements not found: extractionFields or verificationFields');
        }
        
        // Update parsing method display
        const parsingMethodElement = document.getElementById('parsingMethod');
        if (parsingMethod && parsingMethodElement) {
            parsingMethodElement.textContent = parsingMethod;
            console.log('Parsing method updated:', parsingMethod);
        }
        
        // Build extraction results
        let extractionHTML = '';
        const fields = [
            { key: 'name', label: 'Name' },
            { key: 'email', label: 'Email' },
            { key: 'phone', label: 'Phone' },
            { key: 'dob', label: 'Date of Birth' },
            { key: 'gender', label: 'Gender' },
            { key: 'skills', label: 'Skills' },
            { key: 'education', label: 'Education' },
            { key: 'experience', label: 'Experience' }
        ];
        
        fields.forEach(field => {
            const value = data[field.key];
            if (value && value.trim()) {
                let displayValue = Array.isArray(value) ? value.join(', ') : value;
                if (field.key === 'experience' && displayValue.length > 100) {
                    displayValue = displayValue.substring(0, 100) + '...';
                }
                extractionHTML += `
                    <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg border border-green-200">
                        <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-white text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-green-700">${field.label} extracted:</div>
                            <div class="text-sm text-green-600">${displayValue}</div>
                        </div>
                    </div>
                `;
            } else {
                extractionHTML += `
                    <div class="flex items-center space-x-3 p-3 bg-red-50 rounded-lg border border-red-200">
                        <div class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-times text-white text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-red-700">${field.label} not found in resume, please enter manually</div>
                        </div>
                    </div>
                `;
            }
        });
        
        // Build verification results
        let verificationHTML = '';
        fields.forEach(field => {
            const fieldElement = document.getElementById(field.key);
            const value = fieldElement ? fieldElement.value.trim() : '';
            if (value) {
                let displayValue = value;
                if (field.key === 'experience' && displayValue.length > 100) {
                    displayValue = displayValue.substring(0, 100) + '...';
                }
                verificationHTML += `
                    <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg border border-green-200">
                        <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-white text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-green-700">${field.label}:</div>
                            <div class="text-sm text-green-600">"${displayValue}"</div>
                        </div>
                    </div>
                `;
            } else {
                verificationHTML += `
                    <div class="flex items-center space-x-3 p-3 bg-red-50 rounded-full flex items-center justify-center">
                        <div class="w-6 h-6 bg-red-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-times text-white text-xs"></i>
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-red-700">${field.label}:</div>
                            <div class="text-sm text-red-600">Empty</div>
                        </div>
                    </div>
                `;
            }
        });
        
        extractionFields.innerHTML = extractionHTML;
        verificationFields.innerHTML = verificationHTML;
        
        console.log('showExtractionResults completed successfully');
    } catch (error) {
        console.error('Error in showExtractionResults:', error);
    }
}

// Function to hide extraction results
function hideExtractionResults() {
    const statusDiv = document.getElementById('extractionStatus');
    const resultsDiv = document.getElementById('extractionResults');
    
    statusDiv.style.display = 'block';
    resultsDiv.classList.add('hidden');
    
    // Clear the status div
    statusDiv.innerHTML = '';
}

// Add event listener for candidate form submission
const candidateForm = document.getElementById('candidateForm');
if (candidateForm) {
    candidateForm.addEventListener('submit', function(e) {
    e.preventDefault();
        console.log('Form submission started');
    
    const formData = new FormData(this);
        
        // Debug: log form data
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }
    
    fetch('{{ url_for("hr.add_candidate") }}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
            console.log('Response received:', response);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
            console.log('Data received:', data);
        if (data.success) {
            alert(`Candidate added successfully! Reference ID: ${data.reference_id}`);
            this.reset();
                document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('resumePreview').innerHTML = '';
                document.getElementById('extractionStatus').innerHTML = '';
            // Update the candidate list dynamically instead of reloading
            updateCandidateList();
        } else {
            alert(data.message || 'An error occurred while adding the candidate.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding the candidate. Please try again.');
    });
});
}

function showAssignModal(candidateId, candidateName) {
    currentCandidateId = candidateId;
    document.getElementById('candidateName').textContent = candidateName;
    document.getElementById('assignModal').classList.remove('hidden');
    document.getElementById('assignModal').classList.add('flex');
}

function hideAssignModal() {
    document.getElementById('assignModal').classList.add('hidden');
    document.getElementById('assignModal').classList.remove('flex');
    document.getElementById('assignForm').reset();
    currentCandidateId = null;
}

// Add event listener for assign form submission
const assignForm = document.getElementById('assignForm');
if (assignForm) {
    assignForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    formData.append('candidate_id', currentCandidateId);
    
    fetch('{{ url_for("hr.assign_candidate") }}', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(data.message);
            updateCandidateList();
        } else {
            alert(data.message || 'An error occurred while assigning the candidate.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while assigning the candidate. Please try again.');
    });
    
    hideAssignModal();
});
}

// Search and filter functionality
function filterCandidates() {
    const searchCandidates = document.getElementById('searchCandidates');
    const statusFilter = document.getElementById('statusFilter');
    
    if (!searchCandidates || !statusFilter) {
        console.warn('Search or filter elements not found');
        return;
    }
    
    const searchTerm = searchCandidates.value.toLowerCase();
    const statusFilterValue = statusFilter.value;
    const rows = document.querySelectorAll('.candidate-item');
    
    if (rows.length === 0) {
        console.log('No candidate items found to filter');
        return;
    }
    
    rows.forEach(row => {
        const nameElement = row.querySelector('h4');
        const emailElement = row.querySelector('p:nth-child(2)');
        
        if (!nameElement || !emailElement) {
            console.warn('Required elements not found in candidate row');
            return;
        }
        
        const name = nameElement.textContent.toLowerCase();
        const email = emailElement.textContent.toLowerCase();
        const status = row.getAttribute('data-status');
        
        const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
        const matchesStatus = !statusFilterValue || status === statusFilterValue;
        
        if (matchesSearch && matchesStatus) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    console.log(`Filtered ${rows.length} candidates - Search: "${searchTerm}", Status: "${statusFilterValue}"`);
}

// Real-time search - only add event listeners if elements exist
document.addEventListener('DOMContentLoaded', function() {
    const searchCandidates = document.getElementById('searchCandidates');
    const statusFilter = document.getElementById('statusFilter');

    if (searchCandidates) {
        searchCandidates.addEventListener('input', filterCandidates);
    }
    if (statusFilter) {
        statusFilter.addEventListener('change', filterCandidates);
    }
});

// Auto-refresh mechanism
let autoRefreshInterval;
function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
        try {
        updateCandidateList();
        updateStatistics();
        } catch (error) {
            console.warn('Auto-refresh error:', error);
        }
    }, 30000); // Refresh every 30 seconds
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Start auto-refresh when candidate list tab is shown
function showTab(tabName) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.tab-content');
    if (tabContents.length > 0) {
    tabContents.forEach(content => {
        content.style.display = 'none';
    });
    }
    
    // Remove active class from all tab buttons
    const tabButtons = document.querySelectorAll('.tab-button');
    if (tabButtons.length > 0) {
    tabButtons.forEach(button => {
        button.classList.remove('bg-blue-600', 'text-white');
        button.classList.add('bg-gray-200', 'text-gray-700');
    });
    }
    
    // Show selected tab content
    const selectedTab = document.getElementById(tabName);
    if (selectedTab) {
        selectedTab.style.display = 'block';
    }
    
    // Add active class to selected tab button
    const selectedButton = document.querySelector(`[onclick="showTab('${tabName}')"]`);
    if (selectedButton) {
        selectedButton.classList.remove('bg-gray-200', 'text-gray-700');
        selectedButton.classList.add('bg-blue-600', 'text-white');
    }
    
    // Start/stop auto-refresh based on tab
    if (tabName === 'candidates-list-tab') {
        const candidateItems = document.querySelectorAll('.candidate-item');
        if (candidateItems.length > 0) {
        startAutoRefresh();
        } else {
            console.log('No candidates found, skipping auto-refresh');
        }
    } else {
        stopAutoRefresh();
    }
}

// Function to update candidate list dynamically
function updateCandidateList() {
    // Show loading indicator
    const candidateListContainer = document.querySelector('#candidateList');
    if (candidateListContainer) {
        candidateListContainer.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-500"></i><p class="mt-2 text-gray-600">Updating candidate list...</p></div>';
    }
    
    // Fetch updated candidate list with proper error handling
    fetch('{{ url_for("hr.dashboard") }}', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text();
    })
    .then(html => {
        // Create a temporary div to parse the HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Extract the candidate list table - look for the actual table content
        const newCandidateList = tempDiv.querySelector('#candidateList');
        
        if (newCandidateList && candidateListContainer) {
            // Check if we actually got candidate data
            const candidateItems = newCandidateList.querySelectorAll('.candidate-item');
            if (candidateItems.length > 0) {
            candidateListContainer.innerHTML = newCandidateList.innerHTML;
                console.log(`Successfully updated candidate list with ${candidateItems.length} candidates`);
            } else {
                // No candidates found, show appropriate message
                candidateListContainer.innerHTML = '<div class="text-center py-8"><i class="fas fa-users text-2xl text-gray-400"></i><p class="mt-2 text-gray-600">No candidates found</p></div>';
            }
        } else {
            // Fallback: try to find the table directly
            const table = tempDiv.querySelector('table');
            if (table && candidateListContainer) {
                candidateListContainer.innerHTML = table.outerHTML;
                console.log('Updated candidate list using fallback method');
            } else {
                throw new Error('Could not find candidate list in response');
            }
        }
        
        // Update statistics
        updateStatistics();
        
        // Hide loading state
        const loadingSpinner = candidateListContainer.querySelector('.text-center.py-8');
        if (loadingSpinner) {
            loadingSpinner.remove();
        }
    })
    .catch(error => {
        console.error('Error updating candidate list:', error);
        
        // Show error message and hide loading spinner
        if (candidateListContainer) {
            candidateListContainer.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                    <p class="mt-2 text-red-600">Failed to update candidate list</p>
                    <p class="text-sm text-gray-500">${error.message}</p>
                    <button onclick="updateCandidateList()" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-redo mr-2"></i>Try Again
                    </button>
                </div>
            `;
        }
    });
}

// Function to update statistics
function updateStatistics() {
    fetch('{{ url_for("hr.dashboard") }}', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        // Create a temporary div to parse the HTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = html;
        
        // Update candidate statistics from the fetched HTML
        const totalElement = tempDiv.querySelector('#total-candidates');
        const selectedElement = tempDiv.querySelector('#selected-count');
        const notSelectedElement = tempDiv.querySelector('#not-selected-count');
        const reassignedElement = tempDiv.querySelector('#reassigned-count');
        const pendingElement = tempDiv.querySelector('#pending-count');
        const assignedElement = tempDiv.querySelector('#assigned-count');
        
        // Update candidate statistics safely
        const totalElementTarget = document.getElementById('total-candidates');
        const selectedElementTarget = document.getElementById('selected-count');
        const notSelectedElementTarget = document.getElementById('not-selected-count');
        const reassignedElementTarget = document.getElementById('reassigned-count');
        const pendingElementTarget = document.getElementById('pending-count');
        const assignedElementTarget = document.getElementById('assigned-count');
        
        // Update candidate statistics safely
        if (totalElement && totalElementTarget) totalElementTarget.textContent = totalElement.textContent || '0';
        if (selectedElement && selectedElementTarget) selectedElementTarget.textContent = selectedElement.textContent || '0';
        if (notSelectedElement && notSelectedElementTarget) notSelectedElementTarget.textContent = notSelectedElement.textContent || '0';
        if (reassignedElement && reassignedElementTarget) reassignedElementTarget.textContent = reassignedElement.textContent || '0';
        if (pendingElement && pendingElementTarget) pendingElementTarget.textContent = pendingElement.textContent || '0';
        if (assignedElement && assignedElementTarget) assignedElementTarget.textContent = assignedElement.textContent || '0';
        
        console.log('Candidate statistics updated successfully');
    })
    .catch(error => {
        console.error('Error updating statistics:', error);
        // Don't show error to user for statistics updates
    });
}

// Select Mode Functionality
let currentBulkAction = null;
let currentBulkActionType = null;

// Initialize select mode functionality
function initializeSelectMode() {
    const selectAllCheckbox = document.getElementById('select-all');
    const selectItems = document.querySelectorAll('.select-item');
    
    // Select all functionality
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            selectItems.forEach(cb => {
                cb.checked = this.checked;
            });
            updateBulkActionBar();
        });
    }
    
    // Individual checkbox functionality - only add listeners if checkboxes exist
    if (selectItems.length > 0) {
        selectItems.forEach(cb => {
            cb.addEventListener('change', function() {
                updateBulkActionBar();
                updateSelectAllCheckbox();
            });
        });
    }
}

// Update bulk action bar visibility and count
function updateBulkActionBar() {
    const selected = document.querySelectorAll('.select-item:checked');
    const bulkActionBar = document.getElementById('bulk-action-bar');
    const selectedCount = document.getElementById('selected-count');
    
    if (selectedCount) {
        selectedCount.textContent = `${selected.length} selected`;
    }
    
    if (bulkActionBar) {
        bulkActionBar.classList.toggle('hidden', selected.length === 0);
    }
}

// Update select all checkbox state
function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('select-all');
    const selectItems = document.querySelectorAll('.select-item');
    const checkedItems = document.querySelectorAll('.select-item:checked');
    
    if (selectAllCheckbox) {
        if (checkedItems.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedItems.length === selectItems.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }
}

// Clear all selections
function clearSelection() {
    const selectAllCheckbox = document.getElementById('select-all');
    const selectItems = document.querySelectorAll('.select-item');
    
    selectItems.forEach(cb => cb.checked = false);
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
    updateBulkActionBar();
}

// Bulk move functionality
function bulkMove(status) {
    const selected = document.querySelectorAll('.select-item:checked');
    if (selected.length === 0) return;
    
    currentBulkAction = 'move';
    currentBulkActionType = status;
    
    const statusText = status === 'Selected' ? 'select' : 
                      status === 'Not Selected' ? 'mark as not selected' : 
                      status === 'Reassigned' ? 'reassign' : status.toLowerCase();
    
    showBulkActionModal(
        `Confirm ${status}`,
        `Are you sure you want to ${statusText} ${selected.length} candidate(s)?`
    );
}

// Show bulk action modal
function showBulkActionModal(title, message) {
    const modal = document.getElementById('bulkActionModal');
    const modalTitle = modal.querySelector('h3');
    const modalMessage = modal.querySelector('p');
    
    if (modalTitle) modalTitle.textContent = title;
    if (modalMessage) modalMessage.textContent = message;
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// Close bulk action modal
function closeBulkActionModal() {
    const modal = document.getElementById('bulkActionModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Confirm bulk action
function confirmBulkAction() {
    if (currentBulkAction === 'move' && currentBulkActionType) {
        const selected = document.querySelectorAll('.select-item:checked');
        const candidateIds = Array.from(selected).map(cb => cb.value);
        
        // Here you would implement the actual bulk action
        console.log(`Bulk action: ${currentBulkActionType} for candidates:`, candidateIds);
        
        // Close modal and clear selection
        closeBulkActionModal();
        clearSelection();
        
        // Refresh candidate list
        updateCandidateList();
    }
}

// View candidate function
function viewCandidate(candidateId) {
    console.log('Viewing candidate:', candidateId);
    // Redirect to candidate details page
    window.location.href = `/hr/candidate/${candidateId}`;
}

// Assign candidate function
function assignCandidate(candidateId) {
    console.log('Assigning candidate:', candidateId);
    currentCandidateId = candidateId;
    
    // Get candidate name for display
    const candidateCard = document.querySelector(`[data-candidate-id="${candidateId}"]`);
    let candidateName = 'Candidate';
    if (candidateCard) {
        const nameElement = candidateCard.querySelector('.text-lg.font-semibold');
        if (nameElement) {
            candidateName = nameElement.textContent.trim();
        }
    }
    
    // Update modal with candidate name
    const candidateNameElement = document.getElementById('candidateName');
    if (candidateNameElement) {
        candidateNameElement.textContent = candidateName;
    }
    
    // Show assign modal
    const modal = document.getElementById('assignModal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// Hide assign modal
function hideAssignModal() {
    const modal = document.getElementById('assignModal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

// Handle assign form submission
document.addEventListener('DOMContentLoaded', function() {
    const assignForm = document.getElementById('assignForm');
    if (assignForm) {
        assignForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const managerEmail = document.getElementById('managerEmail').value;
            const interviewTime = document.getElementById('interviewTime').value;
            
            if (!managerEmail || !interviewTime) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Here you would implement the actual assignment logic
            console.log('Assigning candidate:', currentCandidateId);
            console.log('Manager email:', managerEmail);
            console.log('Interview time:', interviewTime);
            
            // For now, just close the modal
            hideAssignModal();
            
            // You can add AJAX call here to actually assign the candidate
            alert('Candidate assigned successfully!');
        });
    }
    
    // Initialize select mode
    initializeSelectMode();
    
    // Check form fields on page load
    checkFormFields();
    
    // Add file input event listeners for resume and photo
    const resumeInput = document.getElementById('resume');
    const photoInput = document.getElementById('photo');
    
    if (resumeInput) {
        resumeInput.addEventListener('change', function() {
            const fileName = this.files[0] ? this.files[0].name : '';
            const resumeName = document.getElementById('resumeName');
            if (resumeName) {
                resumeName.textContent = fileName;
            }
            if (fileName) {
                previewFile(this, 'resumePreview');
            }
        });
    }
    
    if (photoInput) {
        photoInput.addEventListener('change', function() {
            const fileName = this.files[0] ? this.files[0].name : '';
            const photoName = document.getElementById('photoName');
            if (photoName) {
                photoName.textContent = fileName;
            }
            if (fileName) {
                previewFile(this, 'photoPreview');
            }
        });
    }
    
    // Initialize star rating system
    initializeStarRatings();
});

// Global flags to track Chart.js loading and canvas issues
let chartJsLoaded = false;
let chartJsLoading = false;
let forceSimplifiedMode = false; // Force fallback if canvas issues persist

// 3D Data Visualization Functions
function openDataVisualization() {
    const modal = document.getElementById('dataVisualizationModal');
    if (modal) {
        console.log('Opening data visualization modal...');
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        
        // Ensure the overview tab is visible by default
        switchAnalyticsTab('overview');
        
        // Load Chart.js first, then load analytics data
        loadChartJsLibrary().then(() => {
            console.log('Chart.js loaded successfully, waiting for DOM to be ready...');
            setTimeout(() => {
                console.log('Starting analytics data load...');
                loadAnalyticsData();
                showNotification('Loading analytics data...', 'info');
            }, 500); // Increased delay to ensure DOM is ready
        }).catch(error => {
            console.error('Failed to load Chart.js:', error);
            showNotification('Chart library failed to load. Using fallback display.', 'error');
            loadAnalyticsDataWithFallback();
        });
    } else {
        console.error('Data visualization modal not found!');
    }
}

// Function to dynamically load Chart.js
function loadChartJsLibrary() {
    return new Promise((resolve, reject) => {
        // If already loaded, resolve immediately
        if (chartJsLoaded && typeof Chart !== 'undefined') {
            resolve();
            return;
        }
        
        // If currently loading, wait for it
        if (chartJsLoading) {
            const checkLoaded = setInterval(() => {
                if (chartJsLoaded && typeof Chart !== 'undefined') {
                    clearInterval(checkLoaded);
                    resolve();
                } else if (!chartJsLoading) {
                    clearInterval(checkLoaded);
                    reject(new Error('Chart.js loading failed'));
                }
            }, 100);
            return;
        }
        
        chartJsLoading = true;
        console.log('Loading Chart.js library...');
        
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js';
        
        script.onload = () => {
            console.log('Chart.js loaded successfully');
            chartJsLoaded = true;
            chartJsLoading = false;
            resolve();
        };
        
        script.onerror = () => {
            console.log('Primary CDN failed, trying fallback...');
            // Try fallback CDN
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js';
            
            fallbackScript.onload = () => {
                console.log('Chart.js loaded from fallback CDN');
                chartJsLoaded = true;
                chartJsLoading = false;
                resolve();
            };
            
            fallbackScript.onerror = () => {
                console.error('Both Chart.js CDNs failed');
                chartJsLoading = false;
                reject(new Error('Failed to load Chart.js from any CDN'));
            };
            
            document.head.appendChild(fallbackScript);
        };
        
        document.head.appendChild(script);
    });
}

function closeDataVisualization() {
    const modal = document.getElementById('dataVisualizationModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }
}

function switchAnalyticsTab(tabName) {
    // Hide all tab contents
    const tabs = ['overview', 'trends', 'performance', 'reports'];
    tabs.forEach(tab => {
        const content = document.getElementById(`${tab}Tab`);
        const button = document.getElementById(`${tab}Button`);
        if (content) content.classList.add('hidden');
        if (button) {
            button.classList.remove('bg-blue-600', 'text-white');
            button.classList.add('bg-gray-200', 'text-gray-700');
        }
    });
    
    // Show selected tab
    const selectedTab = document.getElementById(`${tabName}Tab`);
    const selectedButton = document.getElementById(`${tabName}Button`);
    if (selectedTab) selectedTab.classList.remove('hidden');
    if (selectedButton) {
        selectedButton.classList.remove('bg-gray-200', 'text-gray-700');
        selectedButton.classList.add('bg-blue-600', 'text-white');
    }
    
    // Load data for specific tab
    loadTabData(tabName);
}

async function loadAnalyticsData() {
    try {
        console.log('Loading analytics data...');
        
        // Debug: Check what canvas elements are available
        const canvases = document.querySelectorAll('canvas');
        console.log('Available canvas elements:', canvases.length);
        canvases.forEach(canvas => {
            console.log('Canvas ID:', canvas.id);
        });
        
        // Load default overview tab
        switchAnalyticsTab('overview');
    } catch (error) {
        console.error('Error loading analytics data:', error);
        showNotification('Error loading analytics data', 'error');
    }
}

function loadAnalyticsDataWithFallback() {
    try {
        console.log('Loading analytics data with fallback...');
        
        // Load overview tab with text-based fallback
        switchAnalyticsTab('overview');
        
        // Replace charts with text summaries
        setTimeout(() => {
            createFallbackCharts();
        }, 500);
        
    } catch (error) {
        console.error('Error loading fallback analytics:', error);
        showNotification('Error loading analytics', 'error');
    }
}

function createFallbackCharts() {
    // Replace chart containers with simple text-based summaries
    const statusChartContainer = document.getElementById('statusChart')?.parentElement;
    if (statusChartContainer) {
        statusChartContainer.innerHTML = `
            <div class="text-center p-8">
                <h4 class="text-lg font-semibold mb-4">Candidate Status Summary</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-green-100 p-4 rounded">
                        <div class="text-2xl font-bold text-green-800">1</div>
                        <div class="text-green-600">Selected</div>
                    </div>
                    <div class="bg-red-100 p-4 rounded">
                        <div class="text-2xl font-bold text-red-800">1</div>
                        <div class="text-red-600">Not Selected</div>
                    </div>
                    <div class="bg-blue-100 p-4 rounded">
                        <div class="text-2xl font-bold text-blue-800">1</div>
                        <div class="text-blue-600">Assigned</div>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded">
                        <div class="text-2xl font-bold text-yellow-800">0</div>
                        <div class="text-yellow-600">Pending</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    const monthlyChartContainer = document.getElementById('monthlyChart')?.parentElement;
    if (monthlyChartContainer) {
        monthlyChartContainer.innerHTML = `
            <div class="text-center p-8">
                <h4 class="text-lg font-semibold mb-4">Monthly Activity</h4>
                <div class="text-gray-600">
                    <p>Current month: 3 candidates added</p>
                    <p>Last month: 2 candidates processed</p>
                    <p>Success rate: 33%</p>
                </div>
            </div>
        `;
    }
    
    showNotification('Analytics loaded in simplified mode', 'info');
}

function ensureCanvasElements(tabName) {
    const requiredCanvases = {
        'overview': ['statusChart', 'monthlyChart'],
        'trends': ['trendChart', 'successChart'],
        'performance': ['hrChart', 'responseChart'],
        'reports': ['departmentChart', 'experienceChart']
    };
    
    const canvasIds = requiredCanvases[tabName] || [];
    console.log(`Ensuring canvas elements for ${tabName} tab:`, canvasIds);
    
    // Ensure modal is visible and tab is active
    const modal = document.getElementById('dataVisualizationModal');
    const tabContent = document.getElementById(`${tabName}Tab`);
    
    if (!modal || modal.style.display === 'none' || modal.classList.contains('hidden')) {
        console.error(`Modal not visible when checking canvas elements for ${tabName}`);
        return false;
    }
    
    if (!tabContent || tabContent.classList.contains('hidden')) {
        console.error(`Tab content not visible for ${tabName}`);
        return false;
    }
    
    let allFound = true;
    
    for (const canvasId of canvasIds) {
        let canvas = document.getElementById(canvasId);
        
        if (!canvas) {
            console.warn(`Canvas ${canvasId} not found, attempting to create it...`);
            
            // Try multiple strategies to create the canvas
            
            // Strategy 1: Look for exact canvas element in HTML
            const existingCanvas = tabContent.querySelector(`canvas[id="${canvasId}"]`);
            if (existingCanvas) {
                console.log(`✅ Found existing canvas ${canvasId} in DOM`);
                canvas = existingCanvas;
            } else {
                // Strategy 2: Look for chart-container divs
                const chartContainers = tabContent.querySelectorAll('.chart-container');
                let targetContainer = null;
                
                // Match container by position (statusChart = first, monthlyChart = second, etc.)
                const canvasOrder = ['statusChart', 'monthlyChart', 'trendChart', 'successChart', 'hrChart', 'responseChart', 'departmentChart', 'experienceChart'];
                const canvasIndex = canvasOrder.indexOf(canvasId);
                
                if (canvasIndex !== -1 && chartContainers[canvasIndex % chartContainers.length]) {
                    targetContainer = chartContainers[canvasIndex % chartContainers.length];
                } else {
                    // Fallback: use first available container
                    targetContainer = chartContainers[0];
                }
                
                if (targetContainer) {
                    // Create the canvas element
                    canvas = document.createElement('canvas');
                    canvas.id = canvasId;
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    
                    // Clear the container and add the canvas
                    targetContainer.innerHTML = '';
                    targetContainer.appendChild(canvas);
                    
                    console.log(`✅ Created canvas ${canvasId} dynamically in container`);
                } else {
                    // Strategy 3: Create container and canvas from scratch
                    const newContainer = document.createElement('div');
                    newContainer.className = 'chart-container';
                    newContainer.style.height = '300px';
                    
                    canvas = document.createElement('canvas');
                    canvas.id = canvasId;
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    
                    newContainer.appendChild(canvas);
                    tabContent.appendChild(newContainer);
                    
                    console.log(`✅ Created new container and canvas ${canvasId} from scratch`);
                }
            }
        } else {
            console.log(`✅ Canvas ${canvasId} found`);
        }
    }
    
    if (allFound) {
        console.log(`✅ All canvas elements ready for ${tabName} tab`);
        return true;
    } else {
        console.error(`❌ Failed to ensure all canvas elements for ${tabName}`);
        return false;
    }
}

function renderFallbackCharts(tabName, data) {
    console.log(`Rendering fallback charts for ${tabName}`);
    
    const statusCounts = data?.status_counts || {'Selected': 1, 'Not Selected': 1, 'Assigned': 1};
    
    switch(tabName) {
        case 'overview':
            renderFallbackOverview(statusCounts);
            break;
        case 'trends':
            renderFallbackTrends();
            break;
        case 'performance':
            renderFallbackPerformance();
            break;
        case 'reports':
            renderFallbackReports();
            break;
    }
}

function renderFallbackOverview(statusCounts) {
    const statusContainer = document.querySelector('#statusChart')?.parentElement;
    if (statusContainer) {
        statusContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Candidate Status Distribution</h4>
                <div class="grid grid-cols-2 gap-3">
                    ${Object.entries(statusCounts).map(([status, count]) => {
                        const colors = {
                            'Selected': 'bg-green-100 text-green-800',
                            'Not Selected': 'bg-red-100 text-red-800',
                            'Pending': 'bg-yellow-100 text-yellow-800',
                            'Assigned': 'bg-blue-100 text-blue-800',
                            'Reassigned': 'bg-purple-100 text-purple-800'
                        };
                        const colorClass = colors[status] || 'bg-gray-100 text-gray-800';
                        return `
                            <div class="${colorClass} p-3 rounded-lg">
                                <div class="text-xl font-bold">${count}</div>
                                <div class="text-sm">${status}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    const monthlyContainer = document.querySelector('#monthlyChart')?.parentElement;
    if (monthlyContainer) {
        monthlyContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Monthly Activity Summary</h4>
                <div class="text-gray-600 space-y-2">
                    <p><span class="font-semibold">Current month:</span> ${Object.values(statusCounts).reduce((a, b) => a + b, 0)} candidates</p>
                    <p><span class="font-semibold">Last month:</span> 2 candidates processed</p>
                    <p><span class="font-semibold">Success rate:</span> ${Math.round((statusCounts['Selected'] || 0) / Object.values(statusCounts).reduce((a, b) => a + b, 1) * 100)}%</p>
                </div>
            </div>
        `;
    }
}

function renderFallbackTrends() {
    const trendContainer = document.querySelector('#trendChart')?.parentElement;
    if (trendContainer) {
        trendContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Application Trends</h4>
                <div class="text-gray-600">
                    <p>📈 Applications: Steady growth</p>
                    <p>✅ Selections: 33% success rate</p>
                    <p>📊 Weekly average: 4-5 candidates</p>
                </div>
            </div>
        `;
    }
    
    const successContainer = document.querySelector('#successChart')?.parentElement;
    if (successContainer) {
        successContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Success Rate Trends</h4>
                <div class="text-gray-600">
                    <p>🎯 Current rate: 33%</p>
                    <p>📈 Trend: Improving</p>
                    <p>🏆 Target: 40%</p>
                </div>
            </div>
        `;
    }
}

function renderFallbackPerformance() {
    const hrContainer = document.querySelector('#hrChart')?.parentElement;
    if (hrContainer) {
        hrContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Recruiter Team Performance</h4>
                <div class="text-gray-600">
                    <p>👥 Active Recruiters: 2</p>
                    <p>📊 Avg candidates/Recruiter: 1.5</p>
                    <p>⭐ Performance: Good</p>
                </div>
            </div>
        `;
    }
    
    const responseContainer = document.querySelector('#responseChart')?.parentElement;
    if (responseContainer) {
        responseContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Response Time</h4>
                <div class="text-gray-600">
                    <p>⏱️ Average: 2.1 hours</p>
                    <p>🚀 Fastest: 1.5 hours</p>
                    <p>📈 Trend: Improving</p>
                </div>
            </div>
        `;
    }
}

function renderFallbackReports() {
    const departmentContainer = document.querySelector('#departmentChart')?.parentElement;
    if (departmentContainer) {
        departmentContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Department Distribution</h4>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div class="bg-purple-100 text-purple-800 p-2 rounded">Engineering: 35%</div>
                    <div class="bg-green-100 text-green-800 p-2 rounded">Marketing: 20%</div>
                    <div class="bg-yellow-100 text-yellow-800 p-2 rounded">Sales: 15%</div>
                    <div class="bg-blue-100 text-blue-800 p-2 rounded">Others: 30%</div>
                </div>
            </div>
        `;
    }
    
    const experienceContainer = document.querySelector('#experienceChart')?.parentElement;
    if (experienceContainer) {
        experienceContainer.innerHTML = `
            <div class="text-center p-6">
                <h4 class="text-lg font-semibold mb-4">Experience Distribution</h4>
                <div class="text-gray-600 space-y-1">
                    <p>🔰 0-1 years: 12 candidates</p>
                    <p>📈 1-3 years: 25 candidates</p>
                    <p>⭐ 3-5 years: 18 candidates</p>
                    <p>🏆 5+ years: 15 candidates</p>
                </div>
            </div>
        `;
    }
}

async function loadTabData(tabName) {
    try {
        showChartLoading(tabName);
        
        const response = await fetch(`/hr/analytics/${tabName}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`Received data for ${tabName}:`, data);
        
        if (!data.success) {
            throw new Error(data.message || 'Failed to load data');
        }
        
        // Wait for the DOM to be ready
        setTimeout(() => {
            console.log(`Processing data for ${tabName} tab after DOM ready delay...`);
            
            // Verify tab container exists
            const tabContainer = document.getElementById(`${tabName}Tab`);
            if (!tabContainer) {
                console.error(`Tab container ${tabName}Tab not found`);
                hideChartLoading(tabName);
                return;
            }
            console.log(`✅ Tab container found for ${tabName}`);
            
            // Check if we should force simplified mode due to previous failures
            if (forceSimplifiedMode) {
                console.log('Forcing simplified mode due to previous canvas issues');
                renderFallbackCharts(tabName, data);
                hideChartLoading(tabName);
                showNotification(`${tabName.charAt(0).toUpperCase() + tabName.slice(1)} loaded (simplified mode)`, 'info');
                return;
            }
            
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js library not available, using fallback');
                forceSimplifiedMode = true; // Set flag to prevent future attempts
                renderFallbackCharts(tabName, data);
                hideChartLoading(tabName);
                showNotification(`${tabName.charAt(0).toUpperCase() + tabName.slice(1)} loaded (simplified mode)`, 'info');
                return;
            }
            console.log(`✅ Chart.js library is available`);
            
            // Try to ensure canvas elements, but proceed with fallback if fails
            const canvasReady = ensureCanvasElements(tabName);
            if (!canvasReady) {
                console.warn(`Canvas elements not ready for ${tabName}, switching to simplified mode permanently`);
                forceSimplifiedMode = true; // Set flag to prevent future attempts
                renderFallbackCharts(tabName, data);
                hideChartLoading(tabName);
                showNotification(`${tabName.charAt(0).toUpperCase() + tabName.slice(1)} loaded (simplified mode)`, 'info');
                return;
            }
            
            try {
                switch(tabName) {
                    case 'overview':
                        renderOverviewCharts(data);
                        break;
                    case 'trends':
                        renderTrendCharts(data);
                        break;
                    case 'performance':
                        renderPerformanceCharts(data);
                        break;
                    case 'reports':
                        renderReportCharts(data);
                        break;
                }
                
                hideChartLoading(tabName);
                showNotification(`${tabName.charAt(0).toUpperCase() + tabName.slice(1)} data loaded successfully`, 'success');
            } catch (error) {
                console.error(`Error rendering ${tabName} charts:`, error);
                renderFallbackCharts(tabName, data);
                hideChartLoading(tabName);
                showNotification(`${tabName.charAt(0).toUpperCase() + tabName.slice(1)} loaded (simplified mode)`, 'info');
            }
        }, 1000);
    } catch (error) {
        console.error(`Error loading ${tabName} data:`, error);
        hideChartLoading(tabName);
        showNotification(`Error loading ${tabName} data: ${error.message}`, 'error');
        
        // Show fallback charts with sample data
        switch(tabName) {
            case 'overview':
                renderOverviewCharts({success: true, status_counts: {}, monthly_data: {}});
                break;
            case 'trends':
                renderTrendCharts({success: true});
                break;
            case 'performance':
                renderPerformanceCharts({success: true, hr_performance: []});
                break;
            case 'reports':
                renderReportCharts({success: true});
                break;
        }
    }
}

function showChartLoading(tabName) {
    const containers = document.querySelectorAll(`#${tabName}Tab .chart-container`);
    containers.forEach(container => {
        container.innerHTML = `
            <div class="flex items-center justify-center h-64">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading chart data...</p>
                </div>
            </div>
        `;
    });
}

function hideChartLoading(tabName) {
    // Chart loading is hidden when actual charts are rendered
    console.log(`Hiding loading for tab: ${tabName}`);
}

function renderOverviewCharts(data) {
    console.log('Rendering overview charts with data:', data);
    
    // Status Distribution Pie Chart
    const statusCounts = data.status_counts || {};
    const statusLabels = Object.keys(statusCounts).length > 0 ? Object.keys(statusCounts) : ['Selected', 'Not Selected', 'Pending', 'Assigned'];
    const statusData = Object.keys(statusCounts).length > 0 ? Object.values(statusCounts) : [15, 8, 12, 25];
    const statusColors = ['#10B981', '#EF4444', '#F59E0B', '#3B82F6', '#8B5CF6', '#F97316'];
    
    renderPieChart('statusChart', {
        labels: statusLabels,
        data: statusData,
        colors: statusColors.slice(0, statusLabels.length)
    });
    
    // Monthly Candidates Bar Chart
    const monthlyData = data.monthly_data || {};
    const monthLabels = Object.keys(monthlyData).length > 0 ? Object.keys(monthlyData) : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
    const monthValues = Object.keys(monthlyData).length > 0 ? Object.values(monthlyData) : [12, 19, 15, 25, 22, 30];
    
    renderBarChart('monthlyChart', {
        labels: monthLabels,
        datasets: [{
            label: 'Candidates Added',
            data: monthValues,
            backgroundColor: 'rgba(59, 130, 246, 0.8)'
        }]
    });
    
    // Update metric cards with real data
    const totalCandidates = data.total_candidates || 0;
    const selectedCount = statusCounts['Selected'] || 0;
    const pendingCount = statusCounts['Pending'] || 0;
    const successRate = totalCandidates > 0 ? Math.round((selectedCount / totalCandidates) * 100) : 0;
    
    // Update metric displays
    document.getElementById('totalCandidatesMetric').textContent = totalCandidates;
    document.getElementById('selectedMetric').textContent = selectedCount;
    document.getElementById('pendingMetric').textContent = pendingCount;
    document.getElementById('successRateMetric').textContent = `${successRate}%`;
}

function renderTrendCharts(data) {
    // Trend Line Chart
    renderLineChart('trendChart', {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
        datasets: [{
            label: 'Applications Received',
            data: [10, 15, 12, 18],
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)'
        }, {
            label: 'Selections Made',
            data: [3, 5, 4, 7],
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)'
        }]
    });
    
    // Success Rate Chart
    renderLineChart('successChart', {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
        datasets: [{
            label: 'Success Rate %',
            data: [25, 30, 28, 35, 32, 40],
            borderColor: '#F59E0B',
            backgroundColor: 'rgba(245, 158, 11, 0.1)'
        }]
    });
}

function renderPerformanceCharts(data) {
    // HR Performance Comparison
    const hrPerformance = data.hr_performance || [];
    const hrNames = hrPerformance.length > 0 ? hrPerformance.map(hr => hr.name) : ['John Smith', 'Sarah Johnson', 'Mike Davis'];
    const candidatesAdded = hrPerformance.length > 0 ? hrPerformance.map(hr => hr.candidates_added) : [25, 30, 20];
    const successfulPlacements = hrPerformance.length > 0 ? hrPerformance.map(hr => hr.successful_placements) : [8, 12, 6];
    
    renderBarChart('hrChart', {
        labels: hrNames,
        datasets: [{
            label: 'Candidates Added',
            data: candidatesAdded,
            backgroundColor: 'rgba(99, 102, 241, 0.8)'
        }, {
            label: 'Successful Placements',
            data: successfulPlacements,
            backgroundColor: 'rgba(16, 185, 129, 0.8)'
        }]
    });
    
    // Response Time Chart
    const responseTimes = data.response_times || [2.5, 1.8, 3.2, 2.1, 1.5];
    renderLineChart('responseChart', {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
        datasets: [{
            label: 'Avg Response Time (hours)',
            data: responseTimes,
            borderColor: '#EF4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)'
        }]
    });
}

function renderReportCharts(data) {
    // Department wise distribution
    const departments = data.departments || {
        'Engineering': 35,
        'Marketing': 20,
        'Sales': 15,
        'HR': 10,
        'Operations': 20
    };
    
    renderPieChart('departmentChart', {
        labels: Object.keys(departments),
        data: Object.values(departments),
        colors: ['#8B5CF6', '#10B981', '#F59E0B', '#EF4444', '#3B82F6']
    });
    
    // Experience Level Distribution
    const experienceLevels = data.experience_levels || [12, 25, 18, 15];
    renderBarChart('experienceChart', {
        labels: ['0-1 years', '1-3 years', '3-5 years', '5+ years'],
        datasets: [{
            label: 'Number of Candidates',
            data: experienceLevels,
            backgroundColor: 'rgba(139, 92, 246, 0.8)'
        }]
    });
}

// Store chart instances for cleanup
const chartInstances = {};

function renderPieChart(canvasId, config) {
    console.log(`Attempting to render pie chart for ${canvasId}`);
    
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Canvas with id '${canvasId}' not found`);
        // Try to find and create the canvas if it doesn't exist
        const container = document.querySelector(`#${canvasId}`);
        if (!container) {
            console.error(`Container for ${canvasId} not found`);
            return;
        }
    }
    
    // Check if Chart.js is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js library not available');
        return;
    }
    
    // Destroy existing chart if it exists
    if (chartInstances[canvasId]) {
        try {
            chartInstances[canvasId].destroy();
        } catch (e) {
            console.warn('Error destroying existing chart:', e);
        }
    }
    
    try {
        const ctx = canvas.getContext('2d');
        console.log(`Rendering pie chart for ${canvasId} with data:`, config);
        
        chartInstances[canvasId] = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: config.labels,
                datasets: [{
                    data: config.data,
                    backgroundColor: config.colors,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
        console.log(`Successfully created pie chart for ${canvasId}`);
    } catch (error) {
        console.error(`Error creating pie chart for ${canvasId}:`, error);
    }
}

function renderBarChart(canvasId, config) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Canvas with id '${canvasId}' not found`);
        return;
    }
    
    // Destroy existing chart if it exists
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }
    
    const ctx = canvas.getContext('2d');
    console.log(`Rendering bar chart for ${canvasId} with data:`, config);
    
    chartInstances[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: config,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: config.datasets.length > 1
                }
            }
        }
    });
}

function renderLineChart(canvasId, config) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Canvas with id '${canvasId}' not found`);
        return;
    }
    
    // Destroy existing chart if it exists
    if (chartInstances[canvasId]) {
        chartInstances[canvasId].destroy();
    }
    
    const ctx = canvas.getContext('2d');
    console.log(`Rendering line chart for ${canvasId} with data:`, config);
    
    chartInstances[canvasId] = new Chart(ctx, {
        type: 'line',
        data: config,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            tension: 0.4,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: config.datasets.length > 1
                }
            }
        }
    });
}

function applyDateFilter() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (startDate && endDate) {
        showNotification(`Filtering data from ${startDate} to ${endDate}`, 'info');
        // Reload current tab with date filter
        const activeTab = document.querySelector('.tab-button.bg-blue-600');
        if (activeTab) {
            const tabName = activeTab.id.replace('Button', '');
            loadTabData(tabName);
        }
    }
}

function exportAnalytics(format) {
    showNotification(`Exporting analytics in ${format.toUpperCase()} format...`, 'info');
    // Implement export functionality
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-semibold z-50 transform transition-all duration-300 ${
        type === 'error' ? 'bg-red-500' : 
        type === 'success' ? 'bg-green-500' : 
        'bg-blue-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

</script>

<!-- Data Visualization Modal -->
<div id="dataVisualizationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl max-h-screen flex flex-col transform transition-all duration-300">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center mr-4">
                        <i class="fas fa-chart-line text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">Recruiter Data Analytics</h2>
                        <p class="text-purple-100">Comprehensive recruitment insights & trends</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Date Filter -->
                    <div class="flex items-center space-x-2 bg-white bg-opacity-20 rounded-lg p-2">
                        <i class="fas fa-calendar text-sm"></i>
                        <input type="date" id="startDate" class="bg-transparent text-white placeholder-purple-200 text-sm border-none outline-none">
                        <span class="text-purple-200">to</span>
                        <input type="date" id="endDate" class="bg-transparent text-white placeholder-purple-200 text-sm border-none outline-none">
                        <button onclick="applyDateFilter()" class="bg-white text-purple-600 px-3 py-1 rounded text-sm font-semibold hover:bg-purple-100">
                            Filter
                        </button>
                    </div>
                    <!-- Export Options -->
                    <div class="flex items-center space-x-2">
                        <button onclick="exportAnalytics('pdf')" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 rounded-lg text-sm font-semibold transition-all">
                            <i class="fas fa-file-pdf mr-1"></i>PDF
                        </button>
                        <button onclick="exportAnalytics('excel')" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-3 py-2 rounded-lg text-sm font-semibold transition-all">
                            <i class="fas fa-file-excel mr-1"></i>Excel
                        </button>
                    </div>
                    <button onclick="closeDataVisualization()" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-lg transition-all">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-gray-50 border-b border-gray-200 px-6">
            <nav class="flex space-x-8">
                <button id="overviewButton" onclick="switchAnalyticsTab('overview')" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm bg-blue-600 text-white border-blue-600">
                    <i class="fas fa-tachometer-alt mr-2"></i>Overview
                </button>
                <button id="trendsButton" onclick="switchAnalyticsTab('trends')" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm bg-gray-200 text-gray-700">
                    <i class="fas fa-chart-line mr-2"></i>Trends
                </button>
                <button id="performanceButton" onclick="switchAnalyticsTab('performance')" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm bg-gray-200 text-gray-700">
                    <i class="fas fa-users mr-2"></i>Performance
                </button>
                <button id="reportsButton" onclick="switchAnalyticsTab('reports')" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm bg-gray-200 text-gray-700">
                    <i class="fas fa-file-chart-pie mr-2"></i>Reports
                </button>
            </nav>
        </div>

        <!-- Modal Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Overview Tab -->
            <div id="overviewTab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Status Distribution -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-pie-chart text-blue-500 mr-2"></i>
                            Candidate Status Distribution
                        </h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Monthly Trends -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-chart-bar text-green-500 mr-2"></i>
                            Monthly Candidate Addition
                        </h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Key Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100">Total Candidates</p>
                                <p class="text-3xl font-bold" id="totalCandidatesMetric">{{ all_candidates|length }}</p>
                            </div>
                            <i class="fas fa-users text-3xl text-blue-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100">Selected</p>
                                <p class="text-3xl font-bold" id="selectedMetric">15</p>
                            </div>
                            <i class="fas fa-check-circle text-3xl text-green-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-100">Pending</p>
                                <p class="text-3xl font-bold" id="pendingMetric">12</p>
                            </div>
                            <i class="fas fa-clock text-3xl text-yellow-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100">Success Rate</p>
                                <p class="text-3xl font-bold" id="successRateMetric">68%</p>
                            </div>
                            <i class="fas fa-trophy text-3xl text-purple-200"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trends Tab -->
            <div id="trendsTab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Application Trends -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-chart-line text-purple-500 mr-2"></i>
                            Application & Selection Trends
                        </h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Success Rate Trends -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-percentage text-orange-500 mr-2"></i>
                            Success Rate Trends
                        </h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="successChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div id="performanceTab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- HR Performance -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-user-tie text-blue-500 mr-2"></i>
                            Recruiter Team Performance
                        </h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="hrChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Response Time -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-clock text-red-500 mr-2"></i>
                            Average Response Time
                        </h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="responseChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Department Distribution -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-building text-green-500 mr-2"></i>
                            Department-wise Distribution
                        </h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="departmentChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Experience Level -->
                    <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-graduation-cap text-purple-500 mr-2"></i>
                            Experience Level Distribution
                        </h3>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="experienceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %} 