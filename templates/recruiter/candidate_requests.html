{% extends "base.html" %}

{% block title %}Candidate Requests - Recruiter Dashboard{% endblock %}

{% block head %}
<style>
    .request-card {
        transition: all 0.3s ease;
        animation: fadeInUp 0.6s ease-out;
    }
    
    .request-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .urgency-high {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    .urgency-medium {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
    }

    .urgency-low {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .urgency-critical {
        background: linear-gradient(135deg, #7c2d12, #991b1b);
        color: white;
    }

    .manager-tag {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-lg p-6 fade-in">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Candidate Requests Overview</h1>
                <p class="text-gray-600">View all candidate requests from managers across the organization</p>
            </div>
            <a href="{{ url_for('recruiter.dashboard') }}" 
               class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl shadow-lg p-6 request-card">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-blue-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-clipboard-list text-2xl text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-600 mb-2">Total Requested</p>
                    <p class="text-3xl font-bold text-gray-900">{{ total_requested }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 request-card">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-green-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-user-check text-2xl text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-600 mb-2">Remaining</p>
                    <p class="text-3xl font-bold text-gray-900">{{ total_remaining }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 request-card">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-gradient-to-r from-orange-500 to-orange-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-user-clock text-2xl text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-600 mb-2">Assigned</p>
                    <p class="text-3xl font-bold text-gray-900">{{ total_assigned }}</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 request-card">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-purple-700 rounded-full flex items-center justify-center mr-4 shadow-lg">
                    <i class="fas fa-check-circle text-2xl text-white"></i>
                </div>
                <div>
                    <p class="text-sm font-semibold text-gray-600 mb-2">Onboarded</p>
                    <p class="text-3xl font-bold text-gray-900">{{ total_onboarded }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Search -->
    <div class="bg-white rounded-xl shadow-lg p-6 request-card">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
            <div>
                <h2 class="text-xl font-semibold text-gray-900">All Manager Requests</h2>
                <p class="text-gray-600">Filter and search through candidate requests</p>
            </div>
            <div class="flex space-x-3">
                <select id="urgencyFilter" onchange="filterRequests()" 
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Urgency Levels</option>
                    <option value="Critical">Critical</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
                <select id="managerFilter" onchange="filterRequests()" 
                        class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Managers</option>
                    {% for email in manager_emails %}
                        <option value="{{ email }}">{{ email }}</option>
                    {% endfor %}
                </select>
                <input type="text" id="searchFilter" placeholder="Search positions..." 
                       onkeyup="filterRequests()"
                       class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
    </div>

    <!-- Requests List -->
    <div class="bg-white rounded-xl shadow-lg p-6 request-card">
        {% if requests %}
        <div class="space-y-4" id="requestsList">
            {% for request in requests %}
            <div class="border border-gray-200 rounded-lg p-6 hover:bg-gray-50 transition-colors request-item" 
                 data-urgency="{{ request.urgency_level }}" 
                 data-manager="{{ request.manager_email }}"
                 data-position="{{ request.position_title|lower }}">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-briefcase text-white"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">{{ request.get('job_title', request.position_title) }}</h3>
                            <div class="flex items-center space-x-2 mt-1">
                                <span class="px-2 py-1 rounded-full text-xs font-medium manager-tag">
                                    {{ request.get('requester_name', request.manager_email) }}
                                </span>
                                <span class="text-sm text-gray-600">Requested on {{ request.get('requested_date_formatted', request.created_at[:10]) }}</span>
                                {% if request.get('days_since_request') is defined %}
                                <div class="flex items-center space-x-1">
                                    <span class="inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold {{ 'bg-red-100 text-red-800' if request.days_since_request > 15 else 'bg-yellow-100 text-yellow-800' if request.days_since_request > 7 else 'bg-green-100 text-green-800' }}">
                                        {{ request.days_since_request }}
                                    </span>
                                    <span class="text-xs {{ 'text-red-600' if request.days_since_request > 15 else 'text-yellow-600' if request.days_since_request > 7 else 'text-green-600' }}">
                                        days ago
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="px-3 py-1 rounded-full text-sm font-medium 
                            {% if request.urgency_level == 'Critical' %}urgency-critical
                            {% elif request.urgency_level == 'High' %}urgency-high
                            {% elif request.urgency_level == 'Medium' %}urgency-medium
                            {% else %}urgency-low{% endif %}">
                            {{ request.urgency_level }}
                        </span>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div class="text-center">
                        <p class="text-sm font-medium text-gray-600">Quantity Needed</p>
                        <p class="text-2xl font-bold text-blue-600">{{ request.get('open_positions', request.quantity_needed) }}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm font-medium text-gray-600">Assigned</p>
                        <p class="text-2xl font-bold text-green-600">{{ request.assigned_count }}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm font-medium text-gray-600">Onboarded</p>
                        <p class="text-2xl font-bold text-purple-600">{{ request.onboarded_count }}</p>
                    </div>
                    <div class="text-center">
                        <p class="text-sm font-medium text-gray-600">Remaining</p>
                        <p class="text-2xl font-bold text-orange-600">{{ request.get('remaining_positions', request.get('remaining_count', request.get('open_positions', request.quantity_needed) - request.onboarded_count)) }}</p>
                    </div>
                </div>
                
                {% if request.required_skills %}
                <div class="mb-3">
                    <p class="text-sm font-medium text-gray-700 mb-1">Required Skills:</p>
                    <p class="text-sm text-gray-600">{{ request.required_skills }}</p>
                </div>
                {% endif %}
                
                {% if request.additional_notes %}
                <div class="mb-3">
                    <p class="text-sm font-medium text-gray-700 mb-1">Additional Notes:</p>
                    <p class="text-sm text-gray-600">{{ request.additional_notes }}</p>
                </div>
                {% endif %}
                
                <div class="flex items-center justify-between pt-3 border-t border-gray-200">
                    <p class="text-xs text-gray-500">
                        Last updated: {{ request.updated_at[:10] }}
                    </p>
                    <div class="flex space-x-2">
                        <button onclick="viewManagerDetails('{{ request.manager_email }}')" 
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            <i class="fas fa-user mr-1"></i>View Manager
                        </button>
                        <button onclick="assignCandidate('{{ request._id }}')" 
                                class="text-green-600 hover:text-green-800 text-sm font-medium">
                            <i class="fas fa-user-plus mr-1"></i>Assign Candidate
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-clipboard-list text-3xl text-gray-400"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No requests found</h3>
            <p class="text-gray-600">Managers haven't submitted any candidate requests yet.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Assign Candidate Modal -->
<div id="assignCandidateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Assign Candidate to Request</h2>
                    <button onclick="closeAssignModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- Step 1: Candidate Selection -->
                <div id="candidateSelection">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Select a Candidate to Assign</h3>
                    <div id="pendingCandidatesList" class="space-y-3">
                        <!-- Candidates will be loaded here -->
                    </div>
                </div>
                
                <!-- Step 2: Assignment Form -->
                <div id="assignmentForm" style="display: none;">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Complete Assignment</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Selected Candidate</label>
                            <p id="selectedCandidateName" class="text-lg font-semibold text-blue-600"></p>
                        </div>
                        
                        <div>
                            <label for="managerEmail" class="block text-sm font-medium text-gray-700 mb-2">Manager Email *</label>
                            <input type="email" id="managerEmail" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="Enter manager email">
                        </div>
                        
                        <div>
                            <label for="interviewTime" class="block text-sm font-medium text-gray-700 mb-2">Interview Time (Optional)</label>
                            <input type="datetime-local" id="interviewTime"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-blue-500 mr-3"></i>
                                <p class="text-sm text-blue-700">
                                    This candidate will be assigned to the selected manager. The request counts will be automatically updated.
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3">
                            <button onclick="closeAssignModal()" 
                                    class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                Cancel
                            </button>
                            <button onclick="submitAssignment()" 
                                    class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium">
                                <i class="fas fa-check mr-2"></i>Complete Assignment
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden inputs -->
                <input type="hidden" id="selectedCandidateId">
            </div>
        </div>
    </div>
</div>

<script>
function filterRequests() {
    const urgencyFilter = document.getElementById('urgencyFilter').value;
    const managerFilter = document.getElementById('managerFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    const requests = document.querySelectorAll('.request-item');
    
    requests.forEach(request => {
        const urgency = request.dataset.urgency;
        const manager = request.dataset.manager;
        const position = request.dataset.position;
        
        let show = true;
        
        // Urgency filter
        if (urgencyFilter && urgency !== urgencyFilter) {
            show = false;
        }
        
        // Manager filter
        if (managerFilter && manager !== managerFilter) {
            show = false;
        }
        
        // Search filter
        if (searchFilter && !position.includes(searchFilter)) {
            show = false;
        }
        
        request.style.display = show ? 'block' : 'none';
    });
}

function viewManagerDetails(managerEmail) {
    // TODO: Implement manager details view
    alert(`Viewing details for manager: ${managerEmail}`);
}

function assignCandidate(requestId) {
    // Store the request ID for the assignment
    window.currentRequestId = requestId;
    
    // Show the assign candidate modal
    document.getElementById('assignCandidateModal').style.display = 'flex';
    
    // Load pending candidates for this request
    loadPendingCandidates(requestId);
}

function loadPendingCandidates(requestId) {
    // Fetch pending candidates that can be assigned
    fetch('/recruiter/get-pending-candidates')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPendingCandidates(data.candidates);
            } else {
                console.error('Error loading candidates:', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function displayPendingCandidates(candidates) {
    const container = document.getElementById('pendingCandidatesList');
    
    if (candidates.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">No pending candidates available for assignment</div>';
        return;
    }
    
    let html = '';
    candidates.forEach(candidate => {
        html += `
            <div class="border border-gray-200 rounded-lg p-4 mb-3 hover:bg-gray-50">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold text-gray-900">${candidate.name || 'Name not available'}</h4>
                        <p class="text-sm text-gray-600">${candidate.email || 'Email not available'}</p>
                        <p class="text-sm text-gray-500">${candidate.position_applied || 'Position not specified'}</p>
                    </div>
                    <button onclick="selectCandidateForAssignment('${candidate._id}', '${candidate.name || 'Unknown'}')" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                        <i class="fas fa-user-plus mr-1"></i>Select
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function selectCandidateForAssignment(candidateId, candidateName) {
    // Store selected candidate info
    document.getElementById('selectedCandidateId').value = candidateId;
    document.getElementById('selectedCandidateName').textContent = candidateName;
    
    // Show the assignment form
    document.getElementById('candidateSelection').style.display = 'none';
    document.getElementById('assignmentForm').style.display = 'block';
}

function submitAssignment() {
    const candidateId = document.getElementById('selectedCandidateId').value;
    const managerEmail = document.getElementById('managerEmail').value;
    const interviewTime = document.getElementById('interviewTime').value;
    const requestId = window.currentRequestId;
    
    if (!candidateId || !managerEmail) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Create form data
    const formData = new FormData();
    formData.append('candidate_id', candidateId);
    formData.append('manager_email', managerEmail);
    formData.append('request_id', requestId);
    if (interviewTime) {
        formData.append('interview_time', interviewTime);
    }
    
    // Show loading state
    const submitButton = document.querySelector('button[onclick="submitAssignment()"]');
    const originalText = submitButton.innerHTML;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Assigning...';
    submitButton.disabled = true;
    
    // Submit assignment
    fetch('/recruiter/assign_candidate', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Candidate assigned successfully!');
            closeAssignModal();
            // Refresh the page to show updated counts
            location.reload();
        } else {
            alert('Error: ' + data.message);
            // Reset button state
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error assigning candidate');
        // Reset button state
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    });
}

function closeAssignModal() {
    document.getElementById('assignCandidateModal').style.display = 'none';
    // Reset form fields manually since assignmentForm is a div, not a form
    document.getElementById('managerEmail').value = '';
    document.getElementById('interviewTime').value = '';
    document.getElementById('selectedCandidateId').value = '';
    document.getElementById('selectedCandidateName').textContent = '';
    
    // Reset display states
    document.getElementById('candidateSelection').style.display = 'block';
    document.getElementById('assignmentForm').style.display = 'none';
}
</script>
{% endblock %}
